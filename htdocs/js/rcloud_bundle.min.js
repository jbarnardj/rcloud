RCloud=Object.assign({version:"2.2.2"},RCloud),RCloud.is_exception=function(e){return _.isObject(e)&&e.r_attributes&&"OCAP-eval-error"===e.r_attributes.class},RCloud.exception_message=function(e){if(!RCloud.is_exception(e))throw new Error("Not an R exception value");var t=e.traceback?e.traceback:"";return t.join&&(t=t.join("\n")),e.error+"R trace:\n"+t},RCloud.promisify_paths=function(){return function(e,t,o){var n=o?"":"Async";return _.each(t,function(t){var o=function(t){for(var o=e,n=0;n<t.length;++n)o=o[t[n]];return o}(t);!function(t,o){for(var r=e,i=0;i<t.length-1;++i)r=r[t[i]];r[t[t.length-1]+n]=o}(t,o?function(e,t){function o(t){if(t&&RCloud.is_exception(t))throw new Error(e+": "+RCloud.exception_message(t));return t}return function(){return t.apply(this,arguments).then(o)}}(t.join("."),Promise.promisify(o)):null)}),e}}(),RCloud.create=function(rcloud_ocaps){function rcloud_github_handler(e,t){return t.then(function(t){if(t.ok)return t.content;var o;throw o=t.content&&t.content.message?t.content.message+" ("+t.code+")":"error code "+t.code,new Error(e+": "+o)})}var rcloud={};function setup_unauthenticated_ocaps(){var paths=[["version_info"],["anonymous_session_init"],["anonymous_compute_init"],["has_compute_separation"],["signal_to_compute"],["prefix_uuid"],["get_conf_value"],["get_conf_values"],["get_gist_sources"],["get_notebook"],["load_notebook"],["load_notebook_compute"],["call_notebook"],["install_notebook_stylesheets"],["get_version_by_tag"],["get_tag_by_version"],["get_users"],["log","record_cell_execution"],["setup_js_installer"],["replace_token"],["comments","get_all"],["help"],["debug","raise"],["stars","star_notebook"],["stars","unstar_notebook"],["stars","is_notebook_starred"],["stars","get_notebook_star_count"],["stars","get_notebook_starrer_list"],["stars","get_multiple_notebook_star_counts"],["stars","get_my_starred_notebooks"],["discovery","get_notebooks"],["discovery","get_thumb"],["session_cell_eval"],["reset_session"],["set_device_pixel_ratio"],["api","enable_echo"],["api","disable_echo"],["api","enable_warnings"],["api","disable_warnings"],["api","set_url"],["api","get_url"],["notebook_by_name"],["get_notebook_info"],["get_multiple_notebook_infos"],["languages","get_list"],["plots","render"],["plots","get_formats"],["get_fork_count"],["get_multiple_fork_counts"]],cached_device_pixel_ratio;RCloud.promisify_paths(rcloud_ocaps,paths),rcloud.get_fork_count=rcloud_ocaps.get_fork_countAsync,rcloud.get_multiple_fork_counts=rcloud_ocaps.get_multiple_fork_countsAsync,rcloud.username=function(){return $.cookies.get("user")},rcloud.github_token=function(){return $.cookies.get("token")},rcloud.version_info=function(){return rcloud_ocaps.version_infoAsync.apply(null,arguments)},rcloud.anonymous_session_init=function(){return rcloud_ocaps.anonymous_session_initAsync()},rcloud.anonymous_compute_init=function(){return rcloud_ocaps.anonymous_compute_initAsync()},rcloud.init_client_side_data=function(){var e=this;return Promise.all([rcloud_ocaps.prefix_uuidAsync(),rcloud_ocaps.has_compute_separationAsync()]).spread(function(t,o){e.deferred_knitr_uuid=t,e.has_compute_separation=o})},rcloud.signal_to_compute=function(e){return rcloud_ocaps.signal_to_computeAsync(e)},rcloud.get_conf_value=function(e,t){return rcloud_ocaps.get_conf_valueAsync(e,t)},rcloud.get_conf_values=function(e){return rcloud_ocaps.get_conf_valuesAsync(e)},rcloud.get_gist_sources=function(){return rcloud_ocaps.get_gist_sourcesAsync()},rcloud.get_notebook=function(e,t,o,n){return void 0===o&&(o=null),void 0===n&&(n=!1),rcloud_github_handler("rcloud.get.notebook "+e,rcloud_ocaps.get_notebookAsync(e,t,o,n))},rcloud.load_notebook=function(e,t){return Promise.all([rcloud_github_handler("rcloud.load.notebook.compute "+e,rcloud_ocaps.load_notebook_computeAsync(e,t)),rcloud_github_handler("rcloud.load.notebook "+e,rcloud_ocaps.load_notebookAsync(e,t))]).spread(function(e,t){return t})},rcloud.refresh_compute_notebook=function(e){return rcloud_github_handler("rcloud.load.notebook.compute (refresh) "+e,rcloud_ocaps.load_notebook_computeAsync(e,null,null,!1))},rcloud.get_version_by_tag=function(e,t){return rcloud_ocaps.get_version_by_tagAsync(e,t)},rcloud.get_tag_by_version=function(e,t){return rcloud_ocaps.get_tag_by_versionAsync(e,t)},rcloud.call_notebook=function(e,t){return rcloud_github_handler("rcloud.call.notebook "+e,rcloud_ocaps.call_notebookAsync(e,t))},rcloud.call_notebook_unchecked=function(e,t){return rcloud_ocaps.call_notebookAsync(e,t)},rcloud.install_notebook_stylesheets=function(){return rcloud_ocaps.install_notebook_stylesheetsAsync()},rcloud.help=function(e){return rcloud_ocaps.helpAsync(e).then(function(t){t||RCloud.UI.help_frame.display_content("<h2>No help found for <em>"+e+"</em></h2>")})},rcloud.get_users=function(){return rcloud_ocaps.get_usersAsync()},rcloud.record_cell_execution=function(e){return rcloud_ocaps.log.record_cell_executionAsync(rcloud.username(),e)},rcloud.setup_js_installer=function(e){return rcloud_ocaps.setup_js_installerAsync(e)},rcloud.modules={},rcloud.setup_js_installer({install_js:function(name,content,k){try{var result=eval(content);rcloud.modules[name]=result,k(null,result)}catch(e){Promise.reject(e);var v={type:e.name,message:e.message};k(v,null)}},clear_css:function(e,t){$(".rcloud-user-defined-css").remove(),t(null,null)},install_css:function(e,t){_.isString(e)?e=[e]:_.isArray(e)||(e=[]),_.each(e,function(e){$("head").append($('<link type="text/css" rel="stylesheet" class="rcloud-user-defined-css" href="'+e+'"/>'))}),t(null,null)}}),rcloud.replace_token=function(e,t){return rcloud_ocaps.replace_tokenAsync(e,t)},rcloud.get_all_comments=function(e){return rcloud_ocaps.comments.get_allAsync(e)},rcloud.debug={},rcloud.debug.raise=function(e){return rcloud_ocaps.debug.raiseAsync(e)},rcloud.stars={},rcloud.stars.is_notebook_starred=function(e){return rcloud_ocaps.stars.is_notebook_starredAsync(e)},rcloud.stars.get_notebook_star_count=function(e){return rcloud_ocaps.stars.get_notebook_star_countAsync(e)},rcloud.stars.get_notebook_starrer_list=function(e){return rcloud_ocaps.stars.get_notebook_starrer_listAsync(e)},rcloud.stars.get_multiple_notebook_star_counts=function(e){return rcloud_ocaps.stars.get_multiple_notebook_star_countsAsync(e)},rcloud.discovery={get_notebooks:rcloud_ocaps.discovery.get_notebooksAsync,get_thumb:rcloud_ocaps.discovery.get_thumbAsync},rcloud.session_cell_eval=function(e,t,o,n,r){return rcloud_ocaps.session_cell_evalAsync(e,t,o,n,r)},rcloud.reset_session=function(){return rcloud_ocaps.reset_sessionAsync()},rcloud.display={},rcloud.display.set_device_pixel_ratio=function(){return cached_device_pixel_ratio=window.devicePixelRatio,rcloud_ocaps.set_device_pixel_ratioAsync(window.devicePixelRatio)},rcloud.display.get_device_pixel_ratio=function(){return cached_device_pixel_ratio},rcloud.get_notebook_by_name=function(e,t){return rcloud_ocaps.notebook_by_nameAsync(e,t)},rcloud.get_notebook_info=rcloud_ocaps.get_notebook_infoAsync,rcloud.get_multiple_notebook_infos=rcloud_ocaps.get_multiple_notebook_infosAsync,rcloud.api={},rcloud.api.disable_warnings=function(){return rcloud_ocaps.api.disable_warningsAsync()},rcloud.api.enable_warnings=function(){return rcloud_ocaps.api.enable_warningsAsync()},rcloud.api.disable_echo=function(){return rcloud_ocaps.api.disable_echoAsync()},rcloud.api.enable_echo=function(){return rcloud_ocaps.api.enable_echoAsync()},rcloud.api.set_url=function(e){return rcloud_ocaps.api.set_urlAsync(e)},rcloud.api.get_url=function(){return rcloud_ocaps.api.get_urlAsync()},rcloud.languages={},rcloud.languages.get_list=function(){return rcloud_ocaps.languages.get_listAsync()},rcloud.plots={},rcloud.plots.render=function(e,t,o){return rcloud_ocaps.plots.renderAsync(e,t,o)},rcloud.plots.get_formats=function(){return rcloud_ocaps.plots.get_formatsAsync()}}function setup_authenticated_ocaps(){RCloud.promisify_paths(rcloud_ocaps,[["session_init"],["compute_init"],["search"],["search_description"],["update_notebook"],["create_notebook"],["fork_notebook"],["port_notebooks"],["purl_source"],["get_completions"],["rename_notebook"],["authenticated_cell_eval"],["session_markdown_eval"],["notebook_upload"],["tag_notebook_version"],["file_upload","upload_path"],["file_upload","create"],["file_upload","write"],["file_upload","close"],["comments","post"],["comments","modify"],["comments","delete"],["is_notebook_published"],["publish_notebook"],["unpublish_notebook"],["set_notebook_visibility"],["protection","get_notebook_cryptgroup"],["protection","set_notebook_cryptgroup"],["protection","get_cryptgroup_users"],["protection","get_user_cryptgroups"],["protection","create_cryptgroup"],["protection","set_cryptgroup_name"],["protection","add_cryptgroup_user"],["protection","remove_cryptgroup_user"],["protection","delete_cryptgroup"],["protection","has_notebook_protection"],["api","disable_warnings"],["api","enable_echo"],["api","disable_warnings"],["api","enable_echo"],["config","all_notebooks"],["config","all_user_notebooks"],["config","all_notebooks_multiple_users"],["config","get_all_notebook_info"],["config","add_notebook"],["config","remove_notebook"],["config","get_current_notebook"],["config","set_current_notebook"],["config","new_notebook_number"],["config","get_recent_notebooks"],["config","set_recent_notebook"],["config","clear_recent_notebook"],["config","get_user_option"],["config","set_user_option"],["config","get_alluser_option"],["set_notebook_info"],["get_notebook_property"],["set_notebook_property"],["remove_notebook_property"]]),rcloud.session_init=function(e,t){return rcloud_ocaps.session_initAsync(e,t)},rcloud.compute_init=function(e,t){return rcloud_ocaps.compute_initAsync(e,t)},rcloud.update_notebook=function(e,t,o){return void 0===o&&(o=!0),rcloud_github_handler("rcloud.update.notebook",rcloud_ocaps.update_notebookAsync(e,t,o))},rcloud.search=rcloud_ocaps.searchAsync,rcloud.search_description=rcloud_ocaps.search_descriptionAsync,rcloud.create_notebook=function(e,t){return void 0===t&&(t=!0),rcloud_github_handler("rcloud.create.notebook",rcloud_ocaps.create_notebookAsync(e,t)).then(function(e){return t&&rcloud_ocaps.load_notebook_computeAsync(e.id),e})},rcloud.fork_notebook=function(e){return rcloud_github_handler("rcloud.fork.notebook",rcloud_ocaps.fork_notebookAsync(e))},rcloud.port_notebooks=function(e,t,o){return rcloud_ocaps.port_notebooksAsync(e,t,o)},rcloud.purl_source=function(e){return rcloud_ocaps.purl_sourceAsync(e)},rcloud.get_completions=function(e,t,o){return rcloud_ocaps.get_completionsAsync(e,t,o).then(function(e){return e.values?(_.isString(e.values)&&(e.values=[e.values]),_.map(e.values,function(t){return{meta:"local",name:"library",score:3,position:e.position,prefix:e.prefix,value:t}})):(_.isString(e)&&(e=[e]),_.map(e,function(e){return{meta:"local",name:"library",score:3,value:e}}))})},rcloud.rename_notebook=function(e,t){return rcloud_github_handler("rcloud.rename.notebook",rcloud_ocaps.rename_notebookAsync(e,t))},rcloud.authenticated_cell_eval=function(e,t,o,n,r){return rcloud_ocaps.authenticated_cell_evalAsync(e,t,o,n,r)},rcloud.notebook_upload=function(e,t){return rcloud_github_handler("rcloud.upload.to.notebook",rcloud_ocaps.notebook_uploadAsync(e,t))},rcloud.tag_notebook_version=function(e,t,o){return rcloud_ocaps.tag_notebook_versionAsync(e,t,o)},rcloud.post_comment=function(e,t){return rcloud_github_handler("rcloud.post.comment",rcloud_ocaps.comments.postAsync(e,t))},rcloud.modify_comment=function(e,t,o){return rcloud_ocaps.comments.modifyAsync(e,t,o)},rcloud.delete_comment=function(e,t){return rcloud_ocaps.comments.deleteAsync(e,t)},rcloud.is_notebook_published=function(e){return rcloud_ocaps.is_notebook_publishedAsync(e)},rcloud.publish_notebook=function(e){return rcloud_ocaps.publish_notebookAsync(e)},rcloud.unpublish_notebook=function(e){return rcloud_ocaps.unpublish_notebookAsync(e)},rcloud.set_notebook_visibility=function(e,t){return rcloud_ocaps.set_notebook_visibilityAsync(e,t)},rcloud.protection={},rcloud.protection.get_notebook_cryptgroup=function(e){return rcloud_ocaps.protection.get_notebook_cryptgroupAsync(e)},rcloud.protection.set_notebook_cryptgroup=function(e,t,o){return void 0===o&&(o=!0),rcloud_ocaps.protection.set_notebook_cryptgroupAsync(e,t,o)},rcloud.protection.get_cryptgroup_users=function(e){return rcloud_ocaps.protection.get_cryptgroup_usersAsync(e)},rcloud.protection.get_user_cryptgroups=function(e){return rcloud_ocaps.protection.get_user_cryptgroupsAsync(e)},rcloud.protection.create_cryptgroup=function(e){return rcloud_ocaps.protection.create_cryptgroupAsync(e)},rcloud.protection.set_cryptgroup_name=function(e,t){return rcloud_ocaps.protection.set_cryptgroup_nameAsync(e,t)},rcloud.protection.add_cryptgroup_user=function(e,t,o){return rcloud_ocaps.protection.add_cryptgroup_userAsync(e,t,o)},rcloud.protection.remove_cryptgroup_user=function(e,t){return rcloud_ocaps.protection.remove_cryptgroup_userAsync(e,t)},rcloud.protection.delete_cryptgroup=function(e){return rcloud_ocaps.protection.delete_cryptgroupAsync(e)},rcloud.protection.has_notebook_protection=function(){return rcloud_ocaps.protection.has_notebook_protectionAsync()},rcloud.stars.star_notebook=function(e){return rcloud_ocaps.stars.star_notebookAsync(e)},rcloud.stars.unstar_notebook=function(e){return rcloud_ocaps.stars.unstar_notebookAsync(e)},rcloud.stars.get_my_starred_notebooks=function(){return rcloud_ocaps.stars.get_my_starred_notebooksAsync()},rcloud.config={all_notebooks:rcloud_ocaps.config.all_notebooksAsync,all_user_notebooks:rcloud_ocaps.config.all_user_notebooksAsync,all_notebooks_multiple_users:rcloud_ocaps.config.all_notebooks_multiple_usersAsync,get_all_notebook_info:rcloud_ocaps.config.get_all_notebook_infoAsync,add_notebook:rcloud_ocaps.config.add_notebookAsync,remove_notebook:rcloud_ocaps.config.remove_notebookAsync,get_current_notebook:rcloud_ocaps.config.get_current_notebookAsync,set_current_notebook:rcloud_ocaps.config.set_current_notebookAsync,new_notebook_number:rcloud_ocaps.config.new_notebook_numberAsync,get_recent_notebooks:rcloud_ocaps.config.get_recent_notebooksAsync,set_recent_notebook:rcloud_ocaps.config.set_recent_notebookAsync,clear_recent_notebook:rcloud_ocaps.config.clear_recent_notebookAsync,get_user_option:rcloud_ocaps.config.get_user_optionAsync,set_user_option:rcloud_ocaps.config.set_user_optionAsync,get_alluser_option:rcloud_ocaps.config.get_alluser_optionAsync},rcloud.set_notebook_info=function(e,t){return t.username?t.description?t.last_commit?rcloud_ocaps.set_notebook_infoAsync(e,t):Promise.reject(new Error("attempt to set info no last_commit")):Promise.reject(new Error("attempt to set info no description")):Promise.reject(new Error("attempt to set info no username"))},rcloud.get_notebook_property=rcloud_ocaps.get_notebook_propertyAsync,rcloud.set_notebook_property=rcloud_ocaps.set_notebook_propertyAsync,rcloud.remove_notebook_property=rcloud_ocaps.remove_notebook_propertyAsync}return rcloud._ocaps=rcloud_ocaps,rcloud.authenticated=rcloud_ocaps.authenticated,setup_unauthenticated_ocaps(),rcloud.authenticated&&setup_authenticated_ocaps(),rcloud},RClient={create:function(e){function t(){l||$("#input-div").hide(),s.closed||s.close()}function o(o,n){e.debug,e.on_error&&e.on_error(o,n)||t()}e=_.defaults(e,{debug:!1});var n,r=$.cookies.get().token,i=$.cookies.get().execToken,s=Rserve.create({host:e.host,on_connect:function(){if(!s.ocap_mode)return RCloud.UI.session_pane.post_error(ui_utils.disconnection_error("Expected an object-capability Rserve. Shutting Down!")),void t();var l=e.mode?e.mode:"client";s.ocap([r,i],l,RCloud.version,function(t,r){t?o(t[0],t[1]):(r=Promise.promisifyAll(r),console.log("Connected to rcloud host",r.rcloud.hostname[0]),null===r?o("Login failed. Shutting down!"):RCloud.is_exception(r)?o(r):(n.running=!0,e.on_connect&&e.on_connect.call(n,r)))})},on_error:o,on_close:function(o){e.debug,l||(window.rcloud?rcloud.username()?RCloud.UI.fatal_dialog("Your session has been logged out.","Reconnect",ui_utils.relogin_uri()):RCloud.UI.fatal_dialog("Your session closed unexpectedly.","Reload",window.location.href):RCloud.UI.fatal_dialog("Could not connect to server.","Retry",window.location.href),t())},on_data:e.on_data,on_oob_message:e.on_oob_message}),l=!1;return n={_rserve:s,host:e.host,running:!1,post_response:function(e){var t=d3.select("#output").selectAll("pre.response").data([e]);t.exit().remove(),t.enter().append("pre").attr("class","response"),t.html(e=>e)},post_rejection:function(e){throw RCloud.UI.session_pane.post_error(e.message),e},close:function(){l=!0,t()}}}};var url_utils={getQueryParams:function(){return function(e){if(""==e)return{};let t={};for(let o=0;o<e.length;++o){let n=e[o].split("=",2);1==n.length?t[n[0]]="":t[n[0]]=decodeURIComponent(n[1].replace(/\+/g," "))}return t}(window.location.search.substr(1).split("&"))},updateHistory:function(e,t){let o=this.getBase(),n=this.getPathSegments(),r=this.generateUrlString(o,n,e),i=history.state;return t||window.history.pushState(null,null,r),_.isEqual(t,i)?window.history.replaceState(t,null,r):window.history.pushState(t,null,r),t},generateUrlString:function(e,t,o){let n="";t=t||[],o=o||{},!e.endsWith("/")&&t&&t.length>0&&(n="/");let r=[];for(let e in o)void 0!==o[e]&&null!==o[e]&&r.push(e+"="+encodeURIComponent(o[e]));return e+n+_.filter(t,e=>""!==e).join("/")+"?"+r.join("&")},getBase:function(){return window.location.protocol+"//"+window.location.host},getPathSegments:function(){return _.filter(window.location.pathname.split("/"),e=>""!==e)}},ui_utils={make_url:function(e,t){t=t||{};var o=url_utils.getQueryParams();let n=[e];var r=url_utils.getBase();if(t.notebook&&t.notebook!==o.notebook?o={}:t.new_notebook?o={}:(delete o.notebook,delete o.version,delete o.tag),t.do_path)return t.notebook&&(n.push(t.notebook),t.version&&n.push(t.version)),url_utils.generateUrlString(r,n,{});{let e={};t.notebook?(e.notebook=t.notebook,t.source&&(e.source=t.source),t.tag?e.tag=t.tag:t.version&&(e.version=t.version)):t.new_notebook&&(e.new_notebook=!0);let i=Object.assign(e,o);return url_utils.generateUrlString(r,n,i)}},relogin_uri:function(e){return e=e||window.location.pathname+window.location.search,window.location.protocol+"//"+window.location.host+"/login.R?redirect="+encodeURIComponent(e)},disconnection_error:function(e,t){var o=$("<div class='alert alert-danger'></div>");o.append($("<span></span>").text(e)),t=t||"Reconnect";var n=$("<button type='button' class='close'>"+t+"</button>");return o.append(n),n.click(function(){window.location=ui_utils.relogin_uri()}),o},string_error:function(e){var t=$("<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>"),o=$("<div class='alert alert-danger alert-dismissable'></div>");return o.append(t),o.append(ui_utils.expandable_error(e)),o},expandable_error:function(e){var t,o=$("<div></div>"),n=e.indexOf("R trace:"),r=e;if(-1!==n){o.append($("<div></div>").text(e.slice(0,n))),e=e.slice(n),t=$("<div style='display: none'></div>");var i=!1,s=$("<div style='padding-left: 1em'></div>");s.append($("<a class='error-link'>expand</a>").click(function(){i=!i,t.toggle(i),$(this).text(i?"collapse":"expand"),RCloud.UI.right_panel.collapse($("#collapse-session-info"),!1,!1)})),o.append(s),o.append(t),window.rcloud&&rcloud.get_conf_value("support.email").then(function(e){if(e){var t=$("<a class='error-link'>email error</a>");t.attr("href","mailto:"+e+"?subject="+encodeURIComponent("RCloud error")+"&body="+encodeURIComponent(r)),s.append("&emsp;&emsp;",t)}})}else t=o;var l=_.map(e.split("\n"),function(e){var t,o=$("<div></div>").text(e);if(t=e.match(/^( {4})+/)){var n=t[0].length/4;o.css("left",n+"em"),o.css("position","relative")}return o});return t.append(l),o},fa_button:function(e,t,o,n,r){var i=$.el.i({class:e}),s=$.el.span({class:"fontawesome-button "+(o||"")},i);if(n)for(var l in n)i.style[l]=n[l];var a={title:t,delay:{show:250,hide:0}};return r||(a.container="body"),$(s).tooltip(a)},enable_fa_button:function(e){e.removeClass("button-disabled")},disable_fa_button:function(e){e.addClass("button-disabled")},enable_bs_button:function(e){e.removeClass("disabled")},disable_bs_button:function(e){e.addClass("disabled")},ace_editor_height:function(e,t,o){return t=_.isUndefined(t)?0:t,o=_.isUndefined(o)?30:o,e.renderer.lineHeight*Math.max(t,e.getSession().getScreenLength())+e.renderer.scrollBar.getWidth()},ace_get_last:function(e){var t=e.getSession(),o=t.getLength()-1;return{row:o,column:t.getLine(o).length}},ace_set_pos:function(e,t,o){var n=e.getSelection(),r=n.getRange();r.setStart(t,o),r.setEnd(t,o),n.setSelectionRange(r)},install_common_ace_key_bindings:function(e,t){var o=ace.require("ace/autocomplete").Autocomplete,n=e.getSession(),r=e.commands.commandKeyBinding.tab;e.commands.removeCommand("gotoline"),e.commands.addCommands([{name:"another autocomplete key",bindKey:"Ctrl-.",exec:o.startCommand.exec},{name:"the autocomplete key people want",bindKey:"Tab",exec:function(e,t,n){var i=e.getSelection().getRange();e.getSession().getLine(i.start.row).substring(0,i.start.column).match(/\S/)?o.startCommand.exec(e,t,n):r.exec(e,t,n)}},{name:"execute-selection-or-line",bindKey:{win:"Ctrl-Return",mac:"Command-Return",sender:"editor"},exec:function(e,o,r){if(!e.getOption("readOnly")){var i=n.getTextRange(e.getSelectionRange());if(0===i.length){var s=e.getCursorPosition(),l=new(0,ace.require("ace/range").Range)(s.row,0,s.row+1,0);i=n.getTextRange(l),e.navigateDown(1),e.navigateLineEnd()}RCloud.UI.command_prompt.history().add_entry(i);var a=shell.new_cell(i,t());shell.scroll_to_end(),a.controller.enqueue_execution_snapshot(a.updatePromise)}}},{name:"cursor at beginning of line",ctrlACount:0,lastRow:-1,bindKey:{mac:"Ctrl-A",sender:"editor"},exec:function(e,t,o){if(!e.getOption("readOnly")){var n=e.getCursorPosition().row;this.lastRow!==n?(this.ctrlACount=1,e.navigateLineStart(),this.lastRow=n):(0===this.ctrlACount?(e.navigateLineStart(),this.ctrlACount++):1===this.ctrlACount&&(e.navigateTo(n,0),this.ctrlACount=0),this.lastRow=n)}}},{name:"cursor at end of line",bindKey:{mac:"Ctrl-E",sender:"editor"},exec:function(e,t,o){var n=e.getCursorPosition().row,r=ui_utils.last_col(e,n);e.navigateTo(n,r)}}])},last_col:function(e,t){return e.getSession().getDocument().getLine(t).length},character_offset_of_pos:function(e,t){var o=e.getSession().getDocument(),n=o.getNewLineCharacter().length,r=o.getAllLines();if(t.row>r.length)throw new Error("getting position off end of editor");var i,s=0;for(i=0;i<t.row;i++)s+=r[i].length+n;return s+=t.column},position_of_character_offset:function(e,t){var o,n=e.getSession().getDocument(),r=n.getNewLineCharacter().length,i=n.getAllLines();for(o=0;o<i.length&&!(t<=i[o].length);o++)t-=i[o].length+r;if(o===i.length)throw new Error("character offset off end of editor");return{row:o,column:t}},ace_range_of_character_range:function(e,t,o){var n=ace.require("ace/range").Range,r=ui_utils.position_of_character_offset(e,t),i=ui_utils.position_of_character_offset(e,o);return new n(r.row,r.column,i.row,i.column)},ignore_programmatic_changes:function(e,t){var o=!0;return e.on("change",function(){o&&t(e.getValue())}),function(t){o=!1;var n=t!==e.getValue()?e.setValue(t):null;return o=!0,n}},set_ace_readonly:function(e,t){e.setOptions({readOnly:t,highlightActiveLine:!t,highlightGutterLine:!t}),e.renderer.$cursorLayer.element.style.opacity=t?0:1,e.textInput.setReadOnly(t)},twostate_icon:function(e,t,o,n,r){function i(t){e[0].checked=t;var o=e.find("i");t?(o.removeClass(r),o.addClass(n)):(o.removeClass(n),o.addClass(r))}function s(){var e=!this.checked;i(e),e?t():o()}function l(t){e.off("click"),t&&e.click(s)}return l(!0),{set_state:i,enable:l}},checkbox_menu_item:function(e,t,o){var n=ui_utils.twostate_icon(e,t,o,"icon-check","icon-check-empty"),r=n.enable;return n.enable=function(t){e.parent().toggleClass("disabled",!t),r(t)},n},customize_ace_gutter:function(e,t){var o=ace.require("ace/lib/dom");e.renderer.$gutterLayer.update=function(e){for(var n=[],r=e.firstRow,i=e.lastRow,s=this.session.getNextFoldLine(r),l=(s&&s.start.row,this.$showFoldWidgets&&this.session.foldWidgets,this.session.$breakpoints,this.session.$decorations,this.session.$firstLineNumber,0);r<=i;++r){var a=t(r);n.push("<div class='ace_gutter-cell ","' style='height:",this.session.getRowLength(0)*e.lineHeight,"px;'>",a,"</div>"),l=Math.max(l,a.length)}this.element=o.setInnerHtml(this.element,n.join("")),this.element.style.height=e.minHeight+"px";var c=l*e.characterWidth,u=this.$padding||this.$computePadding();(c+=u.left+u.right)===this.gutterWidth||isNaN(c)||(this.gutterWidth=c,this.element.style.width=Math.ceil(this.gutterWidth)+"px",this._emit("changeGutterWidth",c))}},editable:function(e,t){function o(e){var t=window.getSelection();t.removeAllRanges(),t.addRange(e)}function n(t){var n=document.createRange(),r=e.get(0).firstChild;n.setStart(r,t),n.setEnd(r,t),o(n)}function r(){return window.getSelection().getRangeAt(0)}function i(){return e.data("__editable")}function s(e){return t.allow_multiline&&(e=e.replace(/\n/g,"<br/>")),e.replace(/  /g,"  ")}function l(e){return t.allow_multiline&&(e=e.replace(/<br>/g,"\n")),e.replace(/\xa0/g," ")}function a(t,o){t?e.html(o):e.text(o)}var c=i(),u=c;if(_.isObject(t)){var d;d=c?$.extend({},c):{on_change:function(){return!0},allow_edit:!0,inactive_text:e.text(),active_text:e.text(),allow_multiline:!1,select:function(e){var t=document.createRange();return t.selectNodeContents(e),t}},u=$.extend(d,t),e.data("__editable",u)}else{if("destroy"!==t&&!c)throw new Error("expected already editable for command "+t);var f=function(e,t){c=$.extend({},c),u[e]=t};switch(t){case"destroy":e.data("__editable",null),u=null;break;case"option":if(!arguments[2])return c;if(!arguments[3])return c[arguments[2]];f(arguments[2],arguments[3]);break;case"disable":f("allow_edit",!1);break;case"enable":f("allow_edit",!0)}}var h=null;switch(c&&c.allow_edit||!u||!u.allow_edit?!c||!c.allow_edit||u&&u.allow_edit||(h="freeze"):h="melt",u&&a(t.allow_multiline,s(i().__active?u.active_text:u.inactive_text)),h){case"freeze":e.removeAttr("contenteditable"),e.off("keydown.editable"),e.off("focus.editable"),e.off("click.editable"),e.off("blur.editable");break;case"melt":e.attr("contenteditable","true"),e.on({"focus.editable":function(){i().__active||(i().__active=!0,a(t.allow_multiline,s(i().active_text)),window.setTimeout(function(){o(i().select(e[0])),e.off("blur.editable"),e.on("blur.editable",function(){a(t.allow_multiline,s(i().inactive_text)),i().__active=!1})},10))},"click.editable":function(e){e.stopPropagation()},"keydown.editable":function(o){if(o.keyCode===$.ui.keyCode.ENTER||o.keyCode===$.ui.keyCode.TAB){var s=l(e.text());function a(t){return!!i().validate(s)&&(i().__active=!1,e.off("blur.editable"),e.blur(),t(s,s!=i().active_text),!0)}if(i().ctrl_cmd&&(o.ctrlKey||o.metaKey))return o.preventDefault(),a(i().ctrl_cmd);if(!t.allow_multiline||o.ctrlKey||o.metaKey)return o.preventDefault(),a(i().change)}else if(o.keyCode===$.ui.keyCode.ESCAPE)e.blur(),window.getSelection().removeAllRanges();else if(o.keyCode===$.ui.keyCode.HOME)n(0);else if(o.keyCode===$.ui.keyCode.END)n(l(e.text()).length);else if(o.keyCode===$.ui.keyCode.RIGHT)if(o.ctrlKey||o.altKey){var c=e.text().substring(r().startOffset);(0==(c.match(/ /g)||[]).length||1==(c.match(/ /g)||[]).length&&" "==c[0]||0===r().startOffset&&r().endOffset===e.text().length)&&(o.preventDefault(),n(l(e.text()).length))}else(r().startOffset===l(e.text()).length-1||0===r().startOffset&&r().endOffset===e.text().length)&&n(l(e.text()).length);return!0},"input.editable":function(t){0===e.text().length?e.css("padding-right","1px"):e.css("padding-right","")}})}return e},fake_hover:function(e){var t=e.parent,o="none"!==$(".notebook-commands.appear",e.element).css("display")?t.children.indexOf(e):void 0;ui_utils.on_next_tick(function(){if(o>=0&&o<t.children.length){var e=t.children[o];$(e.element).mouseover()}})},on_next_tick:function(e){window.setTimeout(e,0)},scroll_to_after:function(e,t,o,n,r){var i=$.extend($.scrollTo.defaults,{axis:"y"},t);if(0!==e.length){r||(r=0),o||(o=e.parent());var s=ui_utils.get_top_offset(n),l=o.scrollTop()+s+e.position().top+e.outerHeight()-r;o.scrollTo(l,i)}},get_top_offset:function(e){var t=0;return e&&e.forEach(function(e){t+=e.position().top}),t},is_visible_in_scrollable:function(e,t){if(!e.size())return!1;var o=+e.css("height").replace("px",""),n=ui_utils.get_top_offset(t);return $(t[t.length-1]).is(":visible")&&(n+=t[t.length-1].outerHeight()),(n-=e.get(0).offsetTop)<=o},scroll_into_view:function(e,t,o,n){if(arguments.length<5)console.warn("scroll_into_view needs offset elements");else{var r=$.extend($.scrollTo.defaults,{axis:"y",duration:600}),i=+e.css("height").replace("px",""),s=e.scrollTop();n&&(r.onAfter=function(e,t){n()});var l=ui_utils.get_top_offset(Array.prototype.slice.call(arguments,4));l>i?e.scrollTo(s+l-i+t,r):l<0?e.scrollTo(s+l-o,r):n&&n()}},prevent_backspace:function(e){e.unbind("keydown").bind("keydown",function(e){if(8===e.keyCode){var t=!0,o=$(e.srcElement||e.target);if(!(o.prop("readonly")||o.prop("disabled")))if(o[0].isContentEditable)t=!1;else if(o.is("input")){var n=o.attr("type");n&&(n=n.toLowerCase()),["text","password","file","search","email","number","date","color","datetime","datetime-local","month","range","search","tel","time","url","week"].indexOf(n)>-1&&(t=!1)}else o.is("textarea")&&(t=!1);if(t)return e.preventDefault(),!1}})}};ui_utils.is_a_mac=function(){var e=navigator.platform.toUpperCase();return function(){return-1!==e.indexOf("MAC")}}(),ui_utils.is_ie=function(){var e=window.navigator.userAgent;return e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0},ui_utils.kill_popovers=function(){window.allPopovers&&($(window.allPopovers).each(function(e,t){$(this).popover("destroy")}),window.allPopovers.length=0)},ui_utils.hide_selectize_dropdown=function(){$(".selectize-dropdown").hide(),$(".selectize-input").removeClass("focus input-active dropdown-active")},ui_utils.select_allowed_elements=function(e){var t=window.getSelection(),o=$('<div class="offscreen" />'),n=$("<pre />");o.append(n),$("body").append(n);for(var r=0;r<t.rangeCount;++r){var i=t.getRangeAt(r);n.append(i.cloneContents())}n.find(".nonselectable").remove(),n.is(":empty")?t.removeAllRanges():t.selectAllChildren(n[0]),window.setTimeout(function(){o.remove()},1e3)},RCloud.utils={},RCloud.utils.promise_for=function(e,t,o){return e(o)?t(o).then(RCloud.utils.promise_for.bind(null,e,t)):o},RCloud.utils.promise_sequence=function(e,t){return RCloud.utils.promise_for(function(t){return t<e.length},function(o){return t(e[o]).return(++o)},0)},RCloud.utils.slow_promise=function(e,t){return new Promise(function(o,n){window.setTimeout(function(){e.then(function(e){o(e)},function(e){n(e)})},t)})},RCloud.utils.get_url_parameter=function(e){return decodeURIComponent((new RegExp("[?|&]"+e+"=([^&;]+?)(&|#|;|$)").exec(location.search)||[,""])[1].replace(/\+/g,"%20"))||null},RCloud.utils.get_notebook_from_url=function(e){var t=e.match(new RegExp("[?&]notebook=([^&#]*)"));return t&&t[1]},RCloud.utils.clean_r=function(e){return _.omit(e,"r_type","r_attributes")},RCloud.utils.split_number=function(e){var t=/(\d+)$/.exec(e);return t?[e.slice(0,t.index),t[1]]:null},RCloud.utils.format_date_time_stamp=function(e,t,o,n,r){var i,s=new Date,l='<span class="notebook-time">'+e.getHours()+":"+((i=e.getMinutes())<10?"0"+i:i)+"</span>",a=e.getMonth()+1+"/"+e.getDate(),c=e.getFullYear().toString().substr(2,2);return t<864e5&&o&&r&&n?l:e.getFullYear()===s.getFullYear()?"<span>"+a+" "+l+"</span>":"<span>"+a+"/"+c+" "+l+"</span>"},RCloud.utils.filter=function(e,t){return _.mixin({invokeWith:function(){var e=arguments;return function(t){return t.apply(null,e)}}}),_.isArray(e)||(e=[e]),_.filter(e,_.compose(_.partial(_.all,t),_.invokeWith))},RCloud.extension={filter_field:function(e,t){return function(o){return o[e]===t}},create:function(e){var t={},o={},n=(e=e||{}).defaults?e.defaults:{};if(e.sections)for(var r in e.sections)o[r]={filter:e.sections[r].filter};else o.all={};function i(){for(r in o)o[r].entries=_.filter(t,function(e){return!e.disable&&(!o[r].filter||o[r].filter(e))}),o[r].entries.sort(function(e,t){return e.sort-t.sort})}return{add:function(e){for(var o in e)t[o]=_.extend(_.extend({key:o},n),e[o]);return i(),this},remove:function(e){return delete t[e],i(),this},disable:function(e,o){return t[e]&&(t[e].disable=o,i()),this},get:function(e){return t[e]},entries:function(e){return o[e].entries},create:function(e,t){var o={},n=[],r=Array.prototype.slice.call(arguments,1),i=this.entries(e);return i&&i.forEach(function(e){n.push(o[e.key]=e.create.apply(e,r))}),{map:o,array:n}},sections:o}}};var bootstrap_utils={alert:function(e){e=_.defaults(e||{},{close_button:!0,on_close:function(){}});var t=$('<div class="alert"></div>');return e.html&&t.html(e.html),e.text&&t.text(e.text),e.class&&t.addClass(e.class),e.close_button&&t.prepend($('<button type="button" class="close" data-dismiss="alert">&times;</button>').click(e.on_close)),t},button:function(e){e=e||{};var t=$('<a class="btn" href="#"></a>');return t.text(e.text),e.class&&t.addClass(e.class),t}};Notebook={},Notebook.Buffer={},Notebook.Cell={},Notebook.Asset={},Notebook.Buffer.create_model=function(e,t){var o="";function n(e){return Notebook.empty_for_github(e)}return{views:[],parent_model:null,renew_content:function(){o=""},content:function(t){return _.isUndefined(t)?e:e!==t?(e=t,this.notify_views(function(e){e.content_updated()}),e):null},language:function(e){if(!_.isUndefined(e))return t!==e?(t=e,this.notify_views(function(e){e.language_updated()}),t):null;if(void 0===t)throw new Error("tried to read no language");return null===t?"Text":t},change_object:function(t){if(t.content)throw new Error("content must come from the object");if(!t.filename)throw new Error("change object must have filename");var r={filename:t.filename};return t.erase?r.erase=!n(o):t.rename?n(e)?n(o)||(r.erase=!0):(n(o)?r.filename=t.rename:r.rename=t.rename,r.content=e):n(e)?n(o)||(r.erase=!0):(e!=o&&(r.content=e),n(o)&&(r.create=!0)),o=e,r},asset_url:function(e){var t=this.parent_model.controller.current_gist(),o=[window.location.protocol+"//"+window.location.host,"notebook.R",t.id];return e&&o.push(t.history[0].version),o.push(this.filename()),o.join("/")},notify_views:function(e){_.each(this.views,function(t){e(t)})}}},Notebook.Asset.create_html_view=function(e){var t=$("<li></li>"),o=$("<div></div>"),n=$("<span style='cursor:pointer'>"+e.filename()+"</span>"),r=ui_utils.fa_button("icon-remove","remove","",{position:"relative",left:"2px",opacity:"0.75"},!0),i=$('<i class="icon-camera" style="padding-left: 4px; cursor: help;" title="Shown as your notebook\'s thumbnail on the Discover page"></i>');o.append(n),t.append(o),l(e.filename())&&o.append(i),o.append(r);var s=n.text();function l(e){return"thumb.png"===e}var a={change:function(t){shell.notebook.controller.save().then(function(){var t=n.text().trim();t=t.replace(/\s/g," ");var o=e.content();if(Notebook.is_part_name(t))return alert("Asset names cannot start with 'part[0-9]', sorry!"),void n.text(s);s===t?n.text(s):shell.notebook.model.get_asset(t)?(alert('An asset with the name "'+t+'" already exists. Please choose a different name.'),n.text(s)):shell.notebook.controller.append_asset(o,t).spread(function(o,n){n.select(),e.controller.remove(!0),!l(s)&&l(t)?i.insertBefore(r):l(s)&&!l(t)&&i.remove()})})},select:function(e){if(1!==e.childNodes.length||e.firstChild.nodeType!=e.TEXT_NODE)throw new Error("expecting simple element with child text");var t=e.firstChild.textContent,o=document.createRange();return o.setStart(e.firstChild,0),o.setEnd(e.firstChild,t.lastIndexOf(".")>0?t.lastIndexOf("."):t.length),o},validate:function(e){return editor.validate_name(e)}};return o.click(function(){e.active()||e.controller.select()}),r.click(function(){e.controller.remove()}),{filename_updated:function(){o.text(e.filename())},content_updated:function(){e.active()&&RCloud.UI.scratchpad.content_updated()},language_updated:function(){e.active()&&RCloud.UI.scratchpad.language_updated()},active_updated:function(){e.active()?(shell.notebook.model.read_only()||ui_utils.editable(n,$.extend({allow_edit:!0,inactive_text:n.text(),active_text:n.text()},a)),t.addClass("active")):(ui_utils.editable(n,"destroy"),t.removeClass("active"))},self_removed:function(){t.remove()},set_readonly:function(e){e?r.hide():r.show()},div:function(){return t}}},Notebook.Asset.create_model=function(e,t){var o,n=!1,r=Notebook.Buffer.create_model(e),i=r.change_object;return _.extend(r,{active:function(e){return _.isUndefined(e)?n:n!==e?(n=e,this.notify_views(function(e){e.active_updated()}),n):null},cursor_position:function(e){return _.isUndefined(e)||(o=e),o},filename:function(e){return _.isUndefined(e)?t:t!=e?(t=e,this.notify_views(function(e){e.filename_updated()}),t):null},json:function(){return{content:e,filename:this.filename(),language:this.language()}},change_object:function(e){return(e=e||{}).filename=e.filename||this.filename(),i.call(this,e)}}),r},Notebook.Asset.create_controller=function(e){return{select:function(){RCloud.UI.scratchpad.current_model&&RCloud.UI.scratchpad.current_model.controller.deselect(),e.active(!0),RCloud.UI.scratchpad.set_model(e)},deselect:function(){e.active(!1)},remove:function(t){var o=e.filename();if((t||confirm("Do you want to remove the asset '"+o+"' from the notebook?"))&&(e.parent_model.controller.remove_asset(e),e===RCloud.UI.scratchpad.current_model)){var n=e.parent_model.assets;n.length?n[0].controller.select():RCloud.UI.scratchpad.set_model(null)}}}},function(){var e=2,t=2,o=$("#rcloud-cellarea");function n(n,r){var i,s,l,a,c,u,d,f,h,p,m,g,v,b,y,k,w,C,x,R,I,U,E,A,S="unknown",P=[],N={options:{no_of_results_in_batch:20,notebook_update_delay:20},results:[],stop:!1,prev_scroll:null,result_consumer:null,scrolled:!1},O={},j=$("<div class='notebook-cell'></div>");function T(){return s?r.content(s.getValue()):null}function D(){j.attr("id",Notebook.part_name(r.id(),r.language())),b&&b.controls.cell_number.set(r.id())}function B(o){G.css("height",o||ui_utils.ace_editor_height(i,e)+t+"px")}j.data("rcloud.model",r),m=$("<div class='cell-status nonselectable'></div>");var L=$("<div class='cell-status-left'></div>");if(m.append(L),b=RCloud.UI.cell_commands.decorate("left",L,r,O),!shell.is_view_mode()){var M=$("<div class='cell-control-bar'></div>");m.append(M),M.mousedown(function(e){e.stopPropagation()}),v=RCloud.UI.cell_commands.decorate("cell",M,r,O);var z=$("<div class='cell-controls-above nonselectable'></div>");g=RCloud.UI.cell_commands.decorate("above",z,r,O),j.append(z),m.click(function(e){var t=$(this).closest(".notebook-cell").data("rcloud.model");(e.ctrlKey||e.metaKey||e.shiftKey)&&e.preventDefault(),t.parent_model.controller.select_cell(t,{is_toggle:ui_utils.is_a_mac()&&e.metaKey||!ui_utils.is_a_mac()&&e.ctrlKey,is_range:e.shiftKey,is_exclusive:!e.ctrlKey&&!e.shiftKey}),$(":focus").blur()}).children().click(function(e){$(e.target).hasClass("cell-number")||e.stopPropagation()})}j.append(m);function F(e){var t=RCloud.language.is_a_markdown(n);e.toggleClass(t?"edit-markdown":"edit-code",!0),e.toggleClass(t?"edit-code":"edit-markdown",!1)}function K(){n=r.language();const e=RCloud.language.is_a_markdown(n);if(e||O.hide_source&&O.hide_source(!1),v&&(v.controls.language_cell.set(n),v.set_flag("markdown",e)),F(c.find("pre")),i){Q.toggleClass("active",!0),F(Q);var t=RCloud.language.ace_mode(n);s.setMode(new t({suppressHighlighting:!1,doc:l,session:s,language:n}))}}var q=$("<div></div>"),H=$("<div style='clear:both;'></div>");j.append(q),j.append(H),a=$('<div class="source-div"></div>'),c=$('<div class="code-div"></div>'),a.append(c);var G=$('<div class="outer-ace-div"></div>'),Q=$('<div style="width:100%; height:100%;"></div>');function W(e,t){t?(F(c.find("pre")),!1===S&&e.toggleClass("inactive",!0),e.on({"mousedown.rcloud-cell":function(e){$(this).data("p0",{x:e.pageX,y:e.pageY})},"mouseup.rcloud-cell":function(t){var o=$(this).data("p0");if(o){var n={x:t.pageX,y:t.pageY};Math.sqrt(Math.pow(n.x-o.x,2)+Math.pow(n.y-o.y,2))<4&&(S?O.hide_source(!1):O.edit_source(!0,t),e.mouseleave())}}})):e.off("mousedown.rcloud-cell mouseup.rcloud-cell")}function J(){Notebook.Cell.postprocessors.entries("all").forEach(function(e){e.process(u,O)})}function Y(){u.empty(),d=!1,v&&le(!1)}function V(){return $.contains(document,j.get(0))}function Z(){return ui_utils.is_visible_in_scrollable($("#rcloud-cellarea"),[j,u])}function X(){if(C){var e=$("#rcloud-cellarea");if(u){ui_utils.scroll_to_after(u,{axis:"y",duration:0,interrupt:!0,offset:{top:10}},e,[j],e.height())}}}function ee(e,t){switch(e){case"selection":case"function_call":case"deferred_result":break;default:Notebook.Cell.preprocessors.entries("all").forEach(function(e){t=e.process(t)})}var o;switch("code"!=e&&(f=null),"error"!=e&&(h=null),e){case"code":f||(o=$("<pre></pre>"),f=$("<code></code>"),o.append(f),u.append(o)),f.append(_.escape(t));break;case"error":h||(o=$("<pre></pre>"),h=$('<code style="color: crimson"></code>'),o.append(h),u.append(o)),h.append(_.escape(t));break;case"selection":case"html":u.append(t);break;case"function_call":_.isFunction(t)&&t(u);break;case"deferred_result":u.append('<span class="deferred-result">'+t+"</span>");break;default:throw new Error("unknown result type "+e)}}function te(e){return e&&!Z()&&!N.scrolled}function oe(e){!N.stop&&N.result_consumer||(N.stop=!1,N.results.length=0,N.result_consumer=function(){var e=0,t=Z();for(N.scrolled=!1;e<N.options.no_of_results_in_batch;){var o=N.results.shift();if(!o)break;ee(o.type,o.result),e++,te(t)&&X()}e>0?(J(),te(t)&&X(),V()&&(!N.stop||N.results.length>0)&&window.setTimeout(N.result_consumer,N.options.notebook_update_delay)):(N.stop=!0,N.result_consumer=null)},window.setTimeout(N.result_consumer,e))}function ne(e,t,o){ace.require("ace/ext/language_tools");var n=ace.edit(e[0]),r=n.getSession();n.$blockScrolling=1/0,n.setValue(t),ui_utils.ace_set_pos(n,0,0),ui_utils.on_next_tick(function(){r.getUndoManager().reset()});var i=r.getDocument();return n.gotoPageUp=function(){n.renderer.layerConfig.height=$("#rcloud-cellarea").height(),n.$moveByPage(-1,!1)},n.gotoPageDown=function(){n.renderer.layerConfig.height=$("#rcloud-cellarea").height(),n.$moveByPage(1,!1)},n.setAutoScrollEditorIntoView=function(e){if(e){var t,o=n,r=!1;n.$scrollAnchor||(n.$scrollAnchor=window.document.createElement("div"));var i=n.$scrollAnchor;i.style.cssText="position:absolute;",$("#rcloud-cellarea").prepend(i);var s=n.on("changeSelection",function(){r=!0}),l=n.renderer.on("beforeRender",function(){r&&(t=o.renderer.container.getBoundingClientRect())}),a=n.renderer.on("afterRender",function(){if(r&&t&&o.isFocused()){var e=o.renderer,n=e.$cursorLayer.$pixelPos,i=e.layerConfig,s=n.top-i.offset;if(null!=(r=n.top>=0&&s+t.top<$("#rcloud-cellarea").offset().top||!(n.top<i.height&&n.top+t.top+i.lineHeight>window.innerHeight)&&null)){var l=$(e.$cursorLayer.element).closest(".outer-ace-div").offset().top+$("#rcloud-cellarea").scrollTop()-$("#rcloud-cellarea").offset().top;l+=n.top,r?$("#rcloud-cellarea").scrollTop(l):$("#rcloud-cellarea").scrollTop(l-$("#rcloud-cellarea").height()+i.lineHeight)}r=t=null}});n.setAutoScrollEditorIntoView=function(e){e||(delete n.setAutoScrollEditorIntoView,n.removeEventListener("changeSelection",s),n.renderer.removeEventListener("afterRender",a),n.renderer.removeEventListener("beforeRender",l))}}},n.setOptions({enableBasicAutocompletion:!0,autoScrollEditorIntoView:!0,highlightActiveLine:o,highlightGutterLine:o}),o||(n.renderer.$cursorLayer.element.style.display="none"),n.on("focus",function(){n.setOptions({highlightActiveLine:!0,highlightGutterLine:!0}),n.renderer.$cursorLayer.element.style.display=null}),n.on("blur",function(){n.setOptions({highlightActiveLine:!1,highlightGutterLine:!1}),n.getSelection().clearSelection(),n.renderer.$cursorLayer.element.style.display="none"}),n.setTheme("ace/theme/chrome"),r.setNewLineMode("unix"),r.setOption("indentedSoftWrap",!1),r.setUseWrapMode(!0),{widget:n,session:r,document:i}}function re(){var e;switch(w){case"waiting":case"unknown":e="unknown";break;case"running":case"unknown-running":e="unknown-running";break;default:e="ready"}O.state_changed(e)}function ie(e){return"find-highlight "+e}function se(e){v&&v.controls.edit&&v.controls.edit.control.find("i").toggleClass("icon-border",e)}function le(e){v&&v.controls.results.control.find("i").toggleClass("icon-border",e)}function ae(e){e=e||r.content(),e=P.reduce(function(e,t){return t(e)},e),c.empty();var t,o=$("<code></code>").append(e),n=$('<div class="rcloud-gutter"></div>'),i=RCloud.language.hljs_class(r.language());i&&o.addClass(i),c.append(n,$("<pre></pre>").append(o)),(t=c,t.find("pre code").filter(function(e,t){return t.classList.length>0})).each(function(e,t){hljs.highlightBlock(t)}),c.find(".rcloud-line-number .hljs-number").css("color","black"),"unknown"!==S&&W(c.find("pre"),!0),F(c.find("pre"))}return F(Q),D(),G.append(Q),a.append(G),q.append(a),P.push(function(e){var t=_.escape,o=0,n=[];return k&&k.forEach(function(r){n.push(t(e.substring(o,r.begin))),n.push('<span class="',ie(r.kind),'">',t(e.substring(r.begin,r.end)),"</span>"),o=r.end}),n.push(t(e.substring(o))),n.join("")},function(e){var t=1;return e=e.split("\n").map(function(e){return['<span class="rcloud-line-number-position nonselectable">',"&#x200b;",'<span class="rcloud-line-number">',t++,"</span></span>",e].join("")}).join("\n"),e+="&nbsp;"},function(t){"\n"===t[t.length-1]&&(t+="\n");var o=(t.match(/\n/g)||[]).length;return o<e&&(t+=new Array(e+1-o).join("\n")),t}),ae(),u=$('<div class="r-result-div"></div>'),Y(),q.append(u),R=$('<div class="input-div"></div>'),I=$('<div style="height: 100%"></div>'),R.hide().append(I),q.append(R),K(),_.extend(O,{content_updated:function(){if(ae(),i){var e=s.getScrollTop(),t=i.getSelection().getRange(),o=p(r.content());o&&i.getSelection().setSelectionRange(t),s.setScrollTop(e)}return o},self_removed:function(){j.remove()},ace_widget:function(){return i},id_updated:D,language_updated:function(){K(),re()},selected_updated:function(){r.is_selected()?j.addClass("selected"):j.removeClass("selected"),j.find('.cell-control input[type="checkbox"]').prop("checked",r.is_selected())},state_changed:function(e){var t=b.controls.run_state;switch("unknown"===w&&"running"===e&&(e="unknown-running",d=!1),e){case"ready":t.icon("icon-circle-blank").color("#777").title("content has not been run");break;case"waiting":t.icon("icon-arrow-right").color("blue").title("cell is enqueued and waiting to run");break;case"cancelled":t.icon("icon-asterisk").color("#e06a06").title("execution was cancelled before this cell could run");break;case"unknown-running":t.icon("icon-question icon-spin").color("blue").title("cell is currently running");break;case"running":t.icon("icon-spinner icon-spin").color("blue").title("cell is currently running"),d=!1;break;case"complete":t.icon("icon-circle").color("#72B668").title("cell successfully ran");break;case"error":t.icon("icon-exclamation").color("crimson").title("cell ran but had an error");break;case"unknown":t.icon("icon-question").color("purple").title("output may or may not reflect current content")}return w=e,this},add_result:function(e,t){d||(u.empty(),RCloud.language.is_a_markdown(n)&&O.hide_source(!0),d=!0),oe(N.options.notebook_update_delay),this.toggle_results(!0),N.results.push({type:e,result:t})},end_output:function(e){d||(u.empty(),d=!0);var t=this;!function(e){N.stop=!0;var t=function(){V()&&(N.results.length>0?setTimeout(t,N.options.notebook_update_delay):e())};t()}(function(){t.state_changed(e?"error":"unknown-running"===w?"unknown":"complete"),f=h=null})},clear_result:Y,set_readonly:function(e){S=e,i&&ui_utils.set_ace_readonly(i,e),[v,g,b].forEach(function(t){t&&t.set_flag("modify",!e)}),W(c.find("pre"),!e),m.toggleClass("readonly",e),e&&se($(a).is(":visible"))},set_show_cell_numbers:function(e){b.set_flag("cell-numbers",e)},set_autoscroll_notebook_output:function(e){C=e},on_scroll:function(e){N.prev_scroll&&(N.scrolled=N.prev_scroll>e.currentTarget.scrollTop),N.prev_scroll=e.currentTarget.scrollTop},click_to_edit:W,execute_cell:function(){r.controller.enqueue_execution_snapshot(r.parent_model.controller.save())},toggle_edit:function(){return this.edit_source(!y)},edit_mode:()=>y,edit_source:function(e,t,u){if(void 0===u&&(u=!0),e!==y){if(e){var d=o.scrollTop();v&&se(!0),RCloud.language.is_a_markdown(n)&&this.hide_source(!1);var _=c.height();if(c.hide(),function(e){if(!i){var t=ne(Q,r.content(),e);i=t.widget,s=t.session,l=t.document,s.on("change",function(){B(),i.resize()}),i.resize(),i.commands.removeCommand("findnext"),i.commands.removeCommand("findprevious"),ui_utils.install_common_ace_key_bindings(i,function(){return n}),i.commands.commandKeyBinding.left,i.commands.commandKeyBinding.right;var o=i.commands.commandKeyBinding.up,a=i.commands.commandKeyBinding.down;i.commands.addCommands([{name:"executeCell",bindKey:{win:"Alt-Return",mac:"Alt-Return",sender:"editor"},exec:function(){O.execute_cell()}},{name:"executeCellsFromHere",bindKey:{win:"Shift-Alt-Return",mac:"Shift-Alt-Return",sender:"editor"},exec:function(){shell.run_notebook_from(r.id())}},{name:"up",bindKey:{win:"up",mac:"up"},exec:function(e,t,n){var s=i.getCursorPosition(),l=!0;if(0===s.row&&0===s.column){var a=r.parent_model.prior_cell(r);if(a){a.set_focus();var c=a.views[0].ace_widget(),u=ui_utils.ace_get_last(c);c.gotoLine(u.row+1,0),l=!1}}l&&o.exec(e,t,n)}},{name:"down",bindKey:{win:"down",mac:"down"},exec:function(e,t,o){var n=!0,s=i.getCursorPosition(),l=ui_utils.ace_get_last(i);if(s.row==l.row&&s.column===l.column){n=!1;var c=r.parent_model.subsequent_cell(r);c&&(c.set_focus(),c.views[0].ace_widget().gotoLine(1,0))}n&&a.exec(e,t,o)}},{name:"navigateToPreviousCell",bindKey:{win:"Ctrl-Shift-,",mac:"Ctrl-Shift-,",sender:"editor"},exec:function(){var e=r.parent_model.prior_cell(r);e&&e.set_focus()}},{name:"navigateToNextCell",bindKey:{win:"Ctrl-Shift-.",mac:"Ctrl-Shift-.",sender:"editor"},exec:function(){var e=r.parent_model.subsequent_cell(r);e&&e.set_focus()}},{name:"insertCellBefore",bindKey:{win:"Ctrl-[",mac:"Cmd-[",sender:"editor"},exec:function(){var e=shell.insert_cell_before("",r.language(),r.id());e.updatePromise.then(function(){e.controller.edit_source(!0)})}},{name:"insertCellAfter",bindKey:{win:"Ctrl-]",mac:"Cmd-]",sender:"editor"},exec:function(){var e=shell.insert_cell_after("",r.language(),r.id());e.updatePromise.then(function(){e.controller.edit_source(!0)})}},{name:"blurCell",bindKey:{win:"Escape",mac:"Escape",sender:"editor"},exec:function(){i.blur()}},{name:"executeAll",bindKey:{win:"Ctrl-Shift-Enter",mac:"Ctrl-Shift-Enter",sender:"editor"},exec:function(){RCloud.UI.run_button.run()}}]),i.commands.removeCommands(["find","replace"]),p=ui_utils.ignore_programmatic_changes(i,function(){re(),r.parent_model.on_dirty()}),K()}}(u),G.show(),i.resize(!0),B(_),i.resize(!0),v&&v.set_flag("edit",!0),G.show(),i.resize(),u&&i.focus(),t){o.scrollTop(d);var f=i.getSession().getScrollTop(),h=i.renderer.pixelToScreenCoordinates(t.pageX,t.pageY-f),m=s.screenToDocumentPosition(Math.abs(h.row),Math.abs(h.column)),g=ace.require("ace/range").Range,b=Math.abs(m.row),w=Math.abs(m.column),C=new g(b,w,b,w);i.getSelection().setSelectionRange(C)}}else{v&&se(!1),null!==T()&&r.parent_model.controller.update_cell(r),a.css({height:""}),v&&v.set_flag("edit",!1),c.show(),G.hide()}y=e,this.change_highlights(k)}else e&&u&&i.focus()},scroll_into_view:function(){var e=i.renderer,t=e.container.getBoundingClientRect(),o=e.$cursorLayer.$pixelPos,n=e.layerConfig,r=o.top-n.offset;if(o.top>=0&&r+t.top<$("#rcloud-cellarea").offset().top?shouldScroll=!0:o.top<n.height&&o.top+t.top+n.lineHeight>window.innerHeight?shouldScroll=!1:shouldScroll=null,null!=shouldScroll){var s=$(e.$cursorLayer.element).closest(".outer-ace-div").offset().top+$("#rcloud-cellarea").scrollTop()-$("#rcloud-cellarea").offset().top;s+=o.top,shouldScroll?$("#rcloud-cellarea").scrollTop(s):$("#rcloud-cellarea").scrollTop(s-$("#rcloud-cellarea").height()+n.lineHeight)}},is_a_markdown:()=>RCloud.language.is_a_markdown(n),is_in_view:function(){const e=$("#rcloud-cellarea")[0].getBoundingClientRect(),t=e.bottom-e.top,o=j[0].getBoundingClientRect();return o.top<e.top+t&&o.bottom>e.top},toggle_source:function(){return!this.hide_source($(a).is(":visible"))},hide_source:function(e){return e?(a.hide(),se(!1)):(a.show(),se(!0)),e},toggle_results:function(e){void 0===e&&(e=u.is(":hidden")),v&&le(e),e?u.show():u.hide()},get_input:function(e,t,o){d||(u.empty(),d=!0),oe(N.options.notebook_update_delay),x=_.escape(t).replace(/\n/g,""),function(){if(!U){var e=ne(I,"");U=e.widget,ui_utils.customize_ace_gutter(U,function(e){return 0===e?x:""}),U.commands.addCommands([{name:"enter",bindKey:"Return",exec:function(e,t,o){var n=e.getValue();O.add_result("code",_.unescape(x)+n+"\n"),E&&E(null,n),R.hide(),window.clearInterval(A),A=null}}]),RCloud.UI.prevent_progress_modal()}}(),U.setValue(""),R.show(),R.css("height","36px"),U.renderer.$gutterLayer.gutterWidth=0,U.renderer.$changes|=U.renderer.__proto__.CHANGE_FULL,U.resize(!0),U.focus(),R.css("border-color","#eeeeee");var n=!1,r=function(){d3.select(R[0]).style("border-color",n?"#ffac88":"#E34234").transition().duration(1e3).style("border-color",n?"#E34234":"#ffac88"),n=!n};r(),A=window.setInterval(r,1e3),C||ui_utils.scroll_into_view($("#rcloud-cellarea"),100,100,null,j,R),E=o},div:function(){return j},update_model:function(){return T()},focus:function(){return i.focus(),this},get_content:function(){return r.content()},get_selection:function(){return this.ace_widget().getSession().doc.getTextRange(this.ace_widget().selection.getRange())},reformat:function(){return y&&(i.resize(),B(),i.resize()),this},check_buttons:function(){return g&&g.set_flag("first",!r.parent_model.prior_cell(r)),this},change_highlights:function(e){if(k=e,y){var t=s.getMarkers();for(var o in t)"rcloud-select"===t[o].type&&s.removeMarker(o);e&&e.forEach(function(e){var t=ui_utils.ace_range_of_character_range(i,e.begin,e.end);s.addMarker(t,ie(e.kind),"rcloud-select"),/active/.test(e.kind)&&(i.scrollToLine(t.start.row),window.setTimeout(function(){var t=Q.find(".find-highlight."+e.kind);t.size()&&ui_utils.scroll_into_view($("#rcloud-cellarea"),100,100,null,j,Q,t)},0))})}else{ae();var n=c.find(".find-highlight.active, .find-highlight.activereplaced");n.size()&&ui_utils.scroll_into_view($("#rcloud-cellarea"),100,100,null,j,c,n)}return this},select_highlight_range:function(e,t){this.edit_source(!0);var o=ui_utils.ace_range_of_character_range(i,e,t);i.getSelection().setSelectionRange(o)}}),O.edit_source(!1),O}Notebook.Cell.create_html_view=function(e){return n(e.language(),e)}}(),Notebook.Cell.create_model=function(e,t){var o=-1,n=!1,r=Notebook.Buffer.create_model(e,t),i=r.change_object;return _.extend(r,{id:function(e){return _.isUndefined(e)||e==o||(o=e,this.notify_views(function(e){e.id_updated()})),o},filename:function(){if(arguments.length)throw new Error("can't set filename of cell");return Notebook.part_name(this.id(),this.language())},get_execution_snapshot:function(e){console.assert(e);var t=this.language()||"Text";return{controller:this.controller,json_rep:this.json(),partname:Notebook.part_name(this.id(),t),language:t,versionPromise:e}},set_focus:function(){this.notify_views(function(e){e.edit_source(!0),e.scroll_into_view(!0)})},deselect_cell:function(){return n=!1,this.notify_views(function(e){e.selected_updated()}),n},select_cell:function(){return n=!0,this.notify_views(function(e){e.selected_updated()}),n},toggle_cell:function(){return n=!n,this.notify_views(function(e){e.selected_updated()}),n},hide_cell_result:function(){return this.notify_views(function(e){e.toggle_results(!1)}),!1},show_cell_result:function(){return this.notify_views(function(e){e.toggle_results(!0)}),!0},is_selected:function(){return n},json:function(){return{content:e,language:this.language()}},change_object:function(e){if((e=e||{}).id&&e.filename)throw new Error("must specify only id or filename");if(!e.filename){var t=e.id||this.id();if(t>0!=!0)throw new Error("bad id for cell change object: "+t);e.filename=Notebook.part_name(t,this.language())}return e.rename&&_.isNumber(e.rename)&&(e.rename=Notebook.part_name(e.rename,this.language())),i.call(this,e)}}),r},Notebook.Cell.create_controller=function(e){var t=null;function o(e){return e.history[0].version}return{enqueue_execution_snapshot:function(n){var r=this;if(!t){function i(e){return r.append_result.bind(this,e)}var s=i("code");t={end:this.end_output.bind(this),out:s,err:i("error"),msg:s,html_out:i("html"),deferred_result:i("deferred_result"),selection_out:i("selection"),function_call:i("function_call"),in:this.get_input.bind(this,"in")}}var l=RCloud.register_output_context(t);r.set_run_state("waiting"),r.edit_source(!1);var a=e.get_execution_snapshot(n.then(o));RCloud.UI.processing_queue.enqueue(function(){return r.set_run_state("running"),e.parent_model.controller.execute_cell_version(l,a)},function(){r.set_run_state("cancelled")})},set_run_state:function(t){e.notify_views(function(e){e.state_changed(t)})},clear_result:function(){e.notify_views(function(e){e.clear_result()})},append_result:function(t,o){e.notify_views(function(e){e.add_result(t,o)})},end_output:function(t){e.notify_views(function(e){t&&!0!==t&&e.add_result("error",t),e.end_output(t)})},get_input:function(t,o,n){var r=_.find(e.views,function(e){return e.get_input});r?r.get_input(t,o,n):n("cell view does not support input",null)},edit_source:function(t){e.notify_views(function(e){e.edit_source(t)})},change_language:function(t){e.language(t)}}},Notebook.Cell.preprocessors=RCloud.extension.create(),Notebook.Cell.postprocessors=RCloud.extension.create(),Notebook.Cell.postprocessors.add({device_pixel_ratio:{sort:1e3,disable:!0,process:function(e){var t=rcloud.display.get_device_pixel_ratio();e.find("img").each(function(e,o){function n(){o.style.width=o.width/t}0===o.width?$(o).on("load",n):n()})}},deferred_results:{sort:2e3,process:function(e,t){rcloud.deferred_knitr_uuid;e.find("span.deferred-result").each(function(){var e=this,o=[this.textContent.split("|")[1]];o.r_attributes={class:"OCref"},rclient._rserve.wrap_ocap(o)(function(o,n){t.add_result("function_call",function(t){var r;o?$(e).replaceWith(function(){return ui_utils.string_error(o[0])}):(r=n(),$(e).replaceWith(function(){return r}))})})})}},mathjax:{sort:3e3,process:function(e){_.isUndefined(MathJax)||MathJax.Hub.Queue(["Typeset",MathJax.Hub])}},shade_pre_r:{sort:4e3,process:function(e){e.find("pre code").filter(function(e,t){return t.classList.length>0}).parent().toggleClass("r",!0)}},hide_source:{sort:5e3,process:function(e){shell.notebook.controller._r_source_visible||Notebook.hide_r_source(e)}},click_markdown_code:{sort:6e3,process:function(e,t){t.click_to_edit(e.find("pre.r"),!0)}}}),Notebook.Cell.preprocessors.add({quote_deferred_results:{sort:1e3,process:function(){var e,t,o;return function(n){!e!=rcloud.deferred_knitr_uuid&&(e=rcloud.deferred_knitr_uuid,t=new RegExp(e+"\\|[\\+a-zA-Z_0-9.]*","g"),o='<span class="deferred-result">$&</span>');var r=t.exec(n);if(r){for(var i=[],s=0;r;)i.push(n.substring(s,r.index)),i.push(o.replace("$&",n.substr(r.index,r[0].length).replace("+","@"))),s=r.index+r[0].length,r=t.exec(n);i.push(n.substring(s)),n=i.join("")}return n}}()}}),Notebook.create_html_view=function(e,t){var o,n,r,i=$("#rcloud-cellarea");function s(){_.each(a.sub_views,function(e){e.check_buttons()})}function l(t){t.set_readonly(e.read_only()||shell.is_view_mode()),t.set_show_cell_numbers(o),t.set_autoscroll_notebook_output(n)}var a={model:e,sub_views:[],asset_sub_views:[],cell_appended:function(e){var o=Notebook.Cell.create_html_view(e);return e.views.push(o),t.append(o.div()),this.sub_views.push(o),l(o),s(),o},asset_appended:function(e,t){var o=Notebook.Asset.create_html_view(e);return e.views.push(o),void 0===t?($("#asset-list").append(o.div()),this.asset_sub_views.push(o)):(this.asset_sub_views.splice(t,0,o),$("#asset-list").find("li:eq("+t+")").after(o.div())),s(),o},cell_inserted:function(e,o){var n=Notebook.Cell.create_html_view(e);return e.views.push(n),t.append(n.div()),$(n.div()).insertBefore(t.children(".notebook-cell")[o]),this.sub_views.splice(o,0,n),l(n),s(),n},cell_removed:function(e,t){_.each(e.views,function(e){e.self_removed()}),this.sub_views.splice(t,1),s()},asset_removed:function(e,t){_.each(e.views,function(e){e.self_removed()}),this.asset_sub_views.splice(t,1)},cell_moved:function(e,t,o){this.sub_views.splice(t,1),this.sub_views.splice(o,0,e.views[0]),s()},set_readonly:function(e){_.each(this.sub_views,function(t){t.set_readonly(e)}),_.each(this.asset_sub_views,function(t){t.set_readonly(e)})},set_show_cell_numbers:function(e){o=e,_.each(this.sub_views,function(t){t.set_show_cell_numbers(e)})},set_autoscroll_notebook_output:function(e){n=e,_.each(this.sub_views,function(t){t.set_autoscroll_notebook_output(e)})},update_urls:function(){RCloud.UI.scratchpad.update_asset_url()},update_model:function(){return _.map(this.sub_views,function(e){return e.update_model()})},reformat:function(){_.each(this.sub_views,function(e){e.reformat()})},on_scroll:function(e){n&&_.each(this.sub_views,function(t){t.on_scroll(e)})},auto_activate:function(t){if(shell.notebook.model.read_only())return;const o=i.scrollTop(),n=Math.abs(o-r);void 0!==r&&n<100&&e.cells.map(e=>e.views[0]).filter(e=>e.is_in_view()).filter(e=>!e.is_a_markdown()||!e.autoactivate_once&&(e.autoactivate_once=!0)).forEach(e=>e.edit_source(!0,null,!1)),r=o},load_options:()=>rcloud.config.get_user_option("autoactivate-cells").then(function(t){(t=null===t||t)&&(e.auto_activate(!0),RCloud.UI.cell_commands.add({edit:{area:"cell",sort:3e3,display_flags:["markdown"],create:function(e,t){return RCloud.UI.cell_commands.create_button("icon-edit borderable","toggle source",()=>{t.toggle_source()&&t.edit_source(!0)})}}}),window.setInterval(a.auto_activate,100))})};return e.views.push(a),i.on("scroll",function(e){a.on_scroll(e)}),a},Notebook.create_model=function(){var e,t=!1,o="",n=void 0;function r(e){return e.length?e[e.length-1].id():0}return{cells:[],assets:[],views:[],dishers:[],execution_watchers:[],clear:function(){var e=this.remove_cell(null,r(this.cells)),t=this.remove_asset(null,this.assets.length);return RCloud.UI.selection_bar.update(this.cells),e.concat(t)},get_asset:function(e){return _.find(this.assets,function(t){return t.filename()==e})},append_asset:function(e,t,o){e.parent_model=this;var n=[];n.push(e.change_object());var r=this.assets.findIndex(function(t){return e.change_object().filename.localeCompare(t.change_object().filename,void 0,{sensitivity:"base"})<=0});return r<0?this.assets.push(e):this.assets.splice(r,0,e),o||_.each(this.views,function(t){t.asset_appended(e,r)}),n},cell_count:function(){return this.cells.length},selected_count:function(){return _.filter(this.cells,function(e){return e.is_selected()}).length},append_cell:function(e,t,o){e.parent_model=this,e.renew_content();var n=[],i=1;for(t=t||1,t=Math.max(t,r(this.cells)+1);i;)e.id(t),n.push(e.change_object()),this.cells.push(e),o||_.each(this.views,function(t){t.cell_appended(e)}),++t,--i;return RCloud.UI.selection_bar.update(this.cells),n},insert_cell:function(e,t,o){var n=this;e.parent_model=this,e.renew_content();for(var r=[],i=1,s=0;s<this.cells.length&&this.cells[s].id()<t;)++s;if(s<this.cells.length&&t+i>this.cells[s].id()){var l=s>0?this.cells[s-1].id():0;t=Math.max(this.cells[s].id()-i,l+1)}for(var a=0;a<i;++a)r.push(e.change_object({id:t+a})),e.id(t+a),this.cells.splice(s,0,e),o||_.each(this.views,function(e){e.cell_inserted(n.cells[s],s)}),++s;for(;s<this.cells.length&&i;){if(this.cells[s].id()>t){var c=this.cells[s].id()-t;i-=c,t+=c}if(i<=0)break;r.push(this.cells[s].change_object({rename:this.cells[s].id()+i})),this.cells[s].id(this.cells[s].id()+i),++s,++t}return RCloud.UI.selection_bar.update(this.cells),r.reverse()},remove_asset:function(e,t,o){if(0===this.assets.length)return[];var n,r,i=this;if(null!==e){if(n=this.assets.indexOf(e),r=e.filename(),-1===n)throw new Error("asset_model not in notebook model?!")}else n=0,r=this.assets[n].filename();t=t||1;for(var s=n,l=[];s<this.assets.length&&t;)this.assets[s].filename()==r&&(o||_.each(this.views,function(e){e.asset_removed(i.assets[s],s)}),l.push(i.assets[s].change_object({erase:1})),this.assets.splice(s,1)),s<this.assets.length&&(r=this.assets[s].filename()),--t;return l},remove_cell:function(e,t,o){var n,r;if(null!==e){if(n=this.cells.indexOf(e),r=e.id(),-1===n)throw new Error("cell_model not in notebook model?!")}else n=0,r=1;t=t||1;for(var i=n,s=[];i<this.cells.length&&t;){if(this.cells[i].id()==r){var l=this.cells[i];this.cells.splice(i,1),o||_.each(this.views,function(e){e.cell_removed(l,i)}),s.push(l.change_object({erase:1}))}++r,--t}return RCloud.UI.selection_bar.update(this.cells),s},remove_selected_cells:function(){var e=this,t=[];return _.chain(this.cells).filter(function(e){return e.is_selected()}).each(function(o){t=t.concat(e.remove_cell(o))}),RCloud.UI.selection_bar.update(this.cells),t},invert_selected_cells:function(){_.each(this.cells,function(e){e.toggle_cell()}),RCloud.UI.selection_bar.update(this.cells)},hide_selected_cells_results:function(){this.get_selected_cells().length?_.each(this.get_selected_cells(),function(e){e.hide_cell_result()}):_.each(this.cells,function(e){e.hide_cell_result()})},show_selected_cells_results:function(){this.get_selected_cells().length?_.each(this.get_selected_cells(),function(e){e.show_cell_result()}):_.each(this.cells,function(e){e.show_cell_result()})},clear_all_selected_cells:function(){_.each(this.cells,function(e){e.deselect_cell()}),RCloud.UI.selection_bar.update(this.cells)},get_selected_cells:function(){return this.cells.filter(function(e){return e.is_selected()})},crop_cells:function(){var e=this,t=[];return _.chain(this.cells).filter(function(e){return!e.is_selected()}).each(function(o){t=t.concat(e.remove_cell(o))}),RCloud.UI.selection_bar.update(this.cells),t},can_crop_cells:function(){return this.selected_count()&&this.selected_count()!==this.cell_count()},select_all_cells:function(){_.each(this.cells,function(e){e.select_cell()}),RCloud.UI.selection_bar.update(this.cells)},move_cell:function(e,t){var o=this.cells.indexOf(e),r=this.remove_cell(e,1,!0).concat(t>=0?this.insert_cell(e,t,!0):this.append_cell(e,null,!0)),i=this.cells.indexOf(e);return n=i,_.each(this.views,function(t){t.cell_moved(e,o,i)}),r},prior_cell:function(e){var t=this.cells.indexOf(e);return t>0?this.cells[t-1]:null},subsequent_cell:function(e){var t=this.cells.indexOf(e);return t<this.cells.length-1?this.cells[t+1]:null},change_cell_language:function(e,t){var o=e.filename();return e.language(t),[e.change_object({filename:o,rename:e.filename()})]},select_cell:function(e,t){var o=this,r=function(){_.chain(o.cells).filter(function(e){return e.is_selected()}).each(function(e){e.deselect_cell()})};if(t.is_toggle)e.toggle_cell(),n=this.cells.indexOf(e);else if(t.is_exclusive){var i=e.is_selected()&&1===this.get_selected_cells().length;r(),i?n=void 0:(e.toggle_cell(),n=this.cells.indexOf(e))}else{var s=this.cells.indexOf(e),l=n;!function(e,t){r();for(var n=e;n<=t;n++)o.cells[n].select_cell()}(Math.min(s,l),Math.max(s,l))}RCloud.UI.selection_bar.update(this.cells)},update_cell:function(e){return[e.change_object()]},update_asset:function(e){return[e.change_object()]},reread_buffers:function(){var e=_.map(this.views,function(e){return e.update_model()});if(1!=e.length)throw new Error("not expecting more than one notebook view");for(var t=e[0],o=[],n=0;n<t.length;++n)null!==t[n]&&o.push(this.cells[n].change_object());if(null!==RCloud.UI.scratchpad.update_model()){var r=RCloud.UI.scratchpad.current_model;o.push(r.change_object())}return o},read_only:function(e){return _.isUndefined(e)||(t=e,_.each(this.views,function(e){e.set_readonly(t)})),t},auto_activate:function(t){return void 0!==t&&(e=t),e},user:function(e){return _.isUndefined(e)||(o=e),o},update_files:function(e){for(var t=0;t<this.assets.length;++t){var o=e[this.assets[t].filename()];o&&this.assets[t].language(o.language)}_.each(this.views,function(e){e.update_urls()})},on_dirty:function(){_.each(this.dishers,function(e){e.on_dirty()})},json:function(){return _.map(this.cells,function(e){return e.json()})}}},Notebook.create_controller=function(e){var t,o,n,r=!1,i=!1,s=null,l=(n=null,function(){if(!n){var e=editor.load_callback({is_change:!0,selroot:!0});n=function(t){var o=RCloud.UI.navbar.control("save_notebook");return o&&o.disable(),r=!1,s&&(window.clearTimeout(s),s=null),rcloud.refresh_compute_notebook(t.id),e(t)}}return n});function a(t,o,n){var r=Notebook.Cell.create_model(t,o),i=Notebook.Cell.create_controller(r);return r.controller=i,{controller:i,changes:e.append_cell(r,n)}}function c(t,o){var n=Notebook.Asset.create_model(t,o),r=Notebook.Asset.create_controller(n);return n.controller=r,{controller:r,changes:e.append_asset(n,o),model:n}}function u(t,o,n){var r=Notebook.Cell.create_model(t,o),i=Notebook.Cell.create_controller(r);return r.controller=i,{controller:i,changes:e.insert_cell(r,n)}}function d(e,t){return e.collaborators&&e.collaborators.find(function(e){return e.login===t})}function f(n,r){var i;shell.is_view_mode()||(i=editor.get_notebook_info(r.id));var s=i&&i.source||null!==n||r.user.login!==rcloud.username()&&!d(r,rcloud.username())||shell.is_view_mode();if(t=r,o=Promise.resolve(r),e.read_only(s),!_.isUndefined(r.files)){var l;r.description||(r.description="(untitled)"),this.clear();var u,f={},h={};for(l in _.each(r.files,function(e,t){if("r_attributes"!==t&&"r_type"!==t){var o=e.filename;if(Notebook.is_part_name(o)){var n=parseInt(o.slice(4).split(".")[0]);isNaN(n)||(f[n]=[e.content,e.language,n])}else h[o]=[e.content,e.filename]}}),f)a(f[l][0],f[l][1],f[l][2]);for(l in h){var p=c(h[l][0],h[l][1]).controller;u=u||p}e.user(r.user.login),e.update_files(r.files),u?u.select():RCloud.UI.scratchpad.set_model(null),e.read_only(s)}return r}function h(e,o){function n(e){return e.name=function(e){return e},e}var r=[],i=e.files,s=_.extend({},o?o.files:t.files);for(var l in i)"r_type"!==l&&"r_attributes"!==l&&(l in s?(s[l].language==i[l].language&&s[l].content==i[l].content||r.push(n({filename:l,language:s[l].language,content:s[l].content})),delete s[l]):r.push(n({filename:l,erase:!0,language:i[l].language})));for(l in s)"r_type"!==l&&"r_attributes"!==l&&r.push(n({filename:l,language:s[l].language,content:s[l].content}));return r}function p(n,r,i){if(n=n.filter(function(e){return e.content||e.erase||e.rename}),e.read_only())return Promise.reject(new Error("attempted to update read-only notebook"));if(!n.length&&_.isUndefined(i))return o;r=r||shell.gistname();var s=function(e){return _.isUndefined(i)?e:_.extend(_.clone(e),i)}(function(e){var t={},o={};return _.each(e,function(e){e.erase||e.rename?(o[e.filename]?delete t[e.filename]:t[e.filename]=null,e.rename&&(t[e.rename]={content:e.content})):(!e.create||e.filename in t||(o[e.filename]=!0),t[e.filename]={content:e.content})}),{files:t}}(n));return o=rcloud.update_notebook(r,s).then(function(o){if("error"in o)throw o;return t=o,e.update_files(o.files),o}).catch(function(e){throw/non-existent/.test(e.message)&&editor.fatal_reload(e.message),e})}function m(e,t){return(e.length?p(e,t):Promise.resolve(void 0)).then(function(){return v.load_notebook(t,null)})}function g(){return e.reread_buffers()}e.dishers.push({on_dirty:function(){if(!r){var e=RCloud.UI.navbar.control("save_notebook");e&&e.enable(),r=!0}s&&window.clearTimeout(s);var t=shell.autosave_timeout();t>0&&(s=window.setTimeout(function(){v.save(),s=null},t))}});var v={current_gist:function(){return t},session_dirty:function(e){return arguments.length?(i=e,this):i},append_asset:function(e,t,o){var n=c(e,t);return p(g().concat(n.changes)).then(l()).then(function(e){return n.model.content(e.files[t].content),[e,n.controller]})},cell_count:function(){return e.cell_count()},selected_count:function(){return e.selected_count()},append_cell:function(e,t,o){var n=a(e,t,o);return{controller:n.controller,updatePromise:p(g().concat(n.changes)).then(l())}},insert_cell:function(e,t,o){var n=u(e,t,o);return{controller:n.controller,updatePromise:p(g().concat(n.changes)).then(l())}},remove_cell:function(t){var o=g().concat(e.remove_cell(t));return RCloud.UI.command_prompt.focus(),p(o).then(l())},remove_selected_cells:function(){var t=g().concat(e.remove_selected_cells());return RCloud.UI.command_prompt.focus(),p(t).then(l())},invert_selected_cells:function(){e.invert_selected_cells()},clear_all_selected_cells:function(){e.clear_all_selected_cells()},get_selected_cells:function(){return e.get_selected_cells()},crop_cells:function(){if(!this.can_crop_cells())return Promise.resolve(null);var t=g().concat(e.crop_cells());return RCloud.UI.command_prompt.focus(),p(t).then(l())},can_crop_cells:function(){return e.can_crop_cells()},select_all_cells:function(){e.select_all_cells()},remove_asset:function(t){return p(g().concat(e.remove_asset(t))).then(l())},move_cell:function(t,o){return p(g().concat(e.move_cell(t,o?o.id():-1))).then(l())},hide_cells_results:function(){e.hide_selected_cells_results()},show_cells_results:function(){e.show_selected_cells_results()},join_prior_cell:function(t){var o=e.prior_cell(t);if(!o)return Promise.resolve(void 0);function n(e){return e.length&&"\n"!=e[e.length-1]?e+"\n":e}function r(e,t,o){var n=new RegExp("^```{"+o.toLowerCase()+"}"),r=/```\n$/;return r.test(e)&&n.test(t)?e.replace(r,"")+t.replace(n,""):e+t}function i(e,t){return"```{"+e.toLowerCase()+"}\n"+n(t)+"```\n"}var s,a=g(),c="RMarkdown",u="Markdown";function d(e){return[u.toLowerCase(),c.toLowerCase()].indexOf(e.toLowerCase())>=0}return o.language()===t.language()?(s=r(n(o.content()),t.content(),o.language()),o.content(s),a=a.concat(e.update_cell(o))):(d(o.language())||d(t.language())?d(o.language())&&d(t.language())?(s=r(n(o.content()),t.content(),c),a=a.concat(e.change_cell_language(o,c))):d(o.language())?s=n(o.content())+i(t.language(),t.content()):(s=i(o.language(),o.content())+n(t.content()),a=a.concat(e.change_cell_language(o,t.language()))):(s=i(o.language(),o.content())+i(t.language(),t.content()),(a=a.concat(e.change_cell_language(o,u)))[a.length-1].content=s),o.content(s),a=a.concat(e.update_cell(o))),_.each(o.views,function(e){e.clear_result(),e.hide_source(!1)}),p(a=a.concat(e.remove_cell(t))).then(l())},split_cell:function(t,o,n){var r=g(),i=t.content();if(o>=n&&(n=void 0),void 0!==n&&/^\s*$/.test(i.substring(n))&&(n=void 0),void 0!==o&&(/^\s*$/.test(i.substring(o))?o=void 0:/^\s*$/.test(i.substring(0,o))&&(o=n)),void 0===o)return Promise.resolve(void 0);var s=[i.substring(0,o)],a=t.id(),c=t.language();void 0===n?s.push(i.substring(o)):s.push(i.substring(o,n),i.substring(n)),function(e){for(var t=0;t<e.length-1;++t)!/\n$/.test(e[t])&&/^\n/.test(e[t+1])&&(e[t]=e[t].concat("\n"),e[t+1]=e[t+1].replace(/^\n/,""))}(s),t.content(s[0]),_.each(t.views,function(e){e.clear_result()}),r=r.concat(e.update_cell(t));for(var d=1;d<s.length;++d)r=r.concat(u(s[d],c,a+d).changes);return p(r).then(l())},change_cell_language:function(t,o){return p(g().concat(e.change_cell_language(t,o))).then(l())},select_cell:function(t,o){g().concat(e.select_cell(t,o))},clear:function(){e.clear(),RCloud.UI.scratchpad.clear()},load_notebook:function(e,t){return rcloud.load_notebook(e,t||null).catch(function(e){throw e.from_load=!0,e}).then(_.bind(f,this,t))},create_notebook:function(e){return rcloud.create_notebook(e).then(_.bind(f,this,null))},revert_notebook:function(t,o){return e.read_only(!1),rcloud.load_notebook(t,null).then(function(e){return[h(e),t]}).spread(m)},pull_and_replace_notebook:function(o){return o.files["encrypted.notebook.content.bin.b64"]?Promise.reject(new Error("Can't pull from encrypted notebook")):(e.read_only(!1),m(h(t,o),shell.gistname()))},merge_notebook:function(e){return m(e,shell.gistname())},fork_notebook:function(t,o){return e.read_only(!1),rcloud.fork_notebook(t).then(function(e){return o?rcloud.get_notebook(e.id,null).then(function(e){return[h(e),e.id]}):[[],e.id]}).spread(m)},update_cell:function(t){return p(g().concat(e.update_cell(t))).then(l())},update_asset:function(t){return p(g().concat(e.update_asset(t))).then(function(e){return t.content(e.files[t.filename()].content),e}).then(l())},rename_notebook:function(e){return p(g(),null,{description:e}).then(l())},apply_changes:function(e){return p(e).then(l())},save:function(){return r?p(g()).then(l()):Promise.resolve(o)},execute_cell_version:function(t,o){function n(n){if(n&&n.r_attributes){if("parse-error"===n.r_attributes.class)throw RCloud.end_cell_output(t,"Parse error: "+n.error),"stop";if("cell-eval-error"===n.r_attributes.class){var r=n.traceback||"";r.join&&(r=r.join("\n"));var i=!r||"trace:\n"+r;throw RCloud.end_cell_output(t,i),"stop"}RCloud.end_cell_output(t,null)}else RCloud.end_cell_output(t,null);_.each(e.execution_watchers,function(e){e.run_cell(o.json_rep)})}i=!0,rcloud.record_cell_execution(o.json_rep);var r=rcloud.authenticated?rcloud.authenticated_cell_eval:rcloud.session_cell_eval;return o.versionPromise.then(function(e){return r(t,o.partname,o.language,e,!1).then(n)})},run_all:function(){var t=this.save();return _.each(e.cells,function(e){e.controller.enqueue_execution_snapshot(t)}),t},run_from:function(t){var o=!1,n=this.save();return _.each(e.cells,function(e){(o||e.id()===t)&&(o=!0,e.controller.enqueue_execution_snapshot(n))}),n},run_cells:function(t){var o=this.save();return _.each(e.cells,function(e){t.indexOf(e.id())>-1&&e.controller.enqueue_execution_snapshot(o)}),o},show_cell_numbers:function(t){return _.each(e.views,function(e){e.set_show_cell_numbers(t)}),this},autoscroll_notebook_output:function(t){return _.each(e.views,function(e){e.set_autoscroll_notebook_output(t)}),this},is_mine:function(){return rcloud.username()===e.user()||d(this.current_gist(),rcloud.username())},_r_source_visible:!0,hide_r_source:function(){this._r_source_visible=!1,RCloud.UI.advanced_menu.check("show_source",!1),Notebook.hide_r_source()},show_r_source:function(){this._r_source_visible=!0,RCloud.UI.advanced_menu.check("show_source",!0),Notebook.show_r_source()}};return e.controller=v,v},Notebook.hide_r_source=function(e){(e=e?$(e).find(".r"):$(".r")).hide()},Notebook.show_r_source=function(e){(e=e?$(e).find(".r"):$(".r")).show()},Notebook.is_binary_content=function(e){return!_.isUndefined(e.byteLength)&&!_.isUndefined(e.slice)},Notebook.read_from_file=function(e,t){var o,n=new FileReader;t=_.defaults(t,{on_load_end:$.noop,on_error:$.noop,on_notebook_parse_complete:$.noop}),n.onloadend=function(e){t.on_load_end();try{if(!(o=JSON.parse(n.result)).description)return void t.on_error("Invalid notebook format: has no description");if(!o.files||_.isEmpty(o.files))return void t.on_error("Invalid notebook format: has no files");o=Notebook.sanitize(o),t.on_notebook_parsed(o)}catch(e){t.on_error("Invalid notebook format: couldn't parse JSON")}},n.readAsText(e)},RCloud.discovery_model=function(){var e={};return{get_notebooks:function(t,o){o=_.filter(o,function(e){return e.length&&"r"!==e[0]});var n=_.difference(o,Object.keys(e));return(n.length?Promise.all([rcloud.get_multiple_notebook_infos(n),rcloud.stars.get_multiple_notebook_star_counts(n),t?Promise.resolve([]):rcloud.stars.get_my_starred_notebooks(),rcloud.get_multiple_fork_counts(n)]).spread(function(t,o,n,r){var i;delete(i=t).r_attributes,delete i.r_type,t=i,Object.keys(t).forEach(function(e){t[e].stars=o[e]||0,t[e].forks=r[e]||0}),_.extend(e,t),_.each(n,function(t){e[t]&&(e[t].is_starred_by_me=!0)})}):Promise.resolve()).then(function(){return _.pick(e,o)})}}}(),Notebook.part_name=function(e,t){if(_.isString(e))return e;var o=RCloud.language.extension(t);if(_.isUndefined(o))throw new Error("Unknown language "+t);return"part"+e+"."+o},Notebook.empty_for_github=function(e){return/^\s*$/.test(e)},Notebook.is_part_name=function(e){return e.match(/^part\d+\./)},Notebook.sanitize=function(e){var t=(e=_.pick(e,"description","files")).files;for(var o in delete t.r_attributes,delete t.r_type,t)t[o]=_.pick(t[o],"content");return e},Notebook.valid_gist_id=function(e){return null!==e.match(/^[a-f0-9]*$/i)&&-1!==[20,32].indexOf(e.length)},function(){function e(e,t){RCloud.UI.session_pane.append_text(t)}function t(t){var o=arguments[1],r=Array.prototype.slice.call(arguments,2),i=n[o];return i&&i[t]?(i[t].apply(i,r),!0):(e(0,r[0]),!1)}function o(e,o,n,r,i,s){(console.log("handle_img ",e," device ",i," page ",s," url ",n),n)&&t("selection_out",o,RCloud.UI.image_manager.update(n,r,i,s).div())}var n={},r=17;function i(e,o){return function(){!t.apply(null,[e].concat(Array.prototype.slice.call(arguments,0)))&&o&&arguments[arguments.length-1]("context does not support input",null)}}RCloud.register_output_context=function(e){return n[r]=e,r++},RCloud.unregister_output_context=function(e){delete n[e]},RCloud.end_cell_output=function(e,o){t("end",e,o),RCloud.unregister_output_context(e)};var s={browsePath:function(e,t){var o=" "+window.location.protocol+"//"+window.location.host+t+" ";RCloud.UI.help_frame.display_href(o)},browseURL:function(e,t){window.open(t,"_blank")},pager:function(e,t,o,n){for(var r="<h2>"+n+"</h2>\n",i=0;i<t.length;++i)_.isArray(o)&&o[i]&&(r+="<h3>"+o[i]+"</h3>\n"),r+="<pre>"+t[i]+"</pre>";RCloud.UI.help_frame.display_content(r)},editor:function(t,o,n,r){e(0,"what: "+o+"\ncontents:"+n+"\nname: "+r+"\n")},"console.out":i("out"),"console.msg":i("msg"),"console.err":i("err"),"img.url.update":o.bind(null,"img.url.update"),"img.url.final":o.bind(null,"img.url.final"),stdout:e,stderr:e,"html.out":i("html_out"),"deferred.result":i("deferred_result"),compute_terminated:function(){RCloud.UI.fatal_dialog("Your compute session died. Reload the notebook and start a new session?","Reload",function(){editor.load_notebook(shell.gistname(),shell.version())})}};function l(e){e=e.value.json(),s[e[0]]?s[e[0]].apply(null,e.slice(1)):console.log("unknown OOB send arrived: ['"+e[0]+"']"+(s[e[0]]?"":" (unhandled)"))}var a={"console.in":i("in",!0)};function c(e,t){e=e.value.json(),console.log("OOB message arrived: ['"+e[0]+"']"+(a[e[0]]?"":" (unhandled)")),a[e[0]]?(e.push(t),a[e[0]].apply(null,e.slice(1))):t("unhandled",null)}function u(e){var t="Could not initialize session. The GitHub backend might be down or you might have an invalid authorization token. (You could try clearing your cookies, for example).";return e&&(t+="<br />Error: "+e.toString()),t}function d(e){return function(t){if(window.rclient&&rclient.close(),"Authentication required"===t.message)RCloud.session.first_session_?window.location=ui_utils.relogin_uri(e):RCloud.UI.fatal_dialog("Your session has been logged out.","Reconnect",ui_utils.relogin_uri(e));else{var o=t.message||t.error||t;RCloud.UI.fatal_dialog(u(o),"Logout","/logout.R")}throw t}}function f(e,t){return new Promise(function(t,o){rclient=RClient.create({debug:!1,mode:"IDE",host:location.href.replace(/^http/,"ws").replace(/#.*$/,""),on_connect:function(e){t(e)},on_data:l,on_oob_message:c,on_error:function(e){return o(e),!1}}),rclient.allow_anonymous_=e}).then(function(t){return e?function(e){var t,o;return rcloud=RCloud.create(e.rcloud),rcloud.authenticated?(t=rcloud.compute_init(rcloud.username(),rcloud.github_token()),o=rcloud.session_init(rcloud.username(),rcloud.github_token())):(t=rcloud.anonymous_compute_init(),o=rcloud.anonymous_session_init()),t.catch(function(e){RCloud.UI.fatal_dialog(u(e),"Logout","/logout.R")}),o.catch(function(e){RCloud.UI.fatal_dialog(u(e),"Logout","/logout.R")}),Promise.all([t,o])}(t):function(e){if(rcloud=RCloud.create(e.rcloud),!rcloud.authenticated)return Promise.reject(new Error("Authentication required"));var t=rcloud.compute_init(rcloud.username(),rcloud.github_token()),o=rcloud.session_init(rcloud.username(),rcloud.github_token());return Promise.all([t,o])}(t)}).then(function(e){rclient.post_response(e[0])}).catch(t).then(function(){return Promise.all([rcloud.get_conf_value("exec.token.renewal.time").then(function(e){if(e){e*=1e3;var t=function(){rcloud.replace_token($.cookies.get("execToken"),"rcloud.exec").then(function(o){$.cookies.set("execToken",o),setTimeout(t,e)})};setTimeout(t,e)}}),rcloud.display.set_device_pixel_ratio(),rcloud.api.set_url(window.location.href),rcloud.languages.get_list().then(function(e){RCloud.language._set_available_languages(_.omit(e,"r_type","r_attributes"))}),RCloud.UI.image_manager.load_available_formats(),rcloud.init_client_side_data()])})}RCloud.session={first_session_:!0,listeners:[],reset:function(e){return this.first_session_?(this.first_session_=!1,RCloud.UI.with_progress(function(){})):(this.listeners.forEach(function(e){e.on_reset()}),on_connect_error_handler=d(e),RCloud.UI.with_progress(function(){var e=rclient.allow_anonymous_;return rclient.close(),f(e,on_connect_error_handler)}))},init:function(e,t){return this.first_session_=!0,d(),f(e)},on_data:l,on_oob_message:c,invoke_context_callback:t}}(),RCloud.language=function(){var e={CSS:{ace_mode:"ace/mode/css"},JavaScript:{ace_mode:"ace/mode/javascript"},Text:{ace_mode:"ace/mode/text",extension:"txt"},HTML:{ace_mode:"ace/mode/html"}},t=[];return{is_a_markdown:function(t){return!!e[t]&&e[t].is_a_markdown},ace_mode:function(t){var o=e[t]&&e[t].ace_mode||e.Text.ace_mode;return(ace.require(o)||ace.require(e.Text.ace_mode)).Mode},extension:function(t){var o=e[t]&&e[t].extension||"";return _.isArray(o)&&(o=o[0]),o},hljs_class:function(t){return e[t]&&e[t].hljs_class||null},_set_available_languages:function(o){for(var n in t=[],o)t.push(n),e[n]=e[n]||{},e[n].is_a_markdown=o[n]["is.a.markdown"],e[n].ace_mode=o[n]["ace.mode"],e[n].hljs_class=o[n]["hljs.class"],e[n].extension=o[n].extension},available_languages:function(){return t.slice()}}}(),function(){function e(e){if(_.isBoolean(e)||_.isUndefined(e))e={force:!!e};else if(!_.isObject(e))throw new Error("didn't understand options "+e);return(e=$.extend({force:!1},e)).files||(e.files=e.$file?e.$file[0].files:[]),e}RCloud.upload_assets=function(t,o){o=o||{};var n=!1,r={};if((t=e(t)).filenames&&t.files.length===t.filenames.length){n=!0;for(var i=0;i<t.filenames.length;i++)r[t.files[i].name]=t.filenames[i]}return RCloud.utils.promise_sequence(t.files,function(e){return e.size>25e5?Promise.reject(new Error("File "+e.name+" rejected: maximum asset size is 2.5MB")):Promise.promisify(function(e,t){var o=new FileReader;o.onload=function(e){t(null,o.result)},o.onerror=function(e){t(o.error,null)},o.readAsArrayBuffer(e.slice(0,e.size))})(e).then(function(t){if(_.isString(t)&&Notebook.empty_for_github(t))throw new Error("empty");return function(e,t){var n,r=shell.notebook.model.get_asset(e);return r?(o.replace&&o.replace(e),r.content(t),n=shell.notebook.controller.update_asset(r).return(r.controller)):(o.add&&o.add(e),n=shell.notebook.controller.append_asset(t,e).then(function(){return shell.notebook.model.get_asset(e).controller})),n.then(function(e){e.select()})}(n?r[e.name]:e.name,t)})})},RCloud.upload_files=function(t,o){var n=t.upload_ocaps||rcloud._ocaps.file_upload;o=o||{},t=e(t);var r=function(e,t){return Promise.promisify(function(o,n,r){var i=new FileReader,s=o.size,l=0,a=0;t.start&&t.start(o.name),i.readAsArrayBuffer(o.slice(l,l+131072)),i.onload=function(c){var u;if(t.progress&&t.progress(a,s),c.target.result.byteLength>0){var d=new Uint8Array(c.target.result);u=e.writeAsync(d.buffer).then(function(){a+=c.target.result.byteLength,l+=131072,i.readAsArrayBuffer(o.slice(l,l+131072))})}else u=e.closeAsync().then(function(){t.done&&t.done(n,o.name),r(null,!0)});u.catch(function(e){r(e,null)})}})}(n,o);return window.File&&window.FileReader&&window.FileList&&window.Blob?_.isUndefined(t.files)||!t.files.length?Promise.reject(new Error("No files selected!")):n.upload_pathAsync().then(function(e){return RCloud.utils.promise_sequence(t.files,function(e,i){var s=e+"/"+i.name;return n.createAsync(s,t.force).catch(function(e){if(o.confirm_replace&&/exists/.test(e.message))return o.confirm_replace(i.name).then(function(e){return e?n.createAsync(s,!0).return("overwrite"):Promise.resolve(!1)});throw e}).then(function(e){return e?r(i,"overwrite"===e):Promise.resolve(void 0)})}.bind(null,e))}):Promise.reject(new Error("File API not supported by browser."))}}(),RCloud.UI=Object.assign({},RCloud.UI),RCloud.UI.tree=Object.assign({},RCloud.UI.tree),RCloud.UI.addons=Object.assign({},RCloud.UI.addons),RCloud.UI.event=function(e){var t=function(e){this._sender=e,this._listeners=[]};return t.prototype={attach:function(e){this._listeners.push(e)},notify:function(e){var t;for(t=0;t<this._listeners.length;t+=1)this._listeners[t](this._sender,e)}},t}(),RCloud.UI.advanced_menu=function(){var e,t={init:function(){(e=RCloud.UI.menu.create()).init(),d3.rebind(t,e,"add","remove","check","uncheck","enable","create"),RCloud.UI.menus.add({advanced_menu:{sort:5e3,type:"menu",title:"Advanced",modes:["view","edit"],menu:e}}),e.add({open_in_github:{sort:1e3,text:"Open in GitHub",modes:["view","edit"],disabled_reason:"The notebook source does not support a web interface",action:function(){shell.github_url().then(function(e){e?window.open(e,"_blank"):alert("Sorry, Open in GitHub is not supported for this notebook source.")})}},open_from_github:{sort:2e3,text:"Load Notebook by ID",modes:["edit"],action:function(){var e=prompt("Enter notebook ID or github URL:");null!==e&&(e&&""!==e.trim()?shell.open_from_github(e):alert("Please provide Notebook ID."))}},show_source:{sort:9e3,text:"Show Source",checkbox:!0,value:!0,modes:["view"],action:function(e){e?shell.notebook.controller.show_r_source():shell.notebook.controller.hide_r_source()}},publish_notebook:{sort:1e4,text:"Publish Notebook",checkbox:!0,modes:["edit"],disabled_reason:"You can't publish someone else's notebook",action:function(e){function t(e,t){return function(o){o||console.log("Failed to "+(t?"un":"")+"publish notebook "+e)}}e?rcloud.publish_notebook(editor.current().notebook).then(t(editor.current().notebook,!1)):rcloud.unpublish_notebook(editor.current().notebook).then(t(editor.current().notebook,!0))}}})}};return t}(),RCloud.UI.cell_commands=function(){var e;return{create_button:function(e,t,o){var n=ui_utils.fa_button(e,t);return n.click(function(e){$(".tooltip").remove(),$(e.currentTarget).hasClass("button-disabled")||o(n,e)}),{control:n,enable:function(){ui_utils.enable_fa_button(n)},disable:function(){ui_utils.disable_fa_button(n)}}},create_select:function(e,t){var o=$("<select class='form-control cell-control-select'></select>");return o.append.apply(o,e.map(function(e){return $("<option></option>").text(e)})),o.change(function(){var e=o.val();t(e)}),{control:o,enable:function(){o.prop("disabled",!1)},disable:function(){o.prop("disabled","disabled")},set:function(t){if(e.indexOf(t)<0)throw new Error("tried to select unknown value "+t);o.val(t)}}},create_static:function(e,t,o){var n=$("<span><span/>").html(e),r=t?t(n):n;return o&&o(r),{control:r,enable:function(){},disable:function(){},set:function(e){return n.html(e),this},get:function(){return n}}},create_icon:function(e,t,o){var n=this.create_static("<i></i>");return(n=_.extend(n,{icon:function(e){return n.get().find("i").attr("class",e),this},color:function(e){return n.get().find("i").css("color",e),this},title:function(e){return n.get().find("i").attr("title",e),this}})).get().attr("class","state-icon left-indicator"),n.icon(e).color(t),n},init:function(){e=RCloud.extension.create({defaults:{},sections:{above:{filter:RCloud.extension.filter_field("area","above")},cell:{filter:RCloud.extension.filter_field("area","cell")},prompt:{filter:RCloud.extension.filter_field("area","prompt")},left:{filter:RCloud.extension.filter_field("area","left")}}});var t=this;return this.add({insert:{area:"above",sort:1e3,enable_flags:["modify"],create:function(e){return t.create_button("icon-plus-sign","insert cell",function(){var t=shell.insert_cell_before("",e.language(),e.id());t.updatePromise.then(function(){t.controller.edit_source(!0)})})}},join:{area:"above",sort:2e3,enable_flags:["modify"],display_flags:["!first"],create:function(e){return t.create_button("icon-link","join cells",function(){shell.join_prior_cell(e)})}},language_cell:{area:"cell",sort:1e3,enable_flags:["modify"],create:function(e,o){var n=RCloud.language.available_languages();return n.indexOf(e.language())<0&&n.push(e.language()),t.create_select(n,function(t){e.parent_model.controller.change_cell_language(e,t),o.clear_result(),o.edit_source(!0)})}},run:{area:"cell",sort:2e3,create:function(e,o){return t.create_button("icon-play","run",function(t,n){n.shiftKey?shell.run_notebook_from(e.id()):o.execute_cell()})}},edit:{area:"cell",sort:3e3,create:function(e,o){return t.create_button("icon-edit borderable","toggle edit mode",function(){e.parent_model.read_only()?o.toggle_source():o.toggle_edit()})}},results:{area:"cell",sort:3500,create:function(e,o){return t.create_button("icon-picture borderable","show/hide results",function(){o.toggle_results()})}},command_gap:{area:"cell",sort:3500,create:function(e){return t.create_static("&nbsp;")}},split:{area:"cell",sort:4e3,enable_flags:["modify","edit"],create:function(e,o){return t.create_button("icon-unlink","split cell",function(){var t=o.ace_widget();if(t){var n,r,i=t.getSelection().getRange();n=ui_utils.character_offset_of_pos(t,i.start),i.isEmpty()||(r=ui_utils.character_offset_of_pos(t,i.end)),shell.split_cell(e,n,r)}})}},remove:{area:"cell",sort:5e3,enable_flags:["modify"],create:function(e){return t.create_button("icon-trash","remove",function(){e.parent_model.controller.remove_cell(e)})}},selection:{area:"left",sort:1250,display_flags:["modify"],create:function(e){return t.create_static("<input type='checkbox'></input>",function(e){return $("<span class='cell-selection'>").append(e)},function(t){t.click(function(t){e.parent_model.controller.select_cell(e,{is_toggle:!t.shiftKey,is_range:t.shiftKey})})})}},left_gap:{area:"left",sort:1500,display_flags:["!modify"],create:function(e){return t.create_static("&nbsp;")}},run_state:{area:"left",sort:2e3,create:function(e){return t.create_icon("icon-circle-blank","#777")}},cell_number:{area:"left",sort:3e3,display_flags:["cell-numbers"],create:function(e){return t.create_static(e.id(),function(e){return $("<span class='left-indicator cell-number'></span>").append("cell ",e)},function(e){})}}}),this},add:function(t){return e&&e.add(t),this},remove:function(t){return e&&e.remove(t),this},decorate:function(t,o,n,r){return function(t,o,n,r){var i=e.create(t,n,r);i.array.forEach(function(e){e.control.addClass("cell-control")});var s={};return o.append.apply(o,_.pluck(i.array,"control")),{controls:i.map,set_flag:function(o,n){var r=function(e){var t;return"!"==e.substr(0,1)&&(t=!0,e=e.substr(1)),t^s[e]};s[o]=n,e.entries(t).forEach(function(e){_.every(e.enable_flags,r)?i.map[e.key].enable():i.map[e.key].disable(),_.every(e.display_flags,r)?i.map[e.key].control.show():i.map[e.key].control.hide()})}}}(t,o,n,r)}}}(),RCloud.UI.column=function(e){var t;function o(e){return"col-md-"+e+" col-sm-"+e}return{init:function(){var o=$(e);0!==o.length&&o.attr("class").split(/\s+/).forEach(function(e){var o=/^col-(?:md|sm)-(\d+)$/.exec(e);if(o)if(o=+o[1],void 0===t)t=o;else if(t!==o)throw new Error("mismatched col-md- or col-sm- in column classes")})},colwidth:function(n){return _.isUndefined(n)||n==t||($(e).removeClass(o(t)).addClass(o(n)),t=n),t}}},RCloud.UI.collapsible_column=function(e,t,o){var n=!1,r=RCloud.UI.column(e),i=r.init.bind(r),s=r.colwidth.bind(r);function l(){return $(t+" > .panel > div.panel-collapse:not(.out)")}function a(e,t,o){if(e.data("would-collapse")==t)return!1;if(e.data("would-collapse",t),o&&rcloud.config&&e.length){var n="ui/"+e[0].id;rcloud.config.set_user_option(n,t)}return!0}function c(){return $.makeArray(l()).every(function(e){return $(e).hasClass("out")||!0===$(e).data("would-collapse")})}function u(e){return e.replace("#","ui/")}return $(t).data("collapsible-column",r),_.extend(r,{init:function(){var e=this;i(),l().each(function(){$(this).data("would-collapse",!$(this).hasClass("in")&&!$(this).hasClass("out"))}),$(t+" > .panel > div.panel-heading").click(function(){var t=$(this.dataset.target);return e.collapse(t,t.hasClass("in")),!1}),l().on("size-changed",function(){e.resize(!0)}),l().on("shown.bs.collapse",function(){var e=$(this).find("iframe");if(e)for(var t=0;t<e.length;t++){var o=e.get(t);o.contentDocument&&o.contentDocument.location&&o.contentDocument.location.reload(!0)}}),$(o).click(function(){n?e.show(!0):e.hide(!0)})},load_options:function(){var e=this,o=$.makeArray(l()).map(function(e){return"#"+e.id});o.push(t);var n=o.map(u);return rcloud.config.get_user_option(n).then(function(o){var n;for(var r in o){var i=r.replace("ui/","#");i===t?n=o[r]:"boolean"==typeof o[r]&&a($(i),o[r],!1)}var s=!1;void 0===n&&(n=!1,s=!0),n?e.hide(s):e.show(s)})},colwidth:function(e){return e=s(e),l().trigger("panel-resize"),e},collapse:function(e,t,o){if(void 0===o&&(o=!0),n)return l().each(function(){this===e[0]?a($(this),!1,o):a($(this),!0,o)}),void this.show(!0);var r=a(e,t,o);c()?this.hide(o,!r):this.show(o,!r)},resize:function(o){if(!o){var n=this.calcwidth();this.colwidth(n)}RCloud.UI.middle_column.update();var r={},i={},s=l(),a=(s.length,null);s.each(function(){if(!$(this).hasClass("out")&&!$(this).data("would-collapse")){var e=$(this).data("panel-sizer"),t=e?e(this):RCloud.UI.collapsible_column.default_sizer(this);r[this.id]=t.height,i[this.id]=t.padding,a||"greedy"!==$(this).attr("data-widgetheight")||(a=$(this))}});var c=$(e).height(),u=d3.sum($(t+" .panel-heading").map(function(e,t){return $(t).outerHeight()}));for(var d in c-=u,i)c-=i[d];var f=c,h=!1;for(d in r)f-=r[d];if(f>=0)null!==a&&(r[a.get(0).id]+=f,h=!0);else{f=c;for(var p,m=_.keys(r),g=!1,v=f/m.length;m.length&&!g;){for(g=!0,p=0;p<m.length;++p)r[m[p]]<v&&(f-=r[m[p]],m.splice(p,1),--p,g=!1);v=f/m.length}for(p=0;p<m.length;++p)r[m[p]]=v;h=!0}for(d in r){$el=$("#"+d);var b=$el.find(".panel-fixed-header");if(b.length){var y=b.outerHeight();$el.find(".panel-scrollable-content").height(r[d]-y)}else $el.find(".panel-body").height(r[d]);$el.trigger("panel-resize")}$(t+" .panel-shadow").each(function(e){var t=$(this).parent().find(".panel-body").outerHeight();0===t&&(t="100%"),$(this).attr("height",t)});var k=$(e).height(),w=d3.sum(_.values(i))+d3.sum(_.values(r))+u;h&&k!=w&&console.log("Error in vertical layout algo: filling "+k+" pixels with "+w)},hide:function(e,r){l().each(function(){var e=$(this).data("heading-content-selector");e&&e.hide()}),$(t+" > .panel > div.panel-collapse:not(.collapse):not(.out)").collapse("hide"),$(o+" i").removeClass("icon-minus").addClass("icon-plus"),$(o).attr("title","Expand Pane"),n=!0,this.resize(r),e&&rcloud.config&&rcloud.config.set_user_option(u(t),!0)},show:function(e,r){l().each(function(){var e=$(this).data("heading-content-selector");e&&e.show()}),c()&&a($(l()[0]),!1,!0),l().each(function(){$(this).collapse($(this).data("would-collapse")?"hide":"show")}),$(o+" i").removeClass("icon-plus").addClass("icon-minus"),$(o).attr("title","Collapse Pane"),n=!1,this.resize(r),e&&rcloud.config&&rcloud.config.set_user_option(u(t),!1)},calcwidth:function(){if(n)return 1;var e=[];return l().each(function(){var t=$(this).data("would-collapse")?1:$(this).attr("data-colwidth");t>0&&e.push(t)}),d3.max(e)}}),r},RCloud.UI.collapsible_column.default_padder=function(e){var t=$(e),o=t.find(".panel-body"),n=o.find(".panel-fixed-header"),r=o.find(".panel-scrollable-content");return t.outerHeight()-t.height()+o.outerHeight()-o.height()+(n.length?r.outerHeight()-r.height():0)},RCloud.UI.collapsible_column.default_sizer=function(e){var t=$(e).find(".widget-vsize").height();return padding=RCloud.UI.collapsible_column.default_padder(e),{height:t,padding:padding}},RCloud.UI.column_sizer={init:function(){$(".notebook-sizer").draggable({axis:"x",opacity:.75,zindex:1e4,revert:!0,revertDuration:0,grid:[window.innerWidth/12,0],stop:function(e,t){var o,n,r=window.innerWidth/12;if($(this).hasClass("left"))o=Math.round(t.position.left/r),1===(n=Math.max(1,Math.min(+RCloud.UI.left_panel.colwidth()+o,11-RCloud.UI.right_panel.colwidth())))?RCloud.UI.left_panel.hide(!0,!0):RCloud.UI.left_panel.show(!0,!0),RCloud.UI.left_panel.colwidth(n),RCloud.UI.middle_column.update();else{if(!$(this).hasClass("right"))throw new Error("unexpected shadow drag with classes "+$(this).attr("class"));o=Math.round(t.position.left/r)-RCloud.UI.middle_column.colwidth(),1===(n=Math.max(1,Math.min(+RCloud.UI.right_panel.colwidth()-o,11-RCloud.UI.left_panel.colwidth())))?RCloud.UI.right_panel.hide(!0,!0):RCloud.UI.right_panel.show(!0,!0),RCloud.UI.right_panel.colwidth(n),RCloud.UI.middle_column.update()}$(this).css({left:"",right:"",top:""})}}),$(window).resize(function(){var e=window.innerWidth/12;$(".notebook-sizer").draggable("option","grid",[e,0])})}},RCloud.UI.command_prompt=function(){var e,t,o=!1,n=!0,r=null,i=null,s=null,l=null;function a(){var e=$("#prompt-area"),t=$("#command-prompt"),r=$("#prompt-area .cell-status .cell-control-bar");n?e.hide():(e.show(),o?(t.show(),r.removeClass("flipped")):(t.hide(),r.addClass("flipped")))}var c={init:function(){RCloud.UI.cell_commands.add({insert_prompt:{area:"prompt",modifying:!0,sort:1e3,create:function(){return RCloud.UI.cell_commands.create_button("icon-plus","insert new cell",function(){var e=shell.new_cell("",s);e.updatePromise.then(function(){e.controller.edit_source(!0)})})}},language_prompt:{area:"prompt",modifying:!0,sort:2e3,create:function(){return RCloud.UI.cell_commands.create_select(RCloud.language.available_languages(),function(e){window.localStorage.last_cell_lang=e,RCloud.UI.command_prompt.language(e,!0)})}}});var o=$(RCloud.UI.panel_loader.load_snippet("command-prompt-snippet"));$("#rcloud-cellarea").append(o);var n=$("#prompt-area .cell-control-bar");l=RCloud.UI.cell_commands.decorate("prompt",n),r=function(){var e=[],t=[],o=0;function n(){return t[o]||(o<e.length?e[o]:"")}var r=null;return{init:function(){r="rcloud.history."+shell.gistname()+".";var i=0;e=[],t=[];for(var s=window.localStorage.last_cell_lang||"R";;){var l=window.localStorage[r+i],a=window.localStorage[r+i+".alt"];if(void 0!==a&&(t[i]=a),void 0===l)break;e.push(l),++i}return o=e.length,{cmd:n(),lang:s}},add_entry:function(n){""!==n&&(t[e.length]=null,e.push(n),t[o]=null,o=e.length,window.localStorage[r+(o-1)]=n)},has_last:function(){return o>0},last:function(){return o>0&&--o,n()},has_next:function(){return o<e.length},next:function(){return o<e.length&&++o,n()},change:function(e){window.localStorage[r+o+".alt"]=t[o]=e}}}(),i=function(){var o=$("#command-prompt");if(!o.length)return null;function n(){o.css({height:ui_utils.ace_editor_height(i,5)+6+"px"}),i.resize(),shell.scroll_to_end(0)}o.css({"background-color":"#fff"}),o.addClass("r-language-pseudo"),ace.require("ace/ext/language_tools");var i=ace.edit(o[0]);i.$blockScrolling=1/0,e=i,n(),ace.require("ace/mode/r").Mode;var l=i.getSession();t=l,l.doc,i.setOptions({enableBasicAutocompletion:!0}),l.on("change",n),i.setTheme("ace/theme/chrome"),l.setNewLineMode("unix"),l.setOption("indentedSoftWrap",!1),l.setUseWrapMode(!0),i.resize();var a=ui_utils.ignore_programmatic_changes(i,r.change.bind(r));function u(e,t,o){var n=l.getValue();if(n.length){RCloud.UI.command_prompt.history().add_entry(n);var r=shell.new_cell(n,s);shell.scroll_to_end(),r.controller.enqueue_execution_snapshot(r.updatePromise),a("")}}function d(e){return e.getSession().getDocument().getLength()-1}function f(e,t){return e.getSession().getDocument().getLine(t).length}ui_utils.install_common_ace_key_bindings(i,c.language.bind(c));var h=i.commands.commandKeyBinding.up,p=i.commands.commandKeyBinding.down;return i.commands.addCommands([{name:"execute",bindKey:{win:"Return",mac:"Return",sender:"editor"},exec:u},{name:"execute-2",bindKey:{win:"Alt-Return",mac:"Alt-Return",sender:"editor"},exec:u},{name:"up-with-history",bindKey:"up",exec:function(e,t,o){var n=e.getCursorPositionScreen();if(n.row>0)h.exec(e,t,o);else if(r.has_last()){a(r.last());var i=e.getSession().getScreenLength();ui_utils.ace_set_pos(e,i,n.column)}else ui_utils.ace_set_pos(e,0,0)}},{name:"down-with-history",bindKey:"down",exec:function(e,t,o){var n=e.getCursorPositionScreen(),i=e.getSession().getScreenLength();n.row<i-1?p.exec(e,t,o):r.has_next()?(a(r.next()),ui_utils.ace_set_pos(e,0,n.column)):(i=d(e),ui_utils.ace_set_pos(e,i,f(e,i)))}},{name:"blurCell",bindKey:{win:"Escape",mac:"Escape"},exec:function(){e.blur()}}]),i.commands.removeCommands(["find","replace"]),ui_utils.customize_ace_gutter(i,function(e){return 0===e?"&gt;":"+"}),{widget:i,restore:function(){var e=r.init();if(!_.contains(RCloud.language.available_languages(),e.lang)){var t=RCloud.language.available_languages()[0];console.error("Language "+e.lang+" is not available. Using "+t+" to restore prompt widget."),e={cmd:"",lang:t}}a(e.cmd),c.language(e.lang);var o=d(i);ui_utils.ace_set_pos(i,o,f(i,o))},set_language:function(e){var t=RCloud.language.ace_mode(e);l.setMode(new t({suppressHighlighting:!1,doc:l.doc,session:l,language:e})),i.focus()}}}()},history:function(){return r},show_prompt:function(e){return arguments.length?(o=e,a(),this):o},readonly:function(e){return arguments.length?(n=e,a(),this):n},language:function(e,t){return void 0===e?s:(s=e,t||l.controls.language_prompt.set(s),i.set_language(s),this)},focus:function(){i&&(i.widget.focus(),i.restore())},ace_widget:function(){return e},get_selection:function(){return o?t.doc.getTextRange(e.selection.getRange()):void 0}};return c}(),RCloud.UI.comments_frame=function(){var e=!1;var t={body:function(){return RCloud.UI.panel_loader.load_snippet("comments-snippet")},init:function(){var e=this,t=$("#comment-entry-body"),o=0,n="";$("#comment-submit").click(function(){return Notebook.empty_for_github(t.val())||(e.post_comment(_.escape(t.val())),t.height("41px")),!1}),t.keydown(function(r){if(r.keyCode==$.ui.keyCode.ENTER&&(r.ctrlKey||r.metaKey))return Notebook.empty_for_github(t.val())||(e.post_comment(_.escape(t.val())),t.height("41px"),o=0,n=""),!1;t.bind("input",function(){return o>1&&n!=t[0].scrollHeight&&t.height(t[0].scrollHeight+"px"),o+=1,n=t[0].scrollHeight,$("#comments-qux").animate({scrollTop:$(document).height()},"slow"),!1})})},set_foreign:function(t){t?($("#comment-entry").hide(),$("#comments-not-allowed").show()):($("#comment-entry").show(),$("#comments-not-allowed").hide()),e=t},display_comments:function(){return rcloud.get_all_comments(shell.gistname()).then(function(o){!function(o){try{o=JSON.parse(o)}catch(e){return void RCloud.UI.session_pane.post_error("populate comments: "+e.message)}var n=rcloud.username(),r=function(t){return t.user.login===n&&!e};d3.select("#comment-count").text(String(o.length)),d3.select("#comments-container").selectAll("div").remove();var i=d3.select("#comments-container").selectAll("div").data(o).enter().append("div").attr("class","comment-container").on("mouseover",function(e){r(e)&&$(".comment-header-close",this).show()}).on("mouseout",function(e){$(".comment-header-close",this).hide()}).attr("comment_id",function(e){return e.id});i.append("div").attr("class","comment-header").style({"max-width":"30%"}).text(function(e){return e.user.login}),i.append("div").attr("class","comment-body").style({"max-width":"70%"}).append("div").attr("class","comment-body-wrapper").append("div").attr("class","comment-body-text").text(function(e){return e.body}).each(function(e){var o=$(this),n={change:function(n){var r=o.html();t.modify_comment(e.id,r)},allow_multiline:!0,validate:function(e){return!Notebook.empty_for_github(e)}};ui_utils.editable(o,$.extend({allow_edit:r(e),inactive_text:o.text(),active_text:o.text()},n))}),d3.selectAll(".comment-body-wrapper",this).append("i").attr("class","icon-remove comment-header-close").style({"max-width":"5%"}).on("click",function(e,o){r(e)&&t.delete_comment(e.id)}),$("#collapse-comments").trigger("size-changed"),ui_utils.on_next_tick(function(){ui_utils.scroll_to_after($("#comments-qux"))})}(o)})},post_comment:function(e){return e=JSON.stringify({body:e}),rcloud.post_comment(shell.gistname(),e).then(this.display_comments.bind(this)).then(function(){$("#comment-entry-body").val("")})},modify_comment:function(e,t){return t=JSON.stringify({body:t}),rcloud.modify_comment(shell.gistname(),e,t).then(this.display_comments.bind(this))},delete_comment:function(e){return rcloud.delete_comment(shell.gistname(),e).then(this.display_comments.bind(this))}};return t}(),RCloud.UI.configure_readonly=function(){var e=$("#readonly-notebook"),t=RCloud.UI.navbar.control("revert_notebook"),o=RCloud.UI.navbar.control("save_notebook");shell.notebook.controller.is_mine()?shell.notebook.model.read_only()?(t&&t.show(),o&&o.hide()):(t&&t.hide(),o&&o.show()):(t&&t.hide(),o&&o.hide()),shell.notebook.model.read_only()?(RCloud.UI.command_prompt.readonly(!0),RCloud.UI.selection_bar.hide(),e.show(),$("#output").sortable("disable"),$("#upload-to-notebook").prop("checked",!1).attr("disabled",!0),RCloud.UI.scratchpad.set_readonly(!0),RCloud.UI.find_replace.hide_replace()):(RCloud.UI.command_prompt.readonly(!1),RCloud.UI.selection_bar.show(),e.hide(),$("#output").sortable("enable"),$("#upload-to-notebook").prop("checked",!1).removeAttr("disabled"),RCloud.UI.scratchpad.set_readonly(!1))},function(){var e,t,o,n,r;RCloud.UI.fatal_dialog=function(i,s,l){if($("#loading-animation").hide(),r=l,_.isUndefined(e)){o=$("<button type='submit' class='btn btn-primary' style='float:right'>"+s+"</span>"),n=$("<span class='btn' style='float:right'>Ignore</span>");var a=$("<div />").append("<h1>Aw, shucks</h1>");(t=$('<p style="white-space: pre-wrap"></p>')).append(ui_utils.expandable_error(i)),a.append(t,o),a.append(n),a.append('<div style="clear: both;"></div>'),o.click(function(t){t.preventDefault(),_.isString(r)?window.location=r:_.isFunction(r)?(e.modal("hide"),r()):e.modal("hide")}),n.click(function(){e.modal("hide")}),e=$('<div id="fatal-dialog" class="modal fade" />').append($('<div class="modal-dialog" />').append($('<div class="modal-content" />').append($('<div class="modal-body" />').append(a)))),$("body").append(e),e.on("shown.bs.modal",function(){o.focus()})}e.modal({keyboard:!1})}}(),RCloud.UI.find_replace=function(){var e,t,o,n,r,i,s,l,a,c,u,d,f,h,p,m,g,v,b=null,y=!1,k=!1,w=null,C=null,x=!1,R=[],I=0,U=!1;function E(e,I){function E(e){if(e.keyCode===$.ui.keyCode.ENTER||!ui_utils.is_a_mac()&&114===e.keyCode)return e.preventDefault(),e.stopPropagation(),e.shiftKey?F():z(),!1}_.isUndefined(I)&&(I={}),U=e;var S=b&&"none"!==b.css("display");if(!b){var P=$(_.template($("#find-in-notebook-snippet").html())({}));$("#middle-column").prepend(P),b=$(P.get(0)),t=P.find("#find-form"),o=P.find("#find-details"),n=P.find("#find-input"),c=P.find("#match-case-opt"),u=P.find("#match-word-opt");var N=P.find("#find-options-menu");r=P.find("#match-status"),i=P.find("#match-index"),s=P.find("#match-total"),d=P.find("#find-next"),f=P.find("#find-last"),l=P.find("#replace-input"),h=P.find("#replace"),p=P.find("#replace-all"),a=P.find(".replace"),m=P.find("#find-close");var T=function(e){$(".dropdown-menu").each(function(e,t){$(t).is(":visible")&&$(t.parentElement).find(".dropdown-toggle").dropdown("toggle")})},D=function(e){e.get(0).checked?$("#find-options-menu > .btn").addClass("active"):$("#find-options-menu > .btn").removeClass("active")};n.on("change",function(e){e.preventDefault(),e.stopPropagation(),A()}),N.on("hide.bs.dropdown",function(e){var t=$(e.target).find("[data-keepOpen='true']");return!t.length||(t.each(function(e,t){$(t).attr("data-keepOpen",!1)}),!1)}),N.find(".checkbox").on("click",function(e){$(this).attr("data-keepOpen",!0)}),c.on("change",function(e){D(c),A()}),u.on("change",function(e){D(u),A()}),o.click(function(){n.focus()}),n.click(function(e){e.stopPropagation(),T()}),-1===navigator.userAgent.toLowerCase().indexOf("firefox")&&(t.on("focusout",function(e){setTimeout(function(){0===$(document.activeElement).closest(t).length&&(x=!1,O())},100)}),t.on("focusin",function(e){x||(shell.save_notebook(),A(n.data("searchagain")?g:void 0)),x=!0})),d.click(function(e){return e.preventDefault(),e.stopPropagation(),T(),z(),!1}),f.click(function(e){return e.preventDefault(),e.stopPropagation(),T(),F(),!1}),h.click(function(e){e.preventDefault(),e.stopPropagation(),T(),K()}),p.click(function(e){return e.preventDefault(),e.stopPropagation(),T(),H(),!1}),C=["find-input","find-last","find-next","replace-input","replace","replace-all"],(w=["find-input","find-last","find-next"]).push("find-close"),C.push("find-close"),n.keydown(E),l.keydown(E),t.keydown(function(e){switch(e.keyCode){case $.ui.keyCode.TAB:e.preventDefault(),e.stopPropagation();var t=k?C:w,o=t.indexOf(e.target.id)+t.length;return e.shiftKey?--o:++o,o%=t.length,$("#"+t[o]).focus(),!1;case $.ui.keyCode.ESCAPE:j()}}),t.find("input").focus(function(){window.setTimeout(function(){this.select()}.bind(this),0)}),m.click(function(){j()})}if(b.show(),e?a.show():a.hide(),v||(v=setInterval(function(){var e=n.data("value"),t=n.val();t!==e&&(A(),n.data("value",t))},250)),!y){var L=function(){var e=B();if(e)return e.views[0].get_selection();return RCloud.UI.command_prompt.ace_widget()&&RCloud.UI.command_prompt.ace_widget().textInput.isFocused()?RCloud.UI.command_prompt.get_selection():null}();if(null!==L)n.val(L);else{ui_utils.select_allowed_elements();var M=window.getSelection().toString();M&&n.val(M)}}if(A(I.search_again?g:void 0),I&&I.search_again){var q,G,Q=function(e){var t=B();if(!t)return;var o=t.views[0].ace_widget(),n=o.getSelectionRange();return{cell_index:t.index,cursor_index:o.session.doc.positionToIndex(e?n.end:n.start)}}(I.next);if(R.length&&Q)(G=_.find(R,function(e){return e.index===Q.cell_index&&e.begin>=Q.cursor_index||e.index>Q.cell_index}))?(q=R.findIndex(function(e){return e.begin===G.begin&&e.end===G.end&&e.index===G.index}),I.previous&&(q-=1)<0&&(q=R.length-1)):R.length&&(q=I.next?0:R.length-1),A(q)}y&&(I.next?z():I.previous&&F()),e&&S?l.focus():n.focus(),y=!0,k=e}function A(e){var t;g=void 0,findOpts={filter:n.val(),matchCase:c.get(0).checked,matchWord:u.get(0).checked},D(findOpts),M(),n.val().length?(g=_.isUndefined(e)?0:e,r.css("visibility","visible"),L("activate")):(g=void 0,P()),t=0===R.length?"0":_.isUndefined(e)?"1":(e+1).toString(),r[0===R.length?"addClass":"removeClass"]("no-matches"),N(t,R.length)}function S(){return 0!==R.length&&!isNaN(g)}function P(){r.css("visibility","hidden")}function N(e,t){i.text(e),s.text(t)}function O(){P(),g=void 0,D(null),M(),y=!1}function j(){if(!shell.notebook.model.read_only()){var e=R[g];if(e&&shell.notebook.model.cells[e.index])shell.notebook.model.cells[e.index].views[0].select_highlight_range(e.begin,e.end)}n.data("searchagain",n.val()),clearInterval(v),v=null,O(),b.hide()}function T(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function D(t){if(t&&t.filter&&t.filter.length>0){var o="g";t.matchCase||(o+="i");var n=T(t.filter);I=0,t.matchWord&&(n="\\b("+n+")\\b",I=1),e=new RegExp(n,o)}else e=null}function B(){var e=_.find(shell.notebook.model.cells,function(e){return!_.isUndefined(e.views[0].ace_widget())&&e.views[0].ace_widget().textInput.isFocused()});if(e)for(var t=0;shell.notebook.model.cells.length;t++)if(shell.notebook.model.cells[t].filename()===e.filename()){e.index=t;break}return e}function L(e){if(S()){var t=R[g];if(t){switch(e){case"replace":t.kind="replaced";break;case"activate":t.kind="replaced"===t.kind?"activereplaced":"active";break;case"deactivate":t.kind="activereplaced"===t.kind?"replaced":"normal"}!function(e){var t=R.filter(function(t){return t.filename===e.filename});shell.notebook.model.cells[e.index].notify_views(function(e){e.change_highlights(t)})}(t)}}}function M(){shell.is_view_mode()&&shell.notebook.controller.show_r_source(),R=[],shell.notebook.model.cells.forEach(function(t,o){var n=function(t){var o=[];if(e)for(var n,r=t.content();n=e.exec(r);){var i=n[0].indexOf(n[I]);o.push({begin:n.index+i,end:n.index+n[I].length+i,kind:o.length===g?"active":"normal"}),n.index===e.lastIndex&&++e.lastIndex}return t.notify_views(function(e){e.change_highlights(o)}),o}(t);R.push.apply(R,function(e,t,o){return e.map(function(e){return _.extend({index:o,filename:t.filename()},e)})}(n,t,o))})}function z(e){L(e||"deactivate"),S()?N((g=(g+R.length+1)%R.length)+1,R.length):g=0,L("activate")}function F(){L("deactivate"),S()?N((g=(g+R.length-1)%R.length)+1,R.length):g=0,L("activate")}function K(){if(S()){var e=q();e&&shell.notebook.controller.update_cell(e).then(function(){z("replace")})}else z();return!1}function q(){if(!S())return null;var e=R[g],t=shell.notebook.model.cells[e.index],o=t.content(),n=o.substring(0,e.begin),r=o.substring(e.end),i=l.val(),s=i.length+e.begin-e.end;e.begin=n.length,e.end=n.length+i.length;for(var a=g+1;a<R.length&&R[a].filename===e.filename;++a)R[a].begin+=s,R[a].end+=s;return t.content(n+i+r)?t:null}function H(){return S()?(L("deactivate"),function(){var e=shell.notebook.model.reread_buffers();for(;g<R.length;){var t=q();L("replace"),t&&e.push.apply(e,shell.notebook.model.update_cell(t)),++g}g=void 0,shell.notebook.controller.apply_changes(e)}()):function(e,t){if(M(),!e||!e.length)return;e=T(e);var o=new RegExp(e,"g"),n=shell.notebook.model.reread_buffers();shell.notebook.model.cells.forEach(function(e){var r=e.content(),i=r.replace(o,t);e.content(i)&&n.push.apply(n,shell.notebook.model.update_cell(e))}),shell.notebook.controller.apply_changes(n)}(n.val(),l.val()),!1}return{init:function(){RCloud.UI.shortcut_manager.add([{category:"Search/Replace",id:"notebook_find",description:"Find text",keys:{mac:[["command","f"]],win:[["ctrl","f"]]},action:function(){E(!1)}},{category:"Search/Replace",id:"notebook_find_next",description:"Find text (next)",keys:{mac:[["command","g"]],win:[["ctrl","g"],["f3"]]},action:function(){E(!1,{next:!0,search_again:!0})}},{category:"Search/Replace",id:"notebook_find_previous",description:"Find text (previous)",keys:{mac:[["command","shift","g"]],win:[["ctrl","shift","g"],["shift","f3"]]},action:function(){E(!1,{previous:!0,search_again:!0})}},{category:"Search/Replace",id:"notebook_replace",description:"Replace text",keys:{mac:[["command","option","f"]],win:[["ctrl","h"]]},modes:["writeable"],action:function(){E(!shell.notebook.model.read_only())}},{category:"Search/Replace",id:"notebook_replace_text_match",description:"Replace next match",keys:{win_mac:[["alt","r"]]},modes:["writeable"],element_scope:"#find-form",action:function(){U&&K()}},{category:"Search/Replace",id:"notebook_replace_text_all",description:"Replace all matches",keys:{win_mac:[["alt","a"]]},modes:["writeable"],element_scope:"#find-form",action:function(){U&&H()}},{category:"Search/Replace",id:"notebook_goto_previous_match",description:"Go to previous search match",keys:{mac:[["shift","enter"]],win:[["shift","enter"],["shift","f3"]]}},{category:"Search/Replace",id:"notebook_goto_next_match",description:"Go to next search match",keys:{mac:[["enter"]],win:[["enter"],["f3"]]}}])},hide_replace:function(){a&&a.hide()},clear_highlights:function(){O()}}}(),RCloud.UI.shortcut_manager=function(){var e;function t(t){return _.find(e.sections.all.entries,function(e){return e.id===t})}function o(e,o){_.isArray(e)||(e=[e]),_.each(e,function(e){var n=t(e);n&&o(n)})}function n(e){return e.enabled&&_.contains(e.modes,shell.notebook.model.read_only()?"readonly":"writeable")&&_.contains(e.on_page,shell.is_view_mode()?"view":"edit")&&(!_.isFunction(e.is_active)||_.isFunction(e.is_active)&&e.is_active())}return{init:function(){return window.Mousetrap.prototype.stopCallback=function(e,t,o){return(!(e.metaKey||e.ctrlKey||e.altKey||114===e.keyCode)||!["mousetrap","ace_text-input"].some(function(e){return(" "+t.className+" ").indexOf(" "+e+" ")>-1}))&&("INPUT"==t.tagName&&"checkbox"!==t.type||"SELECT"==t.tagName||"TEXTAREA"==t.tagName||t.contentEditable&&"true"==t.contentEditable)},e=RCloud.extension.create({}),this.add([]),this},add:function(o){var r,i,s,l;return e&&e.add((r=o,s={},l=e.sections.all.entries,i=_.isArray(r)?r:[r],_.each(i,function(e){var o=!0,r=_.defaults(e,{category:"General",modes:["writeable","readonly"],on_page:["view","edit"],ignore_clash:!1,enable_in_dialogs:!1,enabled:!0}),i=ui_utils.is_a_mac();if(e.keys&&(e.keys.hasOwnProperty("win_mac")?e.bind_keys=e.keys.win_mac:e.bind_keys=e.keys[i?"mac":"win"]),e.click_keys&&(e.click_keys.hasOwnProperty("win_mac")?e.click_keys.keys=e.click_keys.win_mac:(e.click_keys.hasOwnProperty("win")||e.click_keys.hasOwnProperty("mac"))&&(e.click_keys.keys=e.click_keys[i?"mac":"win"])),e.bind_keys&&e.bind_keys.length||e.click_keys){if(r.key_desc=[],e.bind_keys)for(var a=0;a<e.bind_keys.length;a++){var c=_.chain(e.bind_keys[a]).map(function(e){return e.toLowerCase()}).sortBy(function(e){return{command:1,ctrl:2,shift:3}[e]}).value();r.key_desc.push(c.join("+"))}if(!r.ignore_clash)for(var u=0;u<l.length;u++)if(!l[u].ignore_clash&&_.intersection(l[u].key_desc,r.key_desc).length>0){console.warn('Keyboard shortcut "'+r.description+'" cannot be registered because its keycode clashes with an existing shortcut id "'+l[u].id+'" in the "'+l[u].category+'" category.'),o=!1;break}o&&(_.isUndefined(e.action)?r.create=function(){}:r.create=function(){_.each(r.key_desc,function(o){var i=function(o){if(n(t(r.id))){var i=!0;if(!e.enable_in_dialogs&&$(".modal").is(":visible")&&(i=!1),e.element_scope){var s=$(e.element_scope),l=$(":focus");i=!(!s.length||!l.length)&&$.contains(s.get(0),l.get(0))}i&&(o.preventDefault(),e.action(o))}};r.global?window.Mousetrap.bindGlobal(o,i):window.Mousetrap().bind(o,i)})},o&&(s[e.id]=r,l.push(r)))}}),s)),this},load:function(){e&&e.create("all")},disable:function(e){o(e,function(e){e.enabled=!1})},disable_all:function(){this.disable(_.pluck(e.sections.all.entries,"id"))},enable:function(e){o(e,function(e){e.enabled=!0})},get_registered_shortcuts_by_category:function(t){var o=_.map(t,function(e,t){return{key:e,value:t+1}});o=_.object(_.pluck(o,"key"),_.pluck(o,"value"));var r=_.filter(_.sortBy(e.sections.all.entries,function(e){return e.category+e.description}),function(e){return n(e)});return _.sortBy(_.map(_.chain(r).groupBy("category").value(),function(e,t){return{category:t,shortcuts:e}}),function(e){return o[e.category]})}}}(),RCloud.UI.shortcut_dialog=function(){var e=[];return{show:function(){$("#loading-animation").hide();var t=[];e&&(e=RCloud.UI.shortcut_manager.get_registered_shortcuts_by_category(["Code Editor","Code Prompt","Cell Management","Notebook Management","Search/Replace","General"]));var o=function(e){var t=_.findWhere([{initial:"option",replace_with:"opt"},{initial:"command",replace_with:"cmd"}],{initial:e});return t?t.replace_with:e};_.each(e,function(e){var n={name:e.category,shortcuts:[]};_.each(e.shortcuts,function(e){var t={description:e.description,keys:[]};_.each(e.bind_keys,function(e){e=_.map(e,function(e){return o(e)}),t.keys.push(e.join(" "))}),e.click_keys&&t.keys.push({keys:_.map(e.click_keys.keys,function(e){return o(e)}).join(" "),target:e.click_keys.target}),n.shortcuts.push(t)}),t.push(n)});var n=_.template($("#shortcut_dialog_content_template").html())({categories:t});$("#shortcut-content").html(n),$("#shortcut-dialog").modal({keyboard:!1})}}}(),RCloud.UI.ace_shortcuts={init:function(){var e=[{category:"Code prompt",id:"code_prompt_execute",description:"Create cell and execute code",keys:{win_mac:[["enter"],["alt","enter"]]}},{category:"Code prompt",id:"code_prompt_history_back",description:"Go back in code history",keys:{win_mac:[["up"]]}},{category:"Code prompt",id:"code_prompt_history_forwards",description:"Go forwards in code history",keys:{win_mac:[["down"]]}},{category:"Code Editor",id:"code_editor_execute",description:"Execute code",keys:{win_mac:[["alt","enter"]]}},{category:"Code Editor",id:"code_editor_autocomplete",description:"Suggest autocompletion",keys:{win_mac:[["ctrl","."],["tab"]]}},{category:"Code Editor",id:"code_editor_execute_selection_or_line",description:"Execute selection or line",keys:{mac:[["command","enter"]],win:[["ctrl","enter"]]}},{category:"Code Editor",id:"code_editor_cursor_start_of_line",description:"Cursor at beginning of line",keys:{mac:[["ctrl","a"]]}},{category:"Code Editor",id:"code_editor_cursor_end_of_line",description:"Cursor at end of line",keys:{mac:[["ctrl","e"]]}},{category:"Code Editor",id:"ace_remove_line",description:"Remove line",keys:{mac:[["cmd","d"]],win:[["ctrl","d"]]}},{category:"Code Editor",id:"ace_copy_lines_down",description:"Copy lines down",keys:{mac:[["cmd","option","down"]],win:[["alt","shift","down"]]}},{category:"Code Editor",id:"ace_remove_line",description:"Copy lines up",keys:{mac:[["cmd","option","up"]],win:[["alt","shift","up"]]}},{category:"Code Editor",id:"ace_move_lines_down",description:"Move lines down",keys:{mac:[["option","down"]],win:[["alt","down"]]}},{category:"Code Editor",id:"ace_move_lines_up",description:"Move lines up",keys:{mac:[["option","up"]],win:[["alt","up"]]}},{category:"Code Editor",id:"ace_remove_to_line_end",description:"Remove to line end",keys:{mac:[["ctrl","k"]],win:[["alt","delete"]]}},{category:"Code Editor",id:"ace_remove_to_line_start",description:"Remove to line start",keys:{mac:[["cmd","backspace"]],win:[["alt","backspace"]]}},{category:"Code Editor",id:"ace_remove_word_left",description:"Remove word left",keys:{mac:[["option","backspace"],["ctrl","option","backspace"]],win:[["ctrl","backspace"]]}},{category:"Code Editor",id:"ace_remove_word_right",description:"Remove word right",keys:{mac:[["option","delete"]],win:[["ctrl","delete"]]}},{category:"Code Editor",id:"ace_split_line",description:"Split line",keys:{mac:[["ctrl","o"]]}},{category:"Code Editor",id:"ace_select_all",description:"Select all",keys:{mac:[["cmd","a"]],win:[["ctrl","a"]]}},{category:"Code Editor",id:"ace_select_left",description:"Select left",keys:{win_mac:[["shift","left"]]}},{category:"Code Editor",id:"ace_select_right",description:"Select right",keys:{win_mac:[["shift","right"]]}},{category:"Code Editor",id:"ace_select_word_left",description:"Select word left",keys:{mac:[["option","shift","left"]],win:[["ctrl","shift","left"]]}},{category:"Code Editor",id:"ace_select_word_right",description:"Select word right",keys:{mac:[["option","shift","right"]],win:[["ctrl","shift","right"]]}},{category:"Code Editor",id:"ace_select_line_start",description:"Select line start",keys:{win_mac:[["shift","home"]]}},{category:"Code Editor",id:"ace_select_line_end",description:"Select line end",keys:{win_mac:[["shift","end"]]}},{category:"Code Editor",id:"ace_select_line_end",description:"Select to line end",keys:{mac:[["option","shift","right"]],win:[["alt","shift","right"]]}},{category:"Code Editor",id:"ace_select_line_start",description:"Select to line start",keys:{mac:[["option","shift","left"]],win:[["alt","shift","left"]]}},{category:"Code Editor",id:"ace_select_up",description:"Select up",keys:{win_mac:[["shift","up"]]}},{category:"Code Editor",id:"ace_select_down",description:"Select down",keys:{win_mac:[["shift","down"]]}},{category:"Code Editor",id:"ace_select_page_up",description:"Select page up",keys:{win_mac:[["shift","pageup"]]}},{category:"Code Editor",id:"ace_select_page_down",description:"Select page down",keys:{win_mac:[["shift","pagedown"]]}},{category:"Code Editor",id:"ace_select_to_start",description:"Select to start",keys:{mac:[["command","shift","up"]],win:[["ctrl","shift","home"]]}},{category:"Code Editor",id:"ace_select_to_end",description:"Select to end",keys:{mac:[["command","shift","down"]],win:[["ctrl","shift","end"]]}},{category:"Code Editor",id:"ace_duplicate_selection",description:"Duplicate selection",keys:{mac:[["command","shift","d"]],win:[["ctrl","shift","d"]]}},{category:"Code Editor",id:"ace_select_to_matching_bracket",description:"Select to matching bracket",keys:{win:[["ctrl","shift","p"]]}},{category:"Code Editor",id:"ace_go_to_left",description:"Go to left",keys:{mac:[["left"],["ctrl","b"]],win:[["left"]]}},{category:"Code Editor",id:"ace_go_to_right",description:"Go to right",keys:{mac:[["right"],["ctrl","f"]],win:[["right"]]}},{category:"Code Editor",id:"ace_go_to_word_left",description:"Go to word left",keys:{mac:[["option","left"]],win:[["ctrl","left"]]}},{category:"Code Editor",id:"ace_go_to_word_right",description:"Go to word right",keys:{mac:[["option","right"]],win:[["ctrl","right"]]}},{category:"Code Editor",id:"ace_go_line_up",description:"Go line up",keys:{mac:[["up"],["ctrl","p"]],win:[["up"]]}},{category:"Code Editor",id:"ace_go_line_down",description:"Go line down",keys:{mac:[["down"],["ctrl","n"]],win:[["down"]]}},{category:"Code Editor",id:"ace_go_to_line_start",description:"Go to line start",keys:{mac:[["command","left"],["home"],["ctrl","a"]],win:[["alt","left"],["home"]]}},{category:"Code Editor",id:"ace_go_to_line_end",description:"Go to line end",keys:{mac:[["command","right"],["end"],["ctrl","e"]],win:[["alt","right"],["end"]]}},{category:"Code Editor",id:"ace_go_to_page_up",description:"Go to page up",keys:{mac:[["option","pageup"]],win:[["pageup"]]}},{category:"Code Editor",id:"ace_go_to_page_down",description:"Go to page down",keys:{mac:[["option","pagedown"],["ctrl","v"]],win:[["pagedown"]]}},{category:"Code Editor",id:"ace_go_to_start",description:"Go to start",keys:{mac:[["command","home"],["command","up"]],win:[["ctrl","home"]]}},{category:"Code Editor",id:"ace_go_to_end",description:"Go to end",keys:{mac:[["command","end"],["command","down"]],win:[["ctrl","end"]]}},{category:"Code Editor",id:"ace_go_to_matching_bracket",description:"Go to matching bracket",keys:{win:[["ctrl","p"]]}},{category:"Code Editor",id:"ace_scroll_page_down",description:"Scroll page down",keys:{mac:[["option","pagedown"]]}},{category:"Code Editor",id:"ace_scroll_page_up",description:"Scroll page up",keys:{mac:[["option","pageup"]]}},{category:"Code Editor",id:"ace_indent",description:"Indent",keys:{win_mac:[["tab"]]}},{category:"Code Editor",id:"ace_outdent",description:"Outdent",keys:{win_mac:[["shift","tab"]]}},{category:"Code Editor",id:"ace_undo",description:"Undo",keys:{mac:[["command","z"]],win:[["ctrl","z"]]}},{category:"Code Editor",id:"ace_redo",description:"Redo",keys:{mac:[["command","shift","z"],["command","y"]],win:[["ctrl","y"],["ctrl","shift","z"]]}},{category:"Code Editor",id:"ace_toggle_comment",description:"Toggle comment",keys:{mac:[["command","/"]],win:[["ctrl","/"]]}},{category:"Code Editor",id:"ace_change_to_lower_case",description:"Change to lower case",keys:{win_mac:[["ctrl","shift","u"]]}},{category:"Code Editor",id:"ace_change_to_upper_case",description:"Change to upper case",keys:{win_mac:[["ctrl","u"]]}},{category:"Code Editor",id:"ace_insert",description:"Overwrite",keys:{win_mac:[["insert"]]}},{category:"Code Editor",id:"ace_delete",description:"Delete",keys:{win_mac:[["delete"]]}}];_.each(e,function(e){e.ignore_clash=!0,e.modes=["writeable"]}),RCloud.UI.shortcut_manager.add(e)}},RCloud.UI.help_frame={body:function(){return RCloud.UI.panel_loader.load_snippet("help-snippet")},init:function(){$("#help-body").append('<iframe id="help-frame" frameborder="0" />'),$("#help-form").submit(function(e){e.preventDefault(),e.stopPropagation();var t=$("#input-text-help").val();return $("#input-text-help").blur(),rcloud.help(t),!1}),$("#show-shortcuts").click(function(e){e.preventDefault(),RCloud.UI.shortcut_dialog.show()})},panel_sizer:function(e){return"none"===$("#help-body").css("display")?RCloud.UI.collapsible_column.default_sizer(e):{padding:RCloud.UI.collapsible_column.default_padder(e),height:9e3}},show:function(){$("#help-body").css("display","table-row"),$("#help-body").attr("data-widgetheight","greedy"),$("#collapse-help").trigger("size-changed");var e=$("#collapse-help").closest(".panel-group").attr("id").includes("left")?"left":"right";RCloud.UI[e+"_panel"].collapse($("#collapse-help"),!1),ui_utils.prevent_backspace($("#help-frame").contents())},display_content:function(e){$("#help-frame").contents().find("body").html(e),this.show()},display_href:function(e){$("#help-frame").attr("src",e),this.show()}},function(){RCloud.UI.image_manager=function(){var e={},t=RCloud.extension.create();function o(e,o,n,r,i){var s,l,a,c,u,d;function f(t){var o={type:t};u&&(o.dim=u),rcloud.plots.render(r,i,o).then(function(o){saveAs(function(e){var t,o,n;if(-1==e.indexOf(";base64,"))return o=(t=e.split(","))[0].split(":")[1],n=decodeURIComponent(t[1]),new Blob([n],{type:o});o=(t=e.split(";base64,"))[0].split(":")[1];for(var r=(n=window.atob(t[1])).length,i=new Uint8Array(r),s=0;s<r;++s)i[s]=n.charCodeAt(s);return new Blob([i],{type:o})}(o.url),e+"."+t)})}function h(e,t){var o=[t.size.width,t.size.height];rcloud.plots.render(r,i,{dim:o}).then(function(e){m.update(e.url,o)}).catch(function(e){if(!/Error in replayPlot/.test(e.message))throw e})}function p(e){e&&(e[0]&&a.css("width",e[0]),e[1]&&a.css("height",e[1]),u=e)}d={id:e,src:o},l=$($.el.img(d)),s=function(e){var r=$('<div class="live-plot-container"></div>'),i=$('<div class="live-plot"></div>');c=$('<div class="live-plot-scroller"></div>'),a=$("<div></div>"),i.append(c),c.append(a,$("<br/>")),a.append(e);var s=$('<span class="live-plot-commands"></div>');return window.shell&&!shell.notebook.model.read_only()&&s.append(function(){var e=ui_utils.fa_button("icon-camera","set as thumb");return e.click(function(){RCloud.UI.scratchpad.update_thumb(),RCloud.UI.thumb_dialog.display_image(o)}),e}()),s.append(function(){var e=$('<span class="dropdown"></div>'),o=$('<span class="dropdown-toggle fontawesome-button" type="button" data-toggle="dropdown" aria-expanded="true"></span>');o.append($('<i class="icon-save"></i>'));var n=$('<ul role="menu" class="dropdown-menu plot-save-formats"></ul>');_.pluck(t.entries("all"),"key").forEach(function(e){var t=$('<a role="menuitem" href="#">'+e+"</a>");t.click(function(){f(e)});var o=$('<li role="presentation"></li>').append(t);n.append(o)});var r={title:"save image",delay:{show:250,hide:0},container:"body"};return o.tooltip(r),e.append(o,n),e}()),s.hide(),i.hover(function(){s.show()},function(){s.hide()}),i.append(s),e.css({width:"100%",height:"100%"}),p(n),a.resizable({autoHide:!0,stop:h}),r.append(i),r}(l);var m={div:function(){return s},update:function(e,t){l.attr("src",e),p(t)},locate:function(e){s.attr("tabindex",1).css("cursor","crosshair"),s.focus().keydown(function(t){t.keyCode===$.ui.keyCode.ESCAPE&&(s.off("keydown").blur(),l.off("click"),s.attr("tabindex",null).removeAttr("style"),e(null,null))}),l.click(function(t){$(this).offset();var o=$(this).offset().top-$(window).scrollTop(),n=$(this).offset().left-$(window).scrollLeft(),r=Math.round(t.clientX-n),i=Math.round(t.clientY-o);s.off("keydown").blur(),l.off("click"),s.attr("tabindex",null).removeAttr("style"),e(null,[r,i])})}};return m}function n(e,t){return e+"-"+t}return{update:function(t,r,i,s){var l,a=n(i,s);return e[a]?(l=e[a]).update(t,r):(l=o(a,t,r,i,s),e[a]=l),l},locate:function(t,o,r){var i=n(t,o);e[i]?e[i].locate(r):r("ERROR: cannot find image corresponding to the locator")},load_available_formats:function(){return rcloud.plots.get_formats().then(function(e){var t=1e3,o={};(e=_.without(e,"r_attributes","r_type")).forEach(function(e){o[e]={sort:t},t+=1e3}),RCloud.UI.image_manager.formats.add(o)})},formats:t}}()}(),RCloud.UI.import_export=function(){var e;function t(e,t,o){var n=new Blob([t],{type:o});saveAs(n,e)}function o(){var t=[];return e?(t=shell.get_selected_cells().map(function(e){return e.filename()}),Promise.resolve(t)):Promise.resolve([])}function n(e,t){return t&&t.length&&_.difference(Object.keys(e.files),t).forEach(function(t){delete e.files[t]}),e}return{init:function(){return RCloud.UI.advanced_menu.add({import_notebooks:{sort:4e3,text:"Import External Notebooks",modes:["edit"],action:function(){function e(){var e=$("#import-source").val(),o=$("#import-gists").val(),n=$("#import-prefix").val();o=_.without(o.split(/[\s,;]+/),""),rcloud.port_notebooks(e,o,n).then(function(e){var t=[],o=[];for(var n in e)"r_type"!==n&&"r_attributes"!==n&&(e[n].ok?t.push(e[n].content):o.push(n));var r=[];t.forEach(function(e){r.push(editor.star_notebook(!0,{notebook:e}).then(function(){return editor.set_notebook_visibility(e.id,!0,function(){})}))}),Promise.all(r).then(function(){editor.highlight_imported_notebooks(t)}),o.length&&RCloud.UI.session_pane.post_error("Failed to import notebooks: "+o.join(", "))}),t.modal("hide")}var t=$("#import-notebooks-dialog");t.length||(t=function(){var t=$('<div class="container"/>').append($(["<p>Import notebooks from another GitHub instance.</p><p>Currently import does not preserve history.</p>",'<p>source repo api url:&nbsp;<input type="text" class="form-control-ext" id="import-source" style="width:100%;" value="https://api.github.com"></input></td>','<p>notebooks:<br /><textarea class="form-control-ext" style="height: 20%;width: 50%;max-width: 100%" rows="10" cols="30" id="import-gists" form="port"></textarea></p>','<p>prefix (e.g. <code>folder/</code> to put notebooks in a folder):&nbsp;<input type="text" class="form-control-ext" id="import-prefix" style="width:100%;"></input>'].join(""))),o=$('<span class="btn btn-cancel">Cancel</span>').on("click",function(){$(s).modal("hide")}),n=$('<span class="btn btn-primary">Import</span>').on("click",e),r=$('<div class="modal-footer"></div>').append(o).append(n),i=$(['<div class="modal-header">','<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>',"<h3>Import Notebooks</h3>","</div>"].join("")),s=$('<div id="import-notebooks-dialog" class="modal fade"></div>').append($('<div class="modal-dialog"></div>').append($('<div class="modal-content"></div>').append(i).append(t).append(r)));return $("body").append(s),s.on("show.bs.modal",function(){$("#import-gists").val("")}).on("shown.bs.modal",function(){$("#import-source").focus().select()}),s}()),t.modal({keyboard:!0})}},export_notebook_gist:{sort:5e3,text:"Export Notebook to File",modes:["edit"],action:function(){rcloud.protection.get_notebook_cryptgroup(shell.gistname()).then(function(e){e?alert("Exporting protected notebooks is not supported at this time (and will always export in the clear)"):o().then(function(e){return rcloud.get_notebook(shell.gistname(),shell.version(),null,!0).then(function(o){o=n(o=Notebook.sanitize(o),e);var r=JSON.stringify(o);return t(o.description+".gist",r,"text/json"),o})})})}},import_notebook_gist:{sort:6e3,text:"Import Notebook from File",modes:["edit"],action:function(){var e=$("#import-notebook-file-dialog");e.length?e.data().reset():e=function(){var e=null,t=null,o=null,n=null;function r(){var t=o.val();e&&t.length>0&&(e.description=t,rcloud.create_notebook(e,!1).then(function(e){editor.star_notebook(!0,{notebook:e}).then(function(){editor.set_notebook_visibility(e.id,!0),editor.highlight_imported_notebooks(e)})}),d.modal("hide"))}var i=$('<div class="container"/>'),s=$('<input type="file" id="notebook-file-upload" size="50"></input>');s.click(function(){ui_utils.disable_bs_button(n),[l,t].forEach(function(e){e.hide()}),s.val(null)}).change(function(){var r;r=s[0].files[0],t.hide(),l.hide(),Notebook.read_from_file(r,{on_load_end:function(){t.show()},on_error:function(e){t.text(e)},on_notebook_parsed:function(r){e=r,t.text(""),o.val(e.description),l.show(),ui_utils.enable_bs_button(n)}})}),(t=$("<span />")).append(t);var l=$("<span>Notebook description: </span>");o=$('<input type="text" class="form-control-ext" size="50" id="import-notebook-description"></input>').on("change paste keyup",function(e){var t=$(this).val().length;return t?ui_utils.enable_bs_button(n):ui_utils.disable_bs_button(n),e.which!==$.ui.keyCode.ENTER||!t||(r(),!1)}),l.append(o),i.append($("<p/>").append(s)).append($("<p/>").append(t.hide())).append($("<p/>").append(l.hide()));var a=$('<span class="btn btn-cancel">Cancel</span>').on("click",function(){$(d).modal("hide")});n=$('<span class="btn btn-primary">Import</span>').on("click",r),ui_utils.disable_bs_button(n);var c=$('<div class="modal-footer"></div>').append(a).append(n),u=$(['<div class="modal-header">','<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>',"<h3>Import Notebook File</h3>","</div>"].join("")),d=$('<div id="import-notebook-file-dialog" class="modal fade"></div>').append($('<div class="modal-dialog"></div>').append($('<div class="modal-content"></div>').append(u).append(i).append(c)));return $("body").append(d),d.on("show.bs.modal",function(){$("#notebook-file-upload")[0].value=null,t.text(""),t.hide(),o.val(""),l.hide()}),d.data("reset",function(){e=null,ui_utils.disable_bs_button(n)}),d}(),e.modal({keyboard:!0})}},export_notebook_r:{sort:7e3,text:"Export Notebook as R Source File",modes:["edit"],action:function(){return o().then(function(e){rcloud.get_notebook(shell.gistname(),shell.version()).then(function(o){var r=[],i=[];o=n(o,e),_.each(o.files,function(e){var t=e.filename;if(/^part/.test(t)){var o=parseInt(t.slice(4).split(".")[0]);isNaN(o)||("R"===e.language?i[o]="```{r}\n"+e.content+"\n```":i[o]=e.content)}});for(var s=0;s<i.length;++s)_.isUndefined(i[s])||r.push(i[s]);r.push(""),rcloud.purl_source(r.join("\n")).then(function(e){var n=_.isString(e)?e:e.join("\n");t(o.description+".R",n,"text/plain")})})})}}}),this},export_only_selected_files:function(t){e=t}}}(),RCloud.UI.pull_and_replace=function(){var e,t=$("#pull-changes-dialog"),o=$("#pull-changes-by"),n=$("#pull-notebook-file"),r=$("#pull-notebook-url"),i=$("#pull-notebook-id"),s=t.find(".btn-primary.show-changes"),l=[n,r,i],a="You cannot pull from your current notebook; the source must be a different notebook.",c="Invalid notebook ID.",u=function(){b(),l.forEach(function(e){e.val("")}),e=void 0,d("url")},d=function(e,n){m(),o.val(e),$(t).find("div[data-by]").hide(),$(t).find('div[data-by="'+e+'"]').show(),_.isUndefined(n)||p().val("file"===e?"":n)},f=function(){function o(e){return Notebook.valid_gist_id(e)?e.toLowerCase()===shell.gistname().toLowerCase()?Promise.reject(new Error(a)):rcloud.get_notebook(e):Promise.reject(new Error(c))}var n,r=h();v(),"id"===r?n=o:"file"===r?n=function(){return e?Promise.resolve(e):Promise.reject(new Error("No file to upload"))}:"url"===r&&(n=function(e){var t=RCloud.utils.get_notebook_from_url(e);return t?o(t):Promise.reject(new Error("Invalid URL"))});var i=p().val();n(i).then(function(e){return Promise.all([rcloud.set_notebook_property(shell.gistname(),"pull-changes-by",r+":"+i),editor.pull_and_replace_notebook(e).then(function(){u(),t.modal("hide")})])}).catch(function(e){b(),-1!==e.message.indexOf("Not Found (404)")?g("The notebook could not be found."):g(e.message)})},h=function(){return o.val()},p=function(){return $("#pull-notebook-"+h())},m=function(){$("#pull-error").remove()},g=function(e){m(),$("<div />",{id:"#pull-error".substring(1),text:e}).appendTo($(t).find('div[data-by="'+h()+'"]'))},v=function(){s.text("Pulling"),t.addClass("pulling")},b=function(){s.text("Pull"),t.removeClass("pulling")};return{init:function(){return RCloud.UI.advanced_menu.add({pull_and_replace_notebook:{sort:3e3,text:"Pull and Replace Notebook",modes:["edit"],disabled_reason:"You can't pull and replace into a read only notebook",action:function(){rcloud.get_notebook_property(shell.gistname(),"pull-changes-by").then(function(e){if(e&&-1!==e.indexOf(":")){var o=e.indexOf(":"),n=e.substring(0,o),r=e.substring(o+1);d(n,r)}else d("url");t.modal({keyboard:!0})})}}}),$(t).on("hide.bs.modal",function(){u()}),o.change(function(){n.val(null),d($(this).val())}),n.click(function(){m(),n.val(null),e=void 0}).change(function(){var t;t=n[0].files[0],Notebook.read_from_file(t,{on_load_end:function(){},on_error:function(t){e=void 0,g(t)},on_notebook_parsed:function(t){e=t}})}),[r,i,o,n].forEach(function(e){e.keydown(function(e){e.keyCode===$.ui.keyCode.ENTER&&(f(),e.preventDefault())})}),s.click(f),this}}}(),RCloud.UI.init=function(){var e;RCloud.UI.processing_queue.init(),RCloud.UI.run_button.init(),RCloud.UI.stop_button.init(),(e=$("#output")).sortable({items:"> .notebook-cell",start:function(e,t){$(e.toElement).addClass("grabbing"),t.placeholder.height(t.item.height())},stop:function(e,t){$(e.toElement).removeClass("grabbing")},update:function(t,o){e.sortable("toArray");var n=o.item.data("rcloud.model"),r=o.item.next().data("rcloud.model");shell.notebook.controller.move_cell(n,r)},handle:" .cell-status",helper:"clone",scroll:!0,scrollSensitivity:40,forcePlaceholderSize:!0}),RCloud.UI.column_sizer.init(),$(window).bind("unload",function(){return shell.save_notebook(),!0}),RCloud.UI.menus.init(),RCloud.UI.advanced_menu.init(),RCloud.UI.navbar.init(),RCloud.UI.selection_bar.init(),RCloud.UI.shortcut_manager.init(),RCloud.UI.ace_shortcuts.init(),RCloud.UI.find_replace.init(),RCloud.UI.share_button.init(),RCloud.UI.notebook_commands.init(),RCloud.UI.cell_commands.init(),RCloud.UI.panel_loader.init(),RCloud.UI.import_export.init(),RCloud.UI.pull_and_replace.init(),Object.keys(RCloud.UI.addons).forEach(e=>{RCloud.UI.addons[e].init()}),ui_utils.prevent_backspace($(document)),$(document).on("copy",function(e){!$(arguments[0].target).hasClass("ace_text-input")&&$(arguments[0].target).closest($("#output")).size()&&ui_utils.select_allowed_elements()}),shell.is_view_mode()||$(document).on("scroll",function(){$(this).scrollLeft(0),$(this).scrollTop(0)}),$("#rcloud-cellarea").on("scroll",function(){$(this).scrollLeft(0)}),$(window).resize(function(e){shell.refresh_notebook_title()}),RCloud.UI.shortcut_manager.add([{category:"Notebook Management",id:"notebook_cell",description:"Save the current notebook",keys:{mac:[["command","s"]],win:[["ctrl","s"]]},modes:["writeable"],action:function(){RCloud.UI.navbar.get("save_notebook")&&shell.save_notebook()}},{category:"Notebook Management",id:"select_all",description:"Select all",keys:{mac:[["command","a"]],win:[["ctrl","a"]]},modes:["writeable"],action:function(e){if($(e.target).parents("#find-form").length)$(e.target).select();else{var t=window.getSelection();t.removeAllRanges();var o=new Range;o.selectNode(document.getElementById("output")),o.setStartAfter($(".response")[0]),t.addRange(o)}}},{category:"Notebook Management",id:"history_undo",description:"Step back through the notebook's history",keys:{mac:[["command","alt","z"]],win:[["ctrl","alt","z"]]},on_page:["edit"],action:function(){editor.step_history_undo()}},{category:"Notebook Management",id:"history_redo",description:"Step forwards through the notebook's history",keys:{mac:[["command","shift","z"]],win:[["ctrl","y"]]},on_page:["edit"],action:function(){editor.step_history_redo()}},{category:"Notebook Management",id:"history_revert",description:"Revert a notebook",keys:{mac:[["command","e"]],win:[["ctrl","e"]]},on_page:["edit"],is_active:function(){return shell.notebook.controller.is_mine()&&shell.notebook.model.read_only()},action:function(){this.is_active()&&editor.revert_notebook(shell.notebook.controller.is_mine(),shell.gistname(),shell.version())}},{category:"Cell Management",id:"notebook_run_all",description:"Run all cells",keys:{win_mac:[["ctrl","shift","enter"]]},action:function(){RCloud.UI.run_button.run()}}]),RCloud.UI.shortcut_manager.add([{category:"Cell Management",id:"remove_cells",description:"Remove selected cells",keys:{mac:[["command","backspace"]],win:[["ctrl","del"],["ctrl","backspace"]]},modes:["writeable"],action:function(){shell.notebook.controller.remove_selected_cells()}},{category:"Cell Management",id:"invert_cells",description:"Invert selected cells",keys:{mac:[["command","shift","i"]],win:[["ctrl","shift","i"]]},modes:["writeable"],action:function(){shell.notebook.controller.invert_selected_cells(),$(":focus").blur()}},{category:"Cell Management",id:"crop_cells",description:"Crop cells",keys:{mac:[["command","k"]],win:[["ctrl","k"]]},modes:["writeable"],action:function(){shell.notebook.controller.crop_cells()}},{category:"Cell Management",id:"arrow_next_cell_down",description:"Enter next cell (from last line of current)",keys:{win_mac:[["down"]]},modes:["writeable"]},{category:"Cell Management",id:"arrow_previous_cell_up",description:"Enter previous cell (from first line of current)",keys:{win_mac:[["up"]]},modes:["writeable"]},{category:"Cell Management",id:"goto_previous_cell",description:"Go to previous cell",keys:{win_mac:[["ctrl","shift","<"]]},modes:["writeable"]},{category:"Cell Management",id:"goto_next_cell",description:"Go to next cell",keys:{win_mac:[["ctrl","shift",">"]]},modes:["writeable"]},{category:"Cell Management",id:"insert_cell_before",description:"Insert cell before current",keys:{win:[["ctrl","["]],mac:[["command","["]]},modes:["writeable"],action:function(){}},{category:"Cell Management",id:"insert_cell_after",description:"Insert cell after current",keys:{win:[["ctrl","]"]],mac:[["command","]"]]},modes:["writeable"],action:function(){}},{category:"Cell Management",id:"run_selected_cells",description:"Run the selected cells",click_keys:{target:"Play button",win:[["ctrl"]],mac:[["command"]]}},{category:"Cell Management",id:"cell_run_from_here",description:"Run from this cell on",keys:{win_mac:[["shift","alt","enter"]]},click_keys:{target:"Play button",win_mac:[["shift"]]},modes:["writeable"]},{category:"Cell Management",id:"show_results_of_cells",description:"Show results of selected/all cells",click_keys:{target:"Hide results button",win:[["ctrl"]],mac:[["command"]]}},{category:"Cell Management",id:"blur_cell",description:"Blur Cell/Command Prompt",keys:{win_mac:[["esc"]]},modes:["writeable"]},{category:"Cell Management",id:"select_cell",description:"Select individual cell",click_keys:{target:"Cell title"}},{category:"Cell Management",id:"toggle_select_cell",description:"Toggle cell selection",click_keys:{target:"Cell title",win:["ctrl"],mac:["command"]}},{category:"Cell Management",id:"select_cell_range",description:"Select range of cells",click_keys:{target:"Cell title",win_mac:["shift"]}}]),RCloud.UI.shortcut_manager.add([{category:"General",id:"show_help",description:"Show shortcuts help",keys:{win_mac:[["?"]]},modes:["writeable","readonly"],action:function(e){RCloud.UI.shortcut_dialog.show()}},{category:"General",id:"close_modal",description:"Close dialog",keys:{win_mac:[["esc"]]},ignore_clash:!0,enable_in_dialogs:!0,global:!0,action:function(){$(".modal").modal("hide")}}])},RCloud.UI.left_panel=RCloud.UI.collapsible_column("#left-column","#accordion-left","#left-pane-collapser"),RCloud.UI.load_options=function(){return rcloud.get_conf_value("smtp.server").then(function(e){return e&&RCloud.UI.settings_frame.add({"subscribe-to-comments":RCloud.UI.settings_frame.checkbox({sort:5e3,default_value:!1,label:"Subscribe To Comments",condition:function(){}})}),Promise.all([rcloud.protection.has_notebook_protection(),RCloud.UI.panel_loader.load()]).spread(function(e,t){e&&RCloud.UI.menus.get("advanced_menu").menu.add({manage_groups:{sort:7e3,text:"Manage Groups",modes:["edit"],action:function(e){RCloud.UI.notebook_protection.init("group-tab-enabled")}}});return RCloud.UI.left_panel.init(),RCloud.UI.middle_column.init(),RCloud.UI.right_panel.init(),shell.is_view_mode()||RCloud.UI.incremental_search.init(),RCloud.UI.command_prompt.init(),$(".panel-collapse").collapse({toggle:!1}),Promise.all([RCloud.UI.navbar.load(),RCloud.UI.menus.load(),RCloud.UI.shortcut_manager.load(),RCloud.UI.share_button.load(),shell.notebook.view.load_options(),RCloud.UI.left_panel.load_options(),RCloud.UI.right_panel.load_options()])})})},RCloud.UI.menu=function(){var e,t;return{filter_mode:function(e){return function(t){return t.modes.indexOf(e)>=0}},mode_sections:function(t){return arguments.length?(e=t,this):(e||(e={view:{filter:RCloud.UI.menu.filter_mode("view")},edit:{filter:RCloud.UI.menu.filter_mode("edit")}}),e)},ui_mode:function(e){return arguments.length?(t=e,this):t||(shell.is_view_mode()?"view":"edit")},create:function(){var e;return{init:function(){e=RCloud.extension.create({sections:RCloud.UI.menu.mode_sections()})},add:function(t){return e&&e.add(t),this},remove:function(t){return e.remove(t),this},check:function(t,o){var n=e.get(t);if(!n||!n.checkbox||!n.checkbox_widget)throw new Error("menu check fail on "+t);return n.checkbox_widget.set_state(o),this},enable:function(t,o){var n=e.get(t);if(!n||!n.$li)throw new Error("menu disable fail on "+t);return o?n.$li.find("a").removeAttr("title"):n.disabled_reason&&n.$li.find("a").attr("title",n.disabled_reason),n.disabled=!o,n.$li.toggleClass("disabled",!o),this},create_checkbox:function(e){var t=$.el.li($.el.a({href:"#",id:e.key},$.el.i({class:"icon-check"})," ",e.text));return e.checkbox_widget=ui_utils.checkbox_menu_item($(t),function(){e.disabled||e.action(!0)},function(){e.disabled||e.action(!1)}),e.value&&e.checkbox_widget.set_state(e.value),t},create_link:function(e){return $.el.li($.el.a({href:"#",id:e.key},e.text))},create:function(t){var o=this,n=$('<ul class="dropdown-menu"></ul>');t.append(n);var r=e.entries(RCloud.UI.menu.ui_mode());return n.append($(r.map(function(e){var t;return t=e.checkbox?o.create_checkbox(e):o.create_link(e),e.disabled&&o.enable(e,!1),e.$li=$(t),t}))),n.find("li a").click(function(){var t=e.get(this.id);if(!t)throw new Error("bad id in advanced menu");t.checkbox||t.disabled||t.action()}),this}}}}}(),RCloud.UI.menus=function(){var e;return{init:function(){e=RCloud.extension.create({sections:RCloud.UI.menu.mode_sections()}),this.add({discover_divider:{sort:7e3,type:"divider",modes:["edit"]},discover:{sort:8e3,type:"link",href:"/discover.html",text:"Discover",target:"_blank",modes:["edit"]},logout_divider:{sort:1e4,type:"divider",modes:["edit"]},logout:{sort:12e3,type:"link",href:"/logout.R",text:"Logout",modes:["edit"]}})},add:function(t){return e.add(t),this},remove:function(t){return e.remove(t),this},get:function(t){return e.get(t)},create_menu:function(e){var t=$.el.li({class:"dropdown"},$.el.a({href:"#",class:"dropdown-toggle","data-toggle":"dropdown"},e.title+" ",$.el.b({class:"caret"})));return e.menu.create($(t)),t},create_link:function(e){var t={href:e.href};return e.target&&(t.target=e.target),$.el.li($.el.a(t,e.text))},create_divider:function(e){return $.el.li({class:"divider-vertical"})},load:function(t){var o=this,n=$("#rcloud-navbar-menu");return rcloud.get_conf_values("^rcloud\\.menu\\..*").then(function(t){t=_.omit(t,"r_type","r_attributes");var r={};for(var i in t){var s=t[i].split(/ *, */),l=i.split(".");if(3!=l.length)throw new Error("submenus not supported yet - invalid menu key "+i);var a,c=+s[0],u=s[1].split(/ *\| */),d=s[2],f=s[3],h=s[4],p=s[5]||"_blank";if(isNaN(c))throw new Error("bad sort value "+s[0]+" in menu key "+i);switch(d){case"link":a={sort:c,modes:u,type:d,text:f,href:h,target:p};break;case"divider":a={sort:c,modes:u,type:d};break;default:throw new Error("invalid menu type "+d+" in menu key "+i)}r[l[2]]=a}o.add(r);var m=e.entries(RCloud.UI.menu.ui_mode()),g=$(m.map(function(e){switch(e.type){case"divider":return o.create_divider();case"menu":return o.create_menu(e);case"link":return o.create_link(e);default:throw new Error("unknown navbar menu entry type "+e.type)}}));n.append(g)})}}}(),function(){var e,t;RCloud.UI.message_dialog=function(o,n,r){if($("#loading-animation").hide(),_.isUndefined(e)){var i=$("<button type='submit' class='btn btn-primary' style='float:right'>OK</span>"),s=$("<div />").append($("<h1 />").append(o));t=$('<p style="white-space: pre-wrap">'+n+"</p>"),s.append(t,i),s.append('<div style="clear: both;"></div>'),i.click(function(t){t.preventDefault(),e.modal("hide")}),e=$('<div id="message-dialog" class="modal fade" />').append($('<div class="modal-dialog" />').append($('<div class="modal-content" />').append($('<div class="modal-body" />').append(s)))),$("body").append(e),e.on("shown.bs.modal",function(){i.focus()})}else t.text(n);e.off("hidden.bs.modal").on("hidden.bs.modal",function(){r()}),e.modal({keyboard:!0})}}(),RCloud.UI.middle_column=function(){var e=RCloud.UI.column("#middle-column");return _.extend(e,{update:function(){var t=12-RCloud.UI.left_panel.colwidth()-RCloud.UI.right_panel.colwidth();e.colwidth(t),shell.notebook.view.reformat()}}),e}(),RCloud.UI.navbar=function(){var e,t;return{create_button:function(e,t,o){var n=$.el.button({id:e,title:t,type:"button",class:"btn btn-link navbar-btn"},$.el.i({class:o})),r=$(n);return{control:n,click:function(e){return $(n).click(e),this},hide:function(){return r.hide(),this},show:function(){return r.show(),this},disable:function(){return ui_utils.disable_bs_button(r),this},enable:function(){return ui_utils.enable_bs_button(r),this},display:function(e,t){return $(n).find("i").removeClass().addClass(t),$(n).attr("title",e),this}}},create_highlight_button:function(e,t,o){var n=this.create_button(e,t,o);return n.highlight_color="#ffff4d",n.icon_class=o,n.original_color=null,n.highlighted=!1,n.highlight=function(e){var t=this,o=500;t.highlighted=e,t.original_color||(t.original_color=$($(n.control).find("."+n.icon_class)).css("color"));var r=!1;return t.highlighted&&(r=!1,function e(){var n=$(t.control).find("."+t.icon_class);t.highlighted?n.is(":animated")||d3.select(n[0]).transition().duration(o).style("color",t.highlight_color).transition().duration(o).transition().duration(o).style("color",t.original_color).each("end",function(){r||e()}):r=!0}()),this},n},init:function(){$("#rcloud-navbar-header").empty().append('<a class="navbar-brand" href="/edit.html">RCloud</a>');var t=RCloud.extension.filter_field("area","commands"),o=RCloud.UI.menu.filter_mode("view"),n=RCloud.UI.menu.filter_mode("edit");e=RCloud.extension.create({sections:{header:{filter:RCloud.extension.filter_field("area","header")},view_commands:{filter:function(e){return t(e)&&o(e)}},edit_commands:{filter:function(e){return t(e)&&n(e)}}}}),this.add({shareable_link:{area:"commands",sort:1e3,modes:["edit"],create:function(){var e,t=$.el.a({href:"#",id:"share-link",title:"Shareable Link",class:"btn btn-link navbar-btn",style:"text-decoration:none; padding-right: 0px",target:"_blank"},$.el.i({class:"icon-share"}));return $(t).on("click",function(e){shell.save_notebook()}),{control:$.el.span(t,$.el.span({class:"dropdown",style:"position: relative; margin-left: -2px; padding-right: 12px"},$.el.a({href:"#",class:"dropdown-toggle","data-toggle":"dropdown",id:"view-mode"},$.el.b({class:"caret"})),e=$.el.ul({class:"dropdown-menu view-menu",id:"view-type"}))),set_url:function(e){return t&&$(t).attr("href",e),this},open:function(){return t&&$(t)[0].click(),this},set_view_types:function(t){$(e).append($(t.map(function(e){var t=$.el.a({href:"#"},e.title);return $(t).click(e.handler),$.el.li(t)})))}}}},star_notebook:{area:"commands",sort:2e3,modes:["edit"],create:function(){var e,t,o,n,r=$.el.button({id:"star-notebook",title:"Star Notebook",type:"button",class:"btn btn-link navbar-btn",style:"padding-left: 3px"},$.el.i({class:"icon-star-empty"}),$.el.sub(n=$.el.span({id:"curr-star-count"})));return o=ui_utils.twostate_icon($(r),function(){e()},function(){t()},"icon-star","icon-star-empty"),{control:r,set_star_unstar:function(o,n){return e=o,t=n,this},set_fill:function(e){return o.set_state(e),$(this.control).attr("title",e?"Unstar Notebook":"Star Notebook"),this},set_count:function(e){return $(n).text(e),this}}}},fork_notebook:{area:"commands",sort:3e3,modes:["edit"],create:function(){var e=RCloud.UI.navbar.create_button("fork-notebook","Fork","icon-code-fork");return $(e.control).click(function(e){var t=shell.notebook.controller.is_mine(),o=shell.gistname(),n=shell.version();e.metaKey||e.ctrlKey?editor.fork_notebook(t,o,n,!1).then(function(e){var t=ui_utils.make_url("edit.html",{notebook:e.id});window.open(t,"_blank")}):editor.fork_notebook(t,o,n,!0)}),e}},save_notebook:{area:"commands",sort:4e3,modes:["edit"],create:function(){var e=RCloud.UI.navbar.create_button("save-notebook","Save","icon-save");return $(e.control).click(function(){shell.save_notebook()}),e.disable(),e}},revert_notebook:{area:"commands",sort:5e3,modes:["edit"],create:function(){var e=RCloud.UI.navbar.create_button("revert-notebook","Revert","icon-undo");return $(e.control).click(function(){var e=shell.notebook.controller.is_mine(),t=shell.gistname(),o=shell.version();editor.revert_notebook(e,t,o)}),e}},edit_notebook:{area:"commands",sort:1e3,modes:["view"],create:function(){var e=RCloud.UI.navbar.create_button("edit-notebook","Edit Notebook","icon-edit");return $(e.control).click(function(){window.location="edit.html?notebook="+shell.gistname()}),e}},run_notebook:{area:"commands",sort:6e3,modes:["edit","view"],create:function(){var e=RCloud.UI.navbar.create_highlight_button("run-notebook","Run All","icon-play");return $(e.control).click(function(e){if(e.metaKey||e.ctrlKey){var t=shell.get_selected_cells().map(function(e){return e.id()});t.length&&shell.run_notebook_cells(t)}else RCloud.UI.run_button.run()}),e}},stop_notebook:{area:"commands",sort:7e3,modes:["edit","view"],create:function(){var e=RCloud.UI.navbar.create_button("stop-notebook","Stop","icon-stop");return $(e.control).click(function(e){RCloud.UI.stop_button.stop()}),e.disable(),e}}})},add:function(t){return e&&e.add(t),this},remove:function(t){return e&&e.remove(t),this},get:function(t){return e?e.get(t):null},control:function(e){return t?t[e]:null},load:function(){if(e){var o=e.create("header").array,n=$("#rcloud-navbar-header");o.length&&n.empty().append.apply(n,o);var r=RCloud.UI.menu.ui_mode()+"_commands",i=e.create(r),s=$("#rcloud-navbar-main");i.array.length&&s.prepend.apply(s,i.array.map(function(e){return $.el.li(e.control)})),t=i.map}return Promise.resolve(void 0)}}}(),RCloud.UI.notebook_commands=function(){var e,t,o={"line-height":"90%"},n={"line-height":"90%","padding-right":"3px"},r=_.extend({"font-size":"80%"},o),i={true:{class:"icon-star",title:"unstar"},false:{class:"icon-star-empty",title:"star"}},s={},l={condition0:function(e){return e.gistname&&!e.version},condition1:function(e){return!0}};function a(e,t,o){o.forEach(function(o){t.append(document.createTextNode(String.fromCharCode(160))),t.append(o.create(e))})}return{init:function(){return this.add({star_unstar:{section:"always",sort:1e3,create:function(e){var t=editor.i_starred(e.gistname),o=ui_utils.fa_button(i[t].class,function(e){return i[t].title},"star",r,!0);return o.click(function(o){o.preventDefault(),o.stopPropagation(),ui_utils.kill_popovers();var n=!t;editor.star_notebook(n,{gistname:e.gistname,user:e.user})}),o[0].set_state=function(e){t=!!e,$(this).find("i").attr("class",i[t].class)},o.append($.el.sub(String(editor.num_stars(e.gistname)))),o}},history:{section:"appear",sort:2e3,create:function(e){var t=editor.current(),n=t.notebook===e.gistname&&t.version,r=ui_utils.fa_button("icon-time","history","history",o,!0);return n&&r.addClass("button-disabled"),r.click(function(){return ui_utils.kill_popovers(),ui_utils.fake_hover(e),n||editor.show_history(e,!0),!1}),r}},visibility:{section:"appear",sort:3e3,condition1:function(e){return e.user===editor.username()},create:function(e){var t=ui_utils.fa_button("icon-eye-close","hide notebook","hide-notebook",o,!0),n=ui_utils.fa_button("icon-eye-open","show notebook","show-notebook",o,!0);return e.visible?n.hide():t.hide(),t.click(function(){if(ui_utils.fake_hover(e),e.user!==editor.username())throw new Error("attempt to set visibility on notebook not mine");editor.set_notebook_visibility(e.gistname,!1)}),n.click(function(){if(ui_utils.fake_hover(e),e.user!==editor.username())throw new Error("attempt to set visibility on notebook not mine");return editor.set_notebook_visibility(e.gistname,!0),!1}),t.add(n)}},remove:{section:"appear",sort:5e3,condition1:function(e){return e.user===editor.username()},create:function(e){var t=ui_utils.fa_button("icon-remove","remove","remove",o,!0);return t.click(function(t){return $("div.popover").remove(),confirm("Do you want to remove '"+e.full_name+"'?")&&(t.stopPropagation(),t.preventDefault(),editor.remove_notebook(e.user,e.gistname)),!1}),t}},fork_notebook:{section:"appear",sort:2500,create:function(e){var t=ui_utils.fa_button("icon-code-fork","fork notebook","fork",o,!0);return t.click(function(t){editor.fork_notebook(e.user===editor.username(),e.gistname,e.version,!0)}),t}},fork_folder:{section:"appear",sort:1e3,condition0:function(e){return e.full_name&&!e.gistname},create:function(e){var t=ui_utils.fa_button("icon-code-fork","fork folder","fork",o,!0);return t.click(function(t){var o=e.full_name,n=new RegExp("^"+o);editor.find_next_copy_name(o).then(function(t){editor.fork_folder(e,n,t)})}),t}},remove_folder:{section:"appear",sort:2e3,condition0:function(e){return e.full_name&&!e.gistname&&e.user===editor.username()},create:function(e){var t=ui_utils.fa_button("icon-remove","remove folder","remove",o,!0),n=[];return t.click(function(t){if(editor.for_each_notebook(e,null,function(e){n.push(e.full_name)}),!confirm("Do you want to remove ALL the following notebooks?\n"+n.join("\n")))return n=[],!1;var o=[];editor.for_each_notebook(e,null,function(e){o.push(editor.remove_notebook(e.user,e.gistname))})}),t}}}),this},add:function(o){for(var n in o)s[n]=_.extend(_.extend({},l),o[n]);return e=_.filter(s,function(e){return"always"===e.section}),t=_.filter(s,function(e){return"appear"===e.section}),[e,t].forEach(function(e){e.sort(function(e,t){return e.sort-t.sort})}),this},remove:function(e){return delete s[e],this},icon_style:function(){return o},merge_icon_style:function(){return n},decorate:function(o,n,r){var i,s=$(r),l=function(e){return function(t){return _.every(["condition0","condition1","condition2"],function(o){return!t[o]||t[o](e)})}}(n);function c(e){e.on("mousedown mouseup click",function(e){e.stopPropagation()})}return function(){var t=e.filter(l);if(t.length){var o=$($.el.span({class:"notebook-commands-right"}));c(o),a(n,o,t),s.append(o)}}(),o.find("div.jqtree-element").hover(function(){i||function(){var e=t.filter(l);if(e.length){var o=$($.el.span({class:"notebook-commands appear"}));c(o),a(n,o,e),s.append(o),s.find(".notebook-date").toggleClass("disappear",!0),o.hide(),s.append($.el.span({class:"notebook-commands appear-wrapper"},o[0]))}i=!0}();editor.get_notebook_info(n.gistname);$(".notebook-commands.appear",this).show(),$(".notebook-date.disappear",this).css("visibility","hidden")},function(){$(".notebook-commands.appear",this).hide(),$(".notebook-date.disappear",this).css("visibility","visible")}),this}}}(),RCloud.UI.selection_bar=function(){var e,t,o,n,r,i,s,l,a,c=function(){t.prop("checked",!1),e.hide()};return{init:function(){var c=$(RCloud.UI.panel_loader.load_snippet("selection-bar-snippet"));e=c.find(".cell-selection span"),t=c.find('.cell-selection input[type="checkbox"]'),o=c.find(".dropdown-toggle"),n=c.find("#selection-bar-delete"),r=c.find("#selection-bar-crop"),c.find("#selection-bar-toggle-results"),i=c.find(".cell-selection"),s=n.find("span"),l=c.find("#selected-count"),a=c.find("#cell-count"),c.find('.btn-default input[type="checkbox"]').click(function(e){e.stopPropagation(),shell.notebook.controller.cell_count()?$(this).is(":checked")?shell.notebook.controller.select_all_cells():shell.notebook.controller.clear_all_selected_cells():e.preventDefault()}).end().find("a[data-action]").click(function(){shell.notebook.controller[$(this).attr("data-action")]()}).end().find("#selection-bar-delete").click(function(){shell.notebook.controller.remove_selected_cells()}).end().find("#selection-bar-crop").click(function(){shell.notebook.controller.crop_cells()}).end().find("#selection-bar-toggle-results").click(function(e){e.metaKey||e.ctrlKey?shell.notebook.controller.show_cells_results():shell.notebook.controller.hide_cells_results()}).end(),c.find('div[type="button"].cell-selection').click(function(e){$(this).find("input").trigger("click")}),$("#"+c.attr("id")).replaceWith(c)},update:function(c){var u=c.length,d=shell.notebook.controller.selected_count();t.prop({checked:d===u&&0!=u,disabled:0===u}),_.each([o,i],function(e){e[u?"removeClass":"addClass"]("disabled")}),e[d!==u&&0!==d?"show":"hide"](),n[d?"removeClass":"addClass"]("disabled"),r[shell.notebook.controller.can_crop_cells()?"removeClass":"addClass"]("disabled"),l.text(d),a.text(u),s[0!==d?"show":"hide"]()},hide:function(){$("#selection-bar").hide(),c()},show:function(){$("#selection-bar").show(),c()}}}(),RCloud.UI.notebook_title=function(){var e=null;function t(e){return editor.rename_notebook(e).then(function(){n.set(e)})}var o={change:t,select:function(e){if(1!==e.childNodes.length||e.firstChild.nodeType!=e.TEXT_NODE)throw new Error("expecting simple element with child text");var t=e.firstChild.textContent,o=document.createRange();return o.setStart(e.firstChild,t.lastIndexOf("/")+1),o.setEnd(e.firstChild,t.length),o},ctrl_cmd:function(e,o){var n=shell.notebook.controller.is_mine(),r=shell.gistname(),i=shell.version();editor.fork_notebook(n,r,i).then(function(n){return o?t(e):void 0})},validate:function(e){return editor.validate_name(e)}},n={set:function(e){$("#notebook-author").text(shell.notebook.model.user()),$("#author-title-dash").show(),$("#rename-notebook").show(),$("#loading-animation").hide();var t=shell.notebook.model.read_only(),n=e,r=!1,i=!1,s=$("#notebook-title");function l(e){return d3.sum($(e).map(function(e,t){return $(t).width()}))}var a=$("#rcloud-navbar-header").width()+l("#rcloud-navbar-menu li")+50;for(s.text(e);e.length>10&&window.innerWidth<a+l("#rcloud-navbar-main");){var c=e.search("/");c>=0?(r=!0,e=e.slice(c+1)):(i=!0,e=e.substr(0,e.length-5)),s.text((r?".../":"")+e+(i?"...":""))}ui_utils.editable(s,$.extend({allow_edit:!t&&!shell.is_view_mode(),inactive_text:s.text(),active_text:n},o))},update_fork_info:function(e){var t=ui_utils.make_url(shell.is_view_mode()?"view.html":"edit.html",{notebook:e});e?rcloud.get_notebook_info(e).then(function(e){var o=(e.username||"unknown")+" / "+(e.description||"unknown");$("#forked-from-desc").html("forked from <a href='"+t+"'>"+o+"</a>")}).catch(function(e){/does not exist or has not been published/.test(e)?$("#forked-from-desc").html("forked from <a href='"+t+"'>(unknown notebook)</a>"):$("#forked-from-desc").text("")}):$("#forked-from-desc").text("")},make_editable:function(n,r,i){function s(e,t){return $("> div > .jqtree-title",t)}if(e&&(!n||n.gistname&&e!==n)&&ui_utils.editable(s(0,e.element),"destroy"),n){var l=o;n.version?l=$.extend({},o,{change:function(e){return function(t){return editor.tag_version(e.gistname,e.version,t).then(function(){return editor.show_history(e.parent,{update:!0})})}}(n),validate:function(e){return!0}}):n.gistname||(l=$.extend({},o,{change:function(e){return function(o){editor.for_each_notebook(e,o,function(e,o){e.gistname===shell.gistname()?t(o):rcloud.update_notebook(e.gistname,{description:o},!1).then(function(e){editor.update_notebook_from_gist(e)})},function(e,t){return t+"/"+e.name})}}(n),ctrl_cmd:function(e){return function(t){var o=new RegExp("^"+e.full_name);editor.fork_folder(e,o,t)}}(n),validate:function(e){return editor.validate_name(e)}})),ui_utils.editable(s(0,r),$.extend({allow_edit:i,inactive_text:n.name,active_text:n.version?n.name:n.full_name},l))}n&&n.gistname&&(e=n)}};return n}(),RCloud.UI.notebooks_frame={body:function(){return RCloud.UI.panel_loader.load_snippet("notebooks-snippet")},heading_content:function(){return RCloud.UI.panel_loader.load_snippet("notebooks-panel-heading")},heading_content_selector:function(){return $("#notebooks-panel-controls")}},RCloud.UI.output_context=function(){return{create:function(e){var t=function(e){var t=$(e);function o(e){var o=function(e){switch(e){case"code":return function(e){return $.el.pre($.el.code(e))};case"error":return function(e){return $('<code style="color: crimson"></code>').append(e)};case"html":return function(e){return e};default:throw new Error("unknown output type "+e)}}(e);return function(e){t.append(o(e))}}return{end:function(){console.log("not expecting end on custom output context")},out:o("code"),err:o("error"),msg:o("code"),html_out:o("html"),selection_out:o("html"),deferred_result:null,in:null}}(e);return RCloud.register_output_context(t)},close:function(e){RCloud.unregister_output_context(e)}}}(),RCloud.UI.panel_loader=function(){var e,t={};function o(e){return"collapse-"+e}return{init:function(){e=RCloud.extension.create({sections:{left:{filter:function(e){return"left"===e.side}},right:{filter:function(e){return"right"===e.side}}}}),t={Notebooks:{side:"left",name:"notebook-tree",title:"Notebooks",icon_class:"icon-folder-open",colwidth:3,greedy:!0,sort:1e3,panel:RCloud.UI.notebooks_frame},"File Upload":{side:"left",name:"file-upload",title:"File Upload",icon_class:"icon-upload-alt",colwidth:2,sort:2e3,panel:RCloud.UI.upload_frame},Settings:{side:"left",name:"settings",title:"Settings",icon_class:"icon-cog",colwidth:3,sort:3e3,panel:RCloud.UI.settings_frame},Comments:{side:"left",name:"comments",title:"Comments",icon_class:"icon-comments",colwidth:2,sort:4e3,panel:RCloud.UI.comments_frame},Assets:{side:"right",name:"assets",title:"Assets",icon_class:"icon-copy",colwidth:4,sort:1e3,panel:RCloud.UI.scratchpad},Search:{side:"right",name:"search",title:"Search",icon_class:"icon-search",colwidth:4,sort:2e3,panel:RCloud.UI.search},Help:{side:"right",name:"help",title:"Help",icon_class:"icon-question",colwidth:5,sort:3e3,panel:RCloud.UI.help_frame},Session:{side:"right",name:"session-info",title:"Session",icon_class:"icon-info",colwidth:3,sort:4e3,panel:RCloud.UI.session_pane}}},add:function(t){e&&e.add(t)},remove:function(t){return e.remove(t),this},load_snippet:function(e){return $($("#"+e).html())[0]},load:function(){var n=this;function r(t,n){e.entries(n).forEach(function(e){!function(e){var t,n="accordion-"+e.side,r=o(e.name),i={class:"panel-heading clearfix","data-toggle":"collapse","data-parent":"#"+n,"data-target":"#"+r},s=$.el.span({class:"title-offset"},e.title),l=$.el.i({class:e.icon_class}),a=$.el.a({class:"accordion-toggle "+e.side,href:"#"+r},l," ",s),c=e.panel.heading_content?e.panel.heading_content():null;if("left"===e.side)t=$.el.div(i,a,c);else{if("right"!==e.side)throw new Error("Unknown panel side "+e.side);t=$.el.div(i,c,a)}var u={id:r,class:"panel-collapse collapse","data-colwidth":e.colwidth};e.greedy&&(u["data-widgetheight"]="greedy");var d=$.el.div(u,$.el.img({height:"100%",width:"5px",src:"left"===e.side?"/img/right_bordergray.png":"/img/left_bordergray.png",class:"panel-shadow "+e.side}),e.panel.body()),_=$.el.div({class:"panel panel-default"},t,d);$("#"+n).append(_)}(e),e.panel.init&&e.panel.init(),e.panel.load&&e.panel.load(),e.panel.panel_sizer&&$("#"+o(e.name)).data("panel-sizer",e.panel.panel_sizer),e.panel.heading_content_selector&&$("#"+o(e.name)).data("heading-content-selector",e.panel.heading_content_selector())}),function(e){for(var t="accordion-"+e,o=$("<div/>",{class:"panel-body",style:"border-top-color: transparent; background-color: #777"}),n=0;n<60;++n)o.append($.el.br());var r=$.el.div({class:"panel-collapse out"},o[0]),i=$.el.div({class:"panel panel-default"},r);$("#"+t).append(i)}(n)}return rcloud.config.get_user_option("panel-layout-by-size").then(function(e){if(null===e&&(e=!0),!e){var o=function(e,o,n){t[e].side=o,t[e].sort=n};_.each(["Notebooks","Search","Settings","Help"],function(e,t){o(e,"left",1e3*(t+1))}),_.each(["Assets","File Upload","Comments","Session"],function(e,t){o(e,"right",1e3*(t+1))})}return n.add(t),r(0,"left"),r(0,"right"),$("#left-column").append(n.load_snippet("left-pane-collapser-snippet")),$("#right-column").append(n.load_snippet("right-pane-collapser-snippet")),Promise.cast(void 0)})}}}(),function(){var e,t=0,o=1,n=!1;function r(){n||(n=!0,_.isUndefined(e)&&(e=$('<div id="progress-dialog" class="modal fade"><div class="modal-dialog"><div class="modal-content"><div class="modal-body">Please wait...</div></div></div>'),$("body").append(e),e.on("hide.bs.modal",function(){t=0,l()})),e.modal({keyboard:!0}))}function i(){n&&(n=!1,e.modal("hide"))}function s(){_.delay(function(){document.body.style.cursor="wait"},0)}function l(){_.delay(function(){document.body.style.cursor=""},0)}RCloud.UI.with_progress=function(e,n){function a(){0===(t-=1)&&(l(),i())}return _.isUndefined(n)&&(n=2e3),s(),_.delay(function(){t>0&&o>0&&r()},n),t+=1,Promise.resolve(a).then(e).then(function(e){return a(),e}).catch(function(e){throw a(),e})},RCloud.UI.prevent_progress_modal=function(){1===o&&t>0&&(l(),i()),o-=1},RCloud.UI.allow_progress_modal=function(){0===o&&t>0&&(s(),r()),o+=1}}(),RCloud.UI.right_panel=RCloud.UI.collapsible_column("#right-column","#accordion-right","#right-pane-collapser"),RCloud.UI.processing_queue=function(){var e=!1,t=!1,o=[],n=[],r=null;return onStartCallbacks=[],finallyCallbacks=[],{init:function(){var e=this;RCloud.session.listeners.push({on_reset:function(){e.on_stopped()}})},is_running:function(){return e},is_stopping:function(){return t},start_queue:function(){var r=this;if(0===o.length)return t=!1,e=!1,Promise.resolve(void 0);e=!0;var i=Promise.resolve(void 0).then(function(e){return onStartCallbacks.forEach(function(t){t(e)}),e}),s=o.shift();return i.then(s).then(function(){if(t)throw t=!1,"stop";return n.shift(),r.start_queue()})},stop:function(){e&&(rcloud.has_compute_separation?rcloud.signal_to_compute(2):t=!0)},stopGracefully:function(){e&&(t=!0)},on_stopped:function(){n.forEach(function(e){e()}),o=[],n=[],e=!1,r=null},addFinallyCallback:function(e){finallyCallbacks.push(e)},addOnStartCallback:function(e){onStartCallbacks.push(e)},enqueue:function(t,i){var s=this;return o.push(t),n.push(i||function(){}),e||(r=s.start_queue().catch(function(e){if("stop"===e)n.shift(),s.on_stopped();else if(console.log(e),s.on_stopped(),!/^ERROR FROM R SERVER: 127/.test(e))throw e}).finally(function(e){return finallyCallbacks.forEach(function(t){t(e)}),e})),r}}}(),RCloud.UI.run_button=function(){var e=!1,t=!1;function o(e){RCloud.UI.navbar.control("run_notebook").highlight(e)}function n(e){e?RCloud.UI.navbar.control("run_notebook").enable():RCloud.UI.navbar.control("run_notebook").disable()}function r(t){return(e&&shell.notebook.controller.session_dirty()?RCloud.session.reset().then(function(){return shell.notebook.controller.session_dirty(!1),rcloud.load_notebook(shell.gistname(),shell.version())}):Promise.resolve(void 0)).then(function(){return shell.run_notebook()})}return{init:function(){var e=this;RCloud.session.listeners.push({on_reset:function(){e.on_stopped()}}),RCloud.UI.processing_queue.addOnStartCallback(function(e){n(!1),o(!0)}),RCloud.UI.processing_queue.addFinallyCallback(function(t){e.on_stopped()})},run:function(){var e=Promise.resolve(void 0);return RCloud.UI.processing_queue.is_running()||t||(t=!0,e=e.then(r).finally(function(e){t=!1})),e},on_stopped:function(){o(!1),n(!0)},reset_on_run:function(t){return arguments.length?(e=t,this):e}}}(),RCloud.UI.stop_button=function(){function e(e){e?RCloud.UI.navbar.control("stop_notebook").enable():RCloud.UI.navbar.control("stop_notebook").disable()}return{init:function(){var t=this;RCloud.session.listeners.push({on_reset:function(){t.on_stopped()}}),RCloud.UI.processing_queue.addOnStartCallback(function(t){e(!0)}),RCloud.UI.processing_queue.addFinallyCallback(function(e){t.on_stopped()})},on_stopped:function(){e(!1)},stop:function(){RCloud.UI.processing_queue.stop()}}}(),RCloud.UI.scratchpad=function(){var e;return{session:null,widget:null,exists:!1,current_model:null,change_content:null,body:function(){return RCloud.UI.panel_loader.load_snippet("assets-snippet")},init:function(){var e=this;var t,o=$("#scratchpad-editor");o.length&&(this.exists=!0,function(t){var o=$("<div></div>"),n=$("<div style='clear:both;'></div>");t.append(o),t.append(n);var r=$('<div style="width:100%; height:100%"></div>');r.css({"background-color":"#f1f1f1"}),o.append(r),ace.require("ace/ext/language_tools");var i=ace.edit(r[0]),s=ace.require("ace/mode/r").Mode,l=i.getSession();i.$blockScrolling=1/0,e.session=l,e.widget=i;var a=l.doc;l.on("change",function(){i.resize()}),i.setOptions({enableBasicAutocompletion:!0}),i.commands.addCommands([{name:"blurCell",bindKey:{win:"Escape",mac:"Escape"},exec:function(){e.widget.blur()}}]),l.setMode(new s({suppressHighlighting:!1,doc:a,session:l,language:"R"})),l.setNewLineMode("unix"),l.setOption("indentedSoftWrap",!1),l.setUseWrapMode(!0),i.resize(),ui_utils.on_next_tick(function(){l.getUndoManager().reset(),i.resize()}),e.change_content=ui_utils.ignore_programmatic_changes(e.widget,function(){e.current_model&&e.current_model.parent_model.on_dirty()}),ui_utils.install_common_ace_key_bindings(i,function(){return e.current_model.language()}),$("#collapse-assets").on("shown.bs.collapse panel-resize",function(){i.resize()}),RCloud.UI.thumb_dialog.init(),$("#update-thumb").click(RCloud.UI.scratchpad.update_thumb)}(o),$(document).on("dragstart dragenter dragover",function(e){if(!RCloud.UI.thumb_dialog.is_visible()){var o=e.originalEvent.dataTransfer;o&&null!==o.types&&(o.types.indexOf?-1!=o.types.indexOf("Files")&&-1==o.types.indexOf("text/html"):o.types.contains("application/x-moz-file"))&&(shell.notebook.model.read_only()?(e.stopPropagation(),e.preventDefault()):(e.stopPropagation(),e.preventDefault(),$("#asset-drop-overlay").css({display:"block"}),t=!0))}}),$(document).on("drop dragleave",function(e){e.stopPropagation(),e.preventDefault(),t=!1,setTimeout(function(){t||$("#asset-drop-overlay").css({display:"none"})},100)}),$("#scratchpad-wrapper").bind({drop:function(e){var t=(e=e.originalEvent||e).files||e.dataTransfer.files;e.dataTransfer,shell.notebook.model.read_only()||RCloud.UI.upload_with_alerts(!0,{files:t}).catch(function(){}),$("#asset-drop-overlay").css({display:"none"})},"dragenter dragover":function(e){var t=e.originalEvent.dataTransfer;shell.notebook.model.read_only()||(t.dropEffect="copy")}})),$("#new-asset > a").click(function(){var e=prompt("Choose a filename for your asset");if(e&&(e=e.trim()))if(Notebook.is_part_name(e))alert("Asset names cannot start with 'part[0-9]', sorry!");else{var t=shell.notebook.model.get_asset(e);if(t)t.controller.select();else{var o=-1!=e.indexOf(".")?e.match(/\.(.*)/)[1]:"";shell.notebook.controller.append_asset(function(e,t){switch(t){case"css":return"/* "+e+" */\n";case"js":return"// "+e+"\n";case"html":return"\x3c!-- "+e+" --\x3e\n";default:return"# "+e+"\n"}}("New file "+e,o),e).spread(function(e,t){t.select(),ui_utils.ace_set_pos(RCloud.UI.scratchpad.widget,2,1)})}}})},panel_sizer:function(e){return{padding:RCloud.UI.collapsible_column.default_padder(e),height:9e3}},set_model:function(t){var o=this;if(this.exists){if(this.current_model&&!e&&(this.current_model.cursor_position(this.widget.getCursorPosition()),this.current_model.content(this.widget.getValue())&&this.current_model.parent_model.controller.update_asset(this.current_model)),this.current_model=t,!this.current_model)return $("#scratchpad-binary").hide(),$("#scratchpad-editor").show(),o.change_content(""),o.widget.resize(),o.widget.setReadOnly(!0),$("#scratchpad-editor > *").hide(),void $("#asset-link").hide();this.update_asset_url(),$("#asset-link").show();var n=this.current_model.content();if(Notebook.is_binary_content(n)){e=!0,$("#scratchpad-editor").hide();var r=$("#scratchpad-binary"),i=this.current_model.filename().substr(this.current_model.filename().lastIndexOf(".")+1);-1!==["bmp","jpg","jpeg","png","gif"].indexOf(i.toLowerCase())?(r.html('<div><img src="'+this.current_model.asset_url(!0)+'"/></div>"'),r.find("div").removeClass("embed")):"pdf"===i.toLowerCase()?(r.html('<div><object><embed type="application/pdf" src="'+this.current_model.asset_url(!0)+'" /></object></div>'),r.find("div").addClass("embed")):(r.html("<div><p>Preview not supported for this file type</p></div>"),r.find("div").removeClass("embed")),r.show()}else{e=!1,o.widget.setReadOnly(shell.notebook.model.read_only()),$("#scratchpad-binary").hide(),$("#scratchpad-editor").show(),$("#scratchpad-editor > *").show(),this.change_content(n);var s=t.cursor_position();s?ui_utils.ace_set_pos(this.widget,s):ui_utils.ace_set_pos(this.widget,0,0),ui_utils.on_next_tick(function(){o.session.getUndoManager().reset()}),o.language_updated(),o.widget.resize(),o.widget.focus()}}},update_model:function(){return this.current_model&&!e?this.current_model.content(this.widget.getSession().getValue()):null},content_updated:function(){var t;if(t=this.current_model.content(),e=Notebook.is_binary_content(t),t&&!e){var o=this.widget.getSelection().getRange();this.change_content(t),this.widget.getSelection().setSelectionRange(o)}return t},language_updated:function(){if(!e){var t=this.current_model.language(),o=RCloud.language.ace_mode(t);this.session.setMode(new o({suppressHighlighting:!1,doc:this.session.doc,session:this.session,language:t}))}},set_readonly:function(t){shell.is_view_mode()||(this.widget&&!e&&ui_utils.set_ace_readonly(this.widget,t),$("#new-asset, #update-thumb")[t?"hide":"show"]())},update_asset_url:function(){this.current_model&&$("#asset-link").attr("href",this.current_model.asset_url())},update_thumb:function(){var e=shell.notebook.model.get_asset("thumb.png");e&&e.controller.select(),RCloud.UI.thumb_dialog.show()},clear:function(){this.exists&&(this.change_content(""),this.session.getUndoManager().reset(),this.widget.resize())}}}(),RCloud.UI.search=function(){var e=10,t=['<p style="color:black;margin:0;">The search engine in RCloud uses Lucene for advanced search features.',"It appears you may have used one of the special characters in Lucene syntax incorrectly. ",'Please see this <a target="_blank" href="http://lucene.apache.org/core/7_1_0/queryparser/org/apache/lucene/queryparser/classic/package-summary.html#Terms">link</a> to learn about Lucene syntax. ','</p><p style="color:black;margin:0;">Or, if you mean to search for the character itself, escape it using a backslash, e.g. "foo\\:"</p>'];function o(){return $("#sort-by option:selected").val()}function n(){return $("#order-by option:selected").val()}function r(){return $("#all-sources").is(":checked")}function i(){var e;switch(o()){case"starcount":case"updated_at":case"score":e="desc";break;case"user":case"description":e="asc"}$("#order-by").val(e)}return{body:function(){return RCloud.UI.panel_loader.load_snippet("search-snippet")},init:function(){if(rcloud.search){$("#search-form").submit(function(e){return t(),!1}),rcloud.get_gist_sources().then(function(e){_.isString(e)&&(e=[e]),e.length<2?$("#all-sources").parent().hide():$("#all-sources").change(function(e){var t=r();rcloud.config.set_user_option("search-all-sources",t)})}),$("#sort-by").change(function(){rcloud.config.set_user_option("search-sort-by",o()),i(),rcloud.config.set_user_option("search-order-by",n()),t()}),$("#order-by").change(function(){rcloud.config.set_user_option("search-order-by",n()),t()});var t=function(){var t=$("#input-text-search").val();$("#input-text-search").focus(),""!==$("#input-text-search").val()?RCloud.UI.search.exec(t,o(),n(),0,e):($("#paging").html(""),$("#search-results").html(""),$("#search-summary").html(""))}}else $("#search-wrapper").text("Search engine not enabled on server")},load:function(){return rcloud.config.get_user_option(["search-all-sources","search-results-per-page","search-sort-by","search-order-by"]).then(function(t){$("#all-sources").prop("checked",t["search-all-sources"]),t["search-results-per-page"]&&(e=t["search-results-per-page"]),t["search-sort-by"]||(t["search-sort-by"]="score"),$("#sort-by").val(t["search-sort-by"]),t["search-order-by"]?$("#order-by").val(t["search-order-by"]):i()})},panel_sizer:function(e){var t=RCloud.UI.collapsible_column.default_padder(e),o=24+$("#search-summary").height()+$("#search-results").height()+$("#search-results-pagination").height();return{height:o+=40,padding:t}},toggle:function(e,t){return $("#"+t).text(function(t,o){var n="";return o.indexOf("Show me more...")>-1?(n="Show me less...",$("#"+e).css("height","auto")):(n="Show me more...",$("#"+e).css("height","150px")),n}),!1},exec:function(o,n,i,s,l,a){function c(e,t){$("#search-summary").css("color",t||"black"),$("#search-summary").show().html($("<h4/>").append(e))}function u(n){console.log(n);var r,i,u="";if(null===n||"null"===n||"0"===n.n_notebooks)c("No Results Found");else if("error"===n[0])n[1]=n[1].replace(/\n/g,"<br/>"),""!=$("#paging").html&&$("#paging").html(""),n[1].indexOf("org.apache.solr.search.SyntaxError")>-1&&(u=t.join("")),r=u+"ERROR:\n"+n[1],i="darkred",$("#search-summary").css("display","none"),$("#search-results").css("color",i||"black"),$("#search-results-row").show().animate({scrollTop:$(document).height()},"slow"),$("#search-results").show().html($("<h4/>").append(r));else{try{numpaged=numfound=parseInt(n.n_notebooks);n.QTime;var d=Math.ceil(numpaged/e),f=_.template($("#search_results_template").html())}catch(e){c("Error : \n"+e,"darkred")}if(!a&&($("#paging").html(""),$("#search-results-pagination").show(),parseInt(numpaged)-parseInt(e)>0)){var h=d;if($("#current_page").val(0),0!=numfound){$("#paging").bootpag({total:h,page:1,maxVisible:8}).on("page",function(t,o){var n,r,i,s,l,a;n=e,r=parseInt(o-1)*parseInt(n),i=parseInt(r)+parseInt(n),s=$("#input-text-search").val(),l=$("#sort-by option:selected").val(),a=$("#order-by option:selected").val(),$("#input-text-search").blur(),""!==$("#input-text-search").val()&&RCloud.UI.search.exec(s,l,a,r,i,!0)})}}var p=decodeURIComponent(o);if(p=(p=p.replace(/</g,"&lt;")).replace(/>/g,"&gt;"),0===numfound)c("No Results Found");else if(parseInt(numpaged)<e)c(numfound+" Results Found","darkgreen");else{var m=numfound+" Results Found, showing ";numfound-s==1?m+=s+1:numfound-l>0?m+=s+1+" - "+l:m+=s+1+" - "+numfound,c(m,"darkgreen")}$("#search-results-row").css("display","table-row"),$("#search-results-scroller").scrollTop(0),$("#search-results").html(f({notebooks:n.notebooks})),$("#search-results .search-result-heading").click(function(e){e.preventDefault();var t=$(this).attr("data-gistname"),o=$(this).attr("data-gistsource");return editor.open_notebook(t,null,o,null,e.metaKey||e.ctrlKey),!1})}$("#collapse-search").trigger("size-changed")}c("Searching..."),a||($("#search-results-row").hide(),$("#search-results").html("")),o=encodeURIComponent(o),RCloud.UI.with_progress(function(){return rcloud.search(o,r(),n,i,s,e).then(function(e){u(e)}).catch(function(e){var t;console.log("search error",e),c(/Bad Request/.test(t=e)?"Syntax error in query":/Couldn't connect to server/.test(t)?"Couldn't connect to notebook search server (solr)":"Unknown error (see browser log)","darkred")})})}}}(),RCloud.UI.session_pane={error_dest_:null,clear_session_:null,allow_clear:!0,BUFFER_LIMIT:1e4,body:function(){return RCloud.UI.panel_loader.load_snippet("session-info-snippet")},init:function(){var e=this;this.error_dest_=$("#session-info"),this.error_dest_.length?this.show_error_area=function(){RCloud.UI.right_panel.collapse($("#collapse-session-info"),!1,!1)}:(this.error_dest_=$("#output"),this.show_error_area=function(){}),RCloud.session.listeners.push({on_reset:function(){e.clear()}}),this.clear_session_=$("#clear-session"),this.clear_session_.length&&this.clear_session_.click(function(t){t.preventDefault(),t.stopPropagation(),e.clear()}),Promise.onPossiblyUnhandledRejection(function(t,o){e.post_rejection(t)})},panel_sizer:function(e){var t=RCloud.UI.collapsible_column.default_sizer(e);return t.height&&(t.height+=20),t},error_dest:function(){return this.error_dest_},clear:function(){this.allow_clear&&$("#session-info").empty()},should_scroll:function(){return $("#session-info-panel").scrollTop()+$("#session-info-panel").height()-$("#session-info-out").height()>-10},scroll_to_end:function(){ui_utils.on_next_tick(function(){ui_utils.scroll_to_after($("#session-info"),{duration:0})})},append_text:function(e){if($("#session-info").length){document.getElementById("session-info-out")||$("#session-info").append($("<pre id='session-info-out'></pre>"));var t=$("#session-info-out"),o=t.text();o.length>this.BUFFER_LIMIT&&(o=o.slice(o.length-this.BUFFER_LIMIT/2),t.text(o),console.log("truncated session log"));var n=this.should_scroll();t.append(e),RCloud.UI.right_panel.collapse($("#collapse-session-info"),!1,!1),n&&this.scroll_to_end()}else console.log("session log: ",e)},post_error:function(e,t,o){if($("#loading-animation").hide(),(t=t||this.error_dest_)&&t.length){var n="session-error";if("string"==typeof e)e=ui_utils.string_error(e),n="session-error spare";else if("object"!=typeof e)throw new Error("post_error expects a string or a jquery div");var r=this.should_scroll();e.addClass(n),t.append(e),this.show_error_area(),r&&this.scroll_to_end()}else"object"==typeof e&&(e=e.text()),RCloud.UI.fatal_dialog(e,"Login",ui_utils.relogin_uri());o||("object"==typeof e&&(e=e.text()),console.log("pre-init post_error: "+e))},post_rejection:function(e){var t="";RCloud.is_exception(e)?t=RCloud.exception_message(e):(!window.chrome&&e.message&&(t+="Error: "+e.message+"\n"),t+=e.stack),console.log(t),this.post_error(t,void 0,!0)},heading_content:function(){return RCloud.UI.panel_loader.load_snippet("session-info-panel-heading")},heading_content_selector:function(){return $("#session-panel-controls")}},RCloud.UI.settings_frame=function(){var e,t={},o={},n={};function r(e,r){try{n[e]=!0,t[e].set(r,o[e])}catch(e){throw e}finally{n[e]=!1}}var i={body:function(){return e=$.el.div({id:"settings-body-wrapper",class:"panel-body"},$.el.div({id:"settings-scroller",style:"width: 100%; height: 100%; overflow-x: auto"},$.el.div({id:"settings-body",class:"widget-vsize"})),$.el.span({class:"settings-reload-msg",style:"display: none"},"Reload to see changes"))},panel_sizer:function(e){var t=RCloud.UI.collapsible_column.default_sizer(e);return{height:t.height+5,padding:t.padding}},show_reload_msg:function(t){t?$(e).find(".settings-reload-msg").show():$(e).find(".settings-reload-msg").hide()},checkbox:function(e){return{sort:(e=_.extend({sort:1e4,default_value:!1,needs_reload:!1,label:"",id:"",set:function(e){}},e)).sort,default_value:e.default_value,create_control:function(t){var o=$.el.input({type:"checkbox"});$(o).prop("id",e.id);var n=$.el.span(e.label),r=$.el.label(o,n),s=$($.el.div({class:"checkbox"},r));return $(o).change(function(){var o=$(this).prop("checked");t(o),e.needs_reload&&i.show_reload_msg(!0),e.set(o)}),s},set:function(t,o){t=!!t,o.find("input").prop("checked",t),e.set(t)}}},text_input:function(e){return{sort:(e=_.extend({sort:1e4,default_value:"",needs_reload:!1,label:"",id:"",parse:function(e){return e},format:function(e){return e},set:function(e){}},e)).sort,default_value:e.default_value,create_control:function(t){var o=$.el.input({type:"text",class:"form-control-ext"});$(o).prop("id",e.id);var n=$.el.span(e.label),r=$.el.label(n,o),s=$($.el.div({class:"settings-input"},r));function l(){var n=$(o).val();n!==s.data("original-value")&&(n=e.parse(n),t(n),e.needs_reload&&i.show_reload_msg(!0),e.set(n),n=e.format(n),$(o).val(n),s.data("original-value",n))}return $(o).keydown(function(e){e.keyCode===$.ui.keyCode.ENTER?l():e.keyCode===$.ui.keyCode.ESCAPE&&$(o).val(s.data("original-value"))}),$(o).blur(function(){l()}),s},set:function(t,o){e.set(t),t=e.format(t),o.find("input").val(t),o.data("original-value",t)}}},text_input_vector:function(e){return e=_.extend({parse:function(e){return e.trim().split(/[, ]+/).filter(function(e){return!!e})},format:function(e){return e.join?e.join(", "):e}},e),this.text_input(e)},init:function(){this.add({"show-command-prompt":this.checkbox({sort:1e3,default_value:!0,label:"Show Command Prompt",set:function(e){RCloud.UI.command_prompt.show_prompt(e)}}),"show-terse-dates":this.checkbox({sort:2e3,default_value:!0,needs_reload:!0,label:"Show Terse Version Dates",set:function(e){editor.set_terse_dates(e)}}),"show-cell-numbers":this.checkbox({sort:3e3,default_value:!0,label:"Show Cell Numbers",set:function(e){shell.notebook.controller.show_cell_numbers(e)}}),"color-recent-notebooks-by-modification-date":this.checkbox({sort:3500,default_value:!1,needs_reload:!0,label:"Color recent notebooks by modification date",set:function(e){editor.color_recent_notebooks_by_modification_date(e)}}),"show-folder-dates":this.checkbox({sort:3750,default_value:!1,needs_reload:!0,label:"Show folder date for date ordered tree",set:function(e){editor.set_show_folder_dates(e)}}),"panel-layout-by-size":this.checkbox({sort:4e3,default_value:!0,needs_reload:!0,label:"Arrange panels by size"}),"clear-r-session-when-run-all":this.checkbox({sort:5e3,default_value:!0,label:"Clear R Session when entire notebook is run",set:function(e){RCloud.UI.run_button.reset_on_run(e)}}),"export-only-selected-cells":this.checkbox({sort:6e3,default_value:!0,label:"Export only selected cells",set:function(e){RCloud.UI.import_export.export_only_selected_files(e)}}),"autoactivate-cells":this.checkbox({sort:6400,default_value:!0,label:"Auto-activate cells",needs_reload:!0}),"autoscroll-notebook-output":this.checkbox({sort:6500,default_value:!0,label:"Autoscroll notebook",set:function(e){shell.notebook.controller.autoscroll_notebook_output(e)}}),addons:this.text_input_vector({sort:1e4,needs_reload:!0,label:"Enable Extensions"}),"skip-addons":this.text_input_vector({sort:11e3,needs_reload:!0,label:"Disable Extensions"}),"new-notebook-prefix":this.text_input({sort:12e3,label:"New Notebook Prefix",default_value:editor.new_notebook_prefix(),set:function(e){editor.new_notebook_prefix(e)},parse:function(e){return e.split("/").filter(function(e,t,o){return t==o.length-1||!Notebook.empty_for_github(e)}).join("/")}})})},add:function(e){_.extend(t,e)},remove:function(e){delete t[e]},load:function(){var e=[];_.keys(t).forEach(function(r){var i=t[r];o[r]=i.create_control(function(e){n[r]||rcloud.config.set_user_option(r,e)}),e.push({sort:i.sort,control:o[r]})}),e=e.sort(function(e,t){return e.sort-t.sort});for(var i=$("#settings-body"),s=0;s<e.length;++s)i.append(e[s].control);var l=_.keys(t);return 1===l.length&&l.push("foo"),rcloud.config.get_user_option(l).then(function(e){for(var o in e){if("foo"!==o&&"r_attributes"!==o&&"r_type"!==o)r(o,null!==e[o]?e[o]:t[o].default_value)}})}};return i}(),RCloud.UI.share_button=function(){var e,t=null;function o(o){return rcloud.get_notebook_property(o,"view-type").then(function(o){return(o=o&&e.get(o)?o:t)||Promise.reject(new Error("share button view types set up wrong"))})}function n(t,n,r){var i=null;i=n?rcloud.get_tag_by_version(t,n).then(function(e){var o={notebook:t,version:n};return e&&(o.tag=e),o}):Promise.resolve(void 0).then(function(e){return{notebook:t}});var s=r?Promise.resolve(e.get(r)):function(t){return o(t).then(function(t){return e.get(t)})}(t);return Promise.join(i,s,function(e,t){var o=t.page;return e.do_path=t.do_path,ui_utils.make_url(o,e)})}function r(e){e&&$("#view-type li a").css("font-weight",function(){return $(this).text()===e?"bold":"normal"})}return{init:function(){return e=RCloud.extension.create({defaults:{create:function(){var o=this;return{title:o.key,handler:function(){var i;return(i=(i=o.key)&&e.get(i)?i:t)?rcloud.set_notebook_property(shell.gistname(),"view-type",i):Promise.reject(new Error("share button view types set up wrong")),r(o.key),n(shell.gistname(),shell.version(),o.key).then(function(e){var t=RCloud.UI.navbar.control("shareable_link");t.set_url(e),t.open()})}}}}}),this.add({"view.html":{sort:1e3,page:"view.html"},"notebook.R":{sort:2e3,page:"notebook.R",do_path:!0},"mini.html":{sort:3e3,page:"mini.html"}}),this},add:function(t){return e&&e.add(t),this},remove:function(t){return e&&e.remove(command_name),this},load:function(){var o=e.create("all").array;return t=o.length?o[0].title:null,RCloud.UI.navbar.control("shareable_link").set_view_types(o),this},update_link:function(){return n(shell.gistname(),shell.version()).then(function(e){RCloud.UI.navbar.control("shareable_link").set_url(e)}).then(function(){return o(shell.gistname()).then(function(e){r(e)})})},resolve_view_link:function(e,t){return n(e,t)}}}(),RCloud.UI.upload_with_alerts=function(){return function(e,t){function o(e){t.$upload_results.append(e),t.$result_panel.trigger("size-changed"),t.$upload_results.length&&ui_utils.on_next_tick(function(){ui_utils.scroll_to_after(t.$upload_results)})}function n(e){var t=$("<div></div>");t.append(e);var n=bootstrap_utils.alert({class:"alert-danger",html:t});return o(n),n}function r(e){o(bootstrap_utils.alert({class:"alert-info",text:e,on_close:function(){t.$progress.hide(),t.$result_panel.trigger("size-changed")}}))}return(t=function(e){if(_.isBoolean(e))e={force:e};else if(!_.isObject(e))throw new Error("didn't understand options "+e);return e=$.extend({$file:$("#file"),$progress:$(".progress"),$progress_bar:$("#progress-bar"),$upload_results:$("#file-upload-results").length?$("#file-upload-results"):RCloud.UI.session_pane.error_dest(),$result_panel:$("#collapse-file-upload")},e)}(t||{})).$result_panel.length&&!1!==t.show_result&&t.$result_panel.parent().parent().data("collapsible-column").collapse(t.$result_panel,!1),(e?RCloud.upload_assets(t,{add:function(e){r("Asset "+e+" added.")},replace:function(e){r("Asset "+e+" replaced.")}}):RCloud.upload_files(t,function(e){return{start:function(t){e.$progress.show(),e.$progress_bar.css("width","0%"),e.$progress_bar.attr("aria-valuenow","0")},progress:function(t,o){e.$progress_bar.attr("aria-valuenow",~~(t/o*100)),e.$progress_bar.css("width",t/o*100+"%")},done:function(e,t){r("File "+t+" "+(e?"replaced.":"uploaded."))},confirm_replace:Promise.promisify(function(e,t){var o=$("<p>File "+e+" exists. </p>"),r=bootstrap_utils.button({class:"btn-danger"}).click(function(){i.remove(),t(null,!0)}).text("Overwrite");o.append(r);var i=n(o);$("button.close",i).click(function(){t(new Error("Overwrite cancelled"),null)})})}}(t))).catch(function(e){return function(e){var t,o=e.message;throw"empty"===o?t=$("<p>File is empty.</p>"):"Overwrite cancelled"===o?t=$("<p>").append(o):"badname"===o?t=$("<p>Filename not allowed.</p>"):(t=$("<p>(unexpected) "+o+"</p>"),console.log(o,e.stack)),n(t),e}(e)}).then(function(){t.$progress.length&&window.setTimeout(function(){t.$progress.hide()},5e3)})}}(),RCloud.UI.upload_frame={body:function(){return RCloud.UI.panel_loader.load_snippet("file-upload-snippet")},init:function(){$("#file").change(function(){$("#progress-bar").css("width","0%"),0===$("#file")[0].files.length?$("#upload-submit").prop("disabled",!0):$("#upload-submit").prop("disabled",!1)}),$("#upload-submit").prop("disabled",!0),$("#upload-submit").click(function(){if(0!==$("#file")[0].files.length){var e=$("#upload-to-notebook").is(":checked");RCloud.UI.upload_with_alerts(e).catch(function(){})}}),RCloud.session.listeners.push({on_reset:function(){$(".progress").hide(),$("#file-upload-results").empty(),$("#upload-submit").prop("disabled",!0)}})},panel_sizer:function(e){var t=RCloud.UI.collapsible_column.default_padder(e);return{height:24+$("#file-upload-controls").height()+$("#file-upload-results").height(),padding:t}}},RCloud.UI.thumb_dialog=function(){var e=$("#thumb-dialog"),t=$("#thumb-drop-overlay"),o=t.find(".inner"),n=e.find(".modal-footer"),r=n.find(".btn-primary"),i=$("#thumb-remove"),s=$("#thumb-upload"),l=$("#selected-file"),a=$("#upload-success"),c=null,u={is_visible:function(){return e.is(":visible")},set_image:function(e){var o=t;return 0===o.find("img").length&&o.append($("<img/>")),o.find("img").attr({src:e}),o},reset:function(){t.removeClass("active dropped"),t.find("img").remove(),c=null,ui_utils.disable_bs_button(r),t.css("height",t.data("height")+"px")},verify:function(e){var t=1===e.length&&"image/png"===e[0].type;return t||o.effect("shake"),t},display_image:function(e){t.addClass("dropped"),this.set_image(e),a.show(),setTimeout(function(){a.animate({"margin-top":"0px",opacity:"0"},{duration:"fast",complete:function(){a.css({opacity:"1.0","margin-top":"35px"}).hide()}})},1500)},upload:function(e){c=e,ui_utils.enable_bs_button(r);var t=this,o=new FileReader;o.onload=function(e){t.display_image(e.target.result)},o.readAsDataURL(c)},setup_paste:function(){var e=this;$(document).on("paste",function(t){if(e.is_visible()){var o=(t.clipboardData||t.originalEvent.clipboardData).items,n=_.find(o,function(e){return"file"===e.kind});n&&e.verify([n])&&e.upload(n.getAsFile())}})},setup_asset_drop:function(){var e,o=this;$(document).on("dragstart dragenter dragover",function(n){if(o.is_visible()){var r=n.originalEvent.dataTransfer;r&&null!==r.types&&(r.types.indexOf?-1!=r.types.indexOf("Files")&&-1==r.types.indexOf("text/html"):r.types.contains("application/x-moz-file"))&&(shell.notebook.model.read_only()?(n.stopPropagation(),n.preventDefault()):(n.stopPropagation(),n.preventDefault(),t.addClass("active"),e=!0))}}),$(document).on("drop dragleave",function(n){o.is_visible()&&(n.stopPropagation(),n.preventDefault(),e=!1,setTimeout(function(){e||t.removeClass("active")},100))}),t.bind({drop:function(e){var t=(e=e.originalEvent||e).files||e.dataTransfer.files;o.verify(t)&&o.upload(t[0])},"dragenter dragover":function(e){var t=e.originalEvent.dataTransfer;shell.notebook.model.read_only()||(t.dropEffect="copy")}})},init:function(){var t=this;e.on("hidden.bs.modal",function(){t.reset()}),n.find(".btn-cancel").on("click",function(){e.modal("hide"),t.reset()}),ui_utils.disable_bs_button(r),r.on("click",function(){e.modal("hide"),c&&RCloud.UI.upload_with_alerts(!0,{files:[c],filenames:["thumb.png"],show_result:!1}).catch(function(){}),t.reset()}),i.click(function(){t.reset()}),s.click(function(){l.click()}),l.change(function(e){t.verify(e.target.files)&&(t.upload(e.target.files[0]),l.val(""))}),this.setup_asset_drop(),this.setup_paste()},show:function(){t.removeClass("active"),e.modal({keyboard:!0})}};return{init:function(){u.init()},show:function(){u.show()},is_visible:function(){return u.is_visible()},display_image:function(e){u.display_image(e),c=function(e){for(var t=e.split(","),o=t[0].match(/:(.*?);/)[1],n=atob(t[1]),r=n.length,i=new Uint8Array(r);r--;)i[r]=n.charCodeAt(r);return new Blob([i],{type:o})}(e),ui_utils.enable_bs_button(r)}}}(),RCloud.UI.notebook_protection_logger={timeout:0,log:function(e){$(".logging-panel").removeClass("red").removeClass("white").addClass("green"),$(".logging-panel span").text(e),window.clearTimeout(this.timeout),this.timeout=setTimeout(function(){$(".logging-panel").removeClass("red").removeClass("green").addClass("white"),$(".logging-panel span").html("&nbsp;")},2e4)},warn:function(e){$(".logging-panel").removeClass("green").removeClass("white").addClass("red"),$(".logging-panel span").text(e),window.clearTimeout(this.timeout),this.timeout=setTimeout(function(){$(".logging-panel").removeClass("red").removeClass("green").addClass("white"),$(".logging-panel span").html("&nbsp;")},2e4)},clear:function(){$(".logging-panel").removeClass("red").removeClass("green").addClass("white"),$(".logging-panel span").html("&nbsp;")}},RCloud.UI.notebook_protection=function(){return this.defaultCryptogroup=null,this.defaultNotebook=null,this.userId=null,this.userLogin=null,this.appScope=null,this.appInited=!1,{init:function(e){if(this.appInited)this.launch(e),$("#notebook-protection-dialog").modal({keyboard:!1});else{this.appInited=!0,this.buildDom();var t=this;require(["angular","./../../js/ui/notebook_protection_app","angular-selectize"],function(o,n,r){"use strict";o.element(document).ready(function(){_.delay(function(){o.bootstrap($("#protection-app")[0],["NotebookProtectionApp"]),o.resumeBootstrap()},100),_.delay(function(){t.appScope=o.element(document.getElementById("protection-app")).scope(),t.launch(e),$("#notebook-protection-dialog").modal({keyboard:!1})},200)})})}},launch:function(e){"both-tabs-enabled"===e?($("#protection-app #tab2").removeClass("active"),$("#protection-app #tab1").removeClass("disabled").addClass("active"),$("#protection-app #tab1 a").attr("href","#notebook-tab").attr("data-toggle","tab"),$("#protection-app #tab2 a").tab("show"),$("#protection-app #tab1 a").tab("show"),this.appScope.initBoth()):"group-tab-enabled"===e&&($("#protection-app #tab1").removeClass("active").addClass("disabled"),$("#protection-app #tab1 a").attr("href","#").removeAttr("data-toggle"),$("#protection-app #tab2 a").tab("show"),this.appScope.initGroups())},buildDom:function(){var e=$('<div class="container"></div>');e.append(RCloud.UI.panel_loader.load_snippet("notebook-protection-modal"));var t=$(['<div class="modal-header">','<button type="button" class="close" onClick="(RCloud.UI.notebook_protection.close.bind(RCloud.UI.notebook_protection))()" aria-hidden="true">&times;</button>',"<h3>Notebook Permissions / Group Management</h3>","</div>"].join("")),o=$('<div id="notebook-protection-dialog" class="modal fade"></div>').append($('<div class="modal-dialog"></div>').append($('<div class="modal-content"></div>').append(t).append(e)));$("body").append(o)},close:function(){this.appScope.cancel()}}}(),RCloud.UI.discovery_page=function(){var e,t=function(){var e=$("#metric-type"),t=["recently.modified","most.popular"],o=t[0];function n(t){e.find("li").removeClass("active"),e.find('a[data-type="'+t+'"]').parent().addClass("active")}function r(){return e.find("a")}var i=function(){var e=RCloud.utils.get_url_parameter("metric");return t.indexOf(e)>-1?e:o};return{init:function(e){_.each(r(),function(e){$(e).attr("href","?metric="+$(e).attr("data-type"))}),r().click(function(t){t.preventDefault();var o,r,i,s,l=$(this).attr("data-type");n(l),o="metric",r=l,i=[location.protocol,"//",location.host,location.pathname].join(""),s="?"+o+"="+r,window.history.pushState({path:i+s},"",i+s),_.isFunction(e.change)&&e.change(l)}),window.addEventListener("popstate",function(t){if(_.isFunction(e.change)){var o=i();n(o),e.change(o)}});var t=i();n(t),_.isFunction(e.oncomplete)&&e.oncomplete(t)}}},o={load_current_metric:function(t){var o;t=t||"recently.modified",$("body").addClass("loading");var n=!rcloud.username();return rcloud.discovery.get_notebooks(t).then(function(e){return o=e,RCloud.discovery_model.get_notebooks(n,Object.keys(o.values))}).then(function(t){var r=_.chain(o.values).pairs().filter(function(e){return"r_attributes"!=e[0]&&"r_type"!=e[0]&&!_.isEmpty(t[e[0]])});"date"===o.sort?r=r.map(function(e){return[e[0],Date.parse(e[1])]}).sortBy(function(e){return-1*e[1]}):"number"===o.sort&&(r=r.sortBy(function(e){return-1*e[1]}));(r=r.value()).length>100&&(r=r.slice(0,100));var i=r.map(function(e){var o,r=t[e[0]],i=(o=r.description)&&-1!=o.lastIndexOf("/")?{path:o.substring(0,o.lastIndexOf("/")),name:o.substring(o.lastIndexOf("/")+1)}:{path:void 0,name:o};return rcloud.discovery.get_thumb(e[0]).then(function(t){return{id:e[0],time:e[1],description:i.name,folder_path:i.path,last_commit:r.last_commit,last_commit_date:new Date(r.last_commit).toDateString(),page:n?"view.html":"edit.html",username:r.username,stars:r.stars,star_icon:!_.isUndefined(r.is_starred_by_me)&&r.is_starred_by_me?"icon-star":"icon-star-empty",forks:r.forks,image_src:t||"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAAGQCAMAAAC3Ycb+AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAURQTFRF6PH06fH0+fv8w9fd+vz94+3xxtne5O7xwNXbx9nf9fn64u3w5/Dzwtbc5u/yxdjeydvgz9/k4ezv1eTo9vr73+vu3Ons8vf4+vz84+7x6/P13entx9rf5vDy7/X32efr9vn6wdbb3ert8vf5zd7jzN3i8/j59Pj51uTo8Pb48fb4zt/k0ODlytzh9/r7w9fc1+Xp0+LnwdXb1OPn2+js4ezw4Ozv7vT2yNrg2ebq6PHz6vL0xNjdy9zh2Obq2OXq2ufr0+Lm7fT20uLm6vL17PT25vDzyNvg+Pr73urt5/Hz8/f57vX36fL0+fz8xtnf8ff4zN7i1uXp9Pj6xNfd3Ojs3uru+Pv77PP1+Pv84Ovv1OPo0uHm0eHlzt7jy93i8Pb30ODk6/L17PP21ePo5O7yydvh5O/y0eHm4+3wv9Ta5e/yk3jLJAAACxdJREFUeNrs3f1bFNcVwPGjKLvruu4CAlKwCAFFgfAiWrWAUNpQkzZGY22jpmn63nv//9+rxii7DLszc8/MnNn5nufJ88TnYYZzzsfx7p25c1emxROGQuQ8IoY43l4fiBjyOC/iEbHk4cUjYsnjPQgidjx+AkHEjMcHEESsePwMgogRj48giNjw+ASCiAmPEyCIWPA4CYKIAY8uEESK9+gGQaRwjx4QRIr26AVBpGCPUyCIFOtxGgSRQj0iQBAp0iMKBJECPSJBECnOIxoEkcI8zgBBpCiPs0AQKcjjTBBEivE4GwSRQjz6gCBShEc/EEQK8OgLgkj+Hv1BEMndYwAIInl7DAJBJGePgSCI5OsxGASRXD1igCCSp0ccEERy9IgFgkh+HvFAEMnNIyYIInl5xAVBJCeP2CCI5OMRHwSRXDwSgCCSh0cSEERy8EgEgkj2HslAEMncIyEIIll7JAVBJOt+iUfEkkdyEESy7ZV4RCx5pAFBJMs+iUfEkkc6EESy65F4RCx5pAVBJKv+iEfEkkd6EESy6Y14RCx5hIAgkkVfxCNiySMMBBH9nohHxJJHKAgi2v0Qj4glj3AQRHR7IR4RSx4aIIho9kE8IpY8dEAQ0euBeERMdUA8IqbqF4+IqerFI2KqdvGImKpcPCKm6haPiKmqxSNiqmbxiJiqWDwipuoVj4ipasUjYqpW8YiYqlQ8IqbqFI+IqSrFI2KqRvGImKpQPCKm6hOPiKnqxCNiqjbxiJiqTDwipuoSj4ipqsQjYqom8YiYqkg8IqbqEY+IqWrEI2KqFvGImKpEPCKm6hCPiKkqxCNiqgbxiJiqQDwipvIXj4ip7MUjYip38YiYylw8IqbyFo+Iqax5v9waPy0AhAAEEAIQQAhAACEAAYQAhBhqkCdjoy5VtJcXAVGP2poLiLuAKMfFOeeGSKT0ILVAD+dmAdGMv4Z6uAeAKMa8C48/AaIWMyMKIMuAqMWWgoer1wDRGtE3+ne68S7aA0UeA6IUryMZlv95MPuq+a/uH202m5OTs1Pzb+qnjxgDROkCiRpB5u4PnNf3HrILiE48jLob8p/Bx021eg66B4hKLEeAvIpz4GbPQQ8B0YhmxHAwEu/fup6j1gDRiJWIC+Tf8Q7tGXzmANGI9QiQmOPzgtmZSIlBavWoD73/i3Pofbt3T0oMshM5yYs1p5joPep7QMLjv9HT7jifmObSfRYApG90IjQ2Go2lycHzEMN3T4oEqc0vNV44ozHSWN5vVgtkZcMZj4WtWnVAmh1Xgng6XhWQi21Xiti4XxGQjitJjM5UAmTFlSa+rwJIbaQ8INv3KgCy70oUExUAWSoTyHoFQBplAmlVAGSkTCAOkPd/L8c2n48tRI6yP0zsrxw+yA/kIiDO7b2/jzQeMV1Z+nCHabYBSH4gox9uIp1eKvr802fnPUByA/n4isDDPssRaqMD1i0uHW4uLi5Ovv1vZ2Ws8wKQ1CCfPtj0PKcdmRnwXOPn6Bydfio7/vjZCCCpQEY//ehGv/sYZ1wijYkzn2TsLG0DEgTS/aM73ecZizp4wCPDmZUXgKiB9PT68PTAsRrjfvlmGxAlkJ63mN+cGjomY/3+2t1tQFRANrvP07O4dyP+UoXxPUA0QH7oHg66P4J1mkly2KwDEg7i5k+epvsN3KOESUy2AQkHaZ24CromjfWDxFnMdAAJBnHtj5P4iZMDcyvN6/+1Z4AEgzj34/ulOVPHXTP4yXSJjAESDuLcbqPR/VJa62XaTJ4BogByajYYsF3JHiD6IPMBqdQagGiDhL0heH8BEF2QucAV0fuAqIJsB6+HXgVEEyR8HdugLYUASQLyVCGdx4DogUxp5PMAEC2QPZV8pgDRAlHawbIDiA5IRymhHUB0QA60MhoFRANkQy2ju4BogOhtq3QPEA2QJ3oprQMSDqK5Q8kEIOEgmruJjgMSDrKvmdMuIMEgqi8sLwESCrKhmtNrQEJBOqo57QASCqK7Q/g4IKEgyl9WVAckEGRTN6kNQAJBDnSTagMSCDKlm9QDQAABBJAMQXZ0k5oDJBBE+Vs/GNRDQZ7rJtUCJBDkSDWnGjP1UJAl1ZwmAQkF0f1enHlAQkG2VXM6AiT4AdVLzZzWAQkGUb3dWwckGERzR90pFjmEgywopnQIiMJCuXm9lNqAKIDofTX9IktJNUDqTa2MfgRE5XUErW8uqLUAUQHRWt37mhd2lF5p01no0P8LZgBJANJWyec5L32qvRatMYoM2DkAkCQgLYUV12tsHKC4tcaz4GyesNeJ6m5AodP1gTtmAZIMpBW4HdDAfRcBSbiB2YOgXObZUU59i7+Q9xJeLgCiDuIOU2cyHuP8gCQGST0bae46QLIASSkyHmv7d0BSgKRaNTcZ7+SApAFxq4k3J51qOUCyA3GN+8mS2Ip7YkDSgbiFJMvhm+sOkIxBnNuLPWmfWHCAZA/i6luxRpLFRN+jC0h6EOdad2cG/fbZ9WSnBOTko/K6SxqtN/1G99r+cdITAuLcx7HgiUsTxyvN6F+8s9pKfjZATtwuXHYpo702/6r70pi9u76d6lSAfLoVcuSCorG8unq4srK6unrcTn8WQN5F52Dm4sGcsxCAGAtAAAEEkBKFH36Qp2XyaFUAZKlMIMcVAHlcJpCtCoDUWuXxqI9XACT+07riY81XAaQ2VxaP3WYlQHyzJJ98FyZ9NUD8vVJcI7t5exQH4mtbC+bH87WLvjogb//Zmlg3PENsd7buFdCUIkEIQAAhAAGEAAQQAhBACEAIQAAhAAGEAAQQAhBACEAIQAAhAAGEAAQQYqhBbn9+xWRPzl04V0mQ21evGP1bWqSI4GFLRPCwJVIUyJ2rtsfWwkQED1sigoctEcHDlkgRIHdulGOOVohIASDflMSjGBHBw5ZI7iDTJfIoQkTwsCWSM8j0Je8RsQNSPo/cRXIF+ayEHnmLCB62RAQPWyKChy0RwcOWSF4gX5XaI0cRwcOWSD4gN7/1HhE7IMPgkZdIHiA3b3mPiB2QYfHIR0TwsCWSOcitIfLIQ0TwsCWSMcitm94jYgdk+DwyF8kU5Nsh9MhaRPCwJZIhyKWvvEfEDsjwemQqkhnIpc+8R8QOyHB7ZCgieNgSETxsiQgetkSyALk07T0idkCq4pGNiOBhS0Qd5EaFPLIQETxsiSiD3PjGe0TsgFTPQ11EFeTGHe8RsQNytZIeyiKChy0RwcOWiBbIlau3vUfEDEjFPRRFBA9bIiogVz6vvIeaiOBhS0Q0PP6GhpqI4GFLRMI9fomEoojgYUtE8LAlEgZy5fd4KIsIHrZEQkCu46EvInjYEkkPcp3xPAsR4fqwJZIW5Pqf8chERNJ6/IGuZyIieNgSSQVy/Ts8shIRPGyJpAC5fv5XdDszEcHDlkhikC/wyFRE8LAlkhDki+/wyFZEuD5siQgetkSSgFw+/xv6m7WI4GFLRPCwJSJ42BIRPGyJCB62RCSmx+/oaT4igoctEcHDlojgYUtE8LAlIoM9/kEncxQRPGyJyCCPv9DFXEX6g1z+Go+cRQQPWyL9QC5f+wX9y1tE8LAlcjbIl3gUISJ42BI5C+TLr/EoRES4PmyJRIM8wqMoEcHDlkgUyCPGj+JEhOvDlojgYUvkFMijC3+nUwWKCB62RHpA5MJv6VKhIoKHLZEuELmGR9EiwvVhS0TwsCUiJzx+TW+KFxE8bInIx/EcDxMiwvVhS0TwsCUiP/0BDysigoctEXn3P3+kG2ZExJ+7hochEeH6sCUieJgSmf6/AAMAF4/8wMtS1yoAAAAASUVORK5CYII="}})});return Promise.all(i).then(function(t){var o=_.template($("#item_template").html());$(".grid").html(o({notebooks:t})).imagesLoaded(function(){new e(".grid",{itemSelector:".grid-item",transitionDuration:0}),$(".body").hasClass("loaded")||$("body").addClass("loaded"),$("body").scrollTop(0).removeClass("loading")})})})},init:function(){return new Promise(function(n,r){require(["imagesloaded.pkgd.min","masonry.pkgd.min"],function(r,i){"use strict";e=i,(new t).init({change:function(e){o.load_current_metric(e)},oncomplete:function(e){n(o.load_current_metric(e))}})},r)})}};return o}(),RCloud.UI.notebook_tree_search_service=function(){var e=function(){"use strict"};return e.prototype={get_results:function(e){return new Promise(function(t){return rcloud.search_description(e.notebook).then(function(e){t(_.map(e.response.docs,function(e){return{id:e.id,author:e.user,name:e.description,star_count:e.starcount,updated_at:e.updated_at}}))})})}},e}(),RCloud.UI.incremental_search=function(){var e,t,o,n,r,i=!1,s=void 0,l=new RCloud.UI.notebook_tree_search_service;return{init:function(){e=_.template($("#tree-finder-template").html()),t=_.template($("#tree-finder-result-template").html()),n=(o="#tree-finder-dialog")+" input",(r=o+" .results")+"> p",l=new RCloud.UI.notebook_tree_search_service,rcloud.search&&RCloud.UI.shortcut_manager.add([{category:"Incremental Search",id:"incremental_search",description:"Show incremental search",keys:{win_mac:[["alt","s"]]},action:function(){i||s.modal({keyboard:!0}),i=!0}}]),$("body").append(e({})),s=$(o),$(s).on("shown.bs.modal",function(){$($(n)[0]).focus()}),$(s).on("hidden.bs.modal",function(){$(o).modal("hide"),$(n).val(""),$(r).html(""),i=!1}),$(n).on("keyup",function(){var e=[];$(n).map(function(t){e.push($(this).val())}),_.any(e,function(e){return e.length})?l.get_results({notebook:e[0],username:e[1]}).then(function(e){$(r).html(t({notebooks:e}))}):$(r).html("")}),$(r).on("click","p",function(){var e=$(this).data("id");rcloud.config.get_current_notebook().then(function(t){t.notebook!==e&&editor.load_notebook(e),$(o).modal("hide")})})}}}(),RCloud.UI.date_filter=function(e){this.$el_=$(e+" select"),this.on_change=new RCloud.UI.event(this);var t=this;this.$el_.on("change",function(){t.on_change.notify({prop:"tree-filter-date",value:$(this).val()})}),this.val=function(e){this.$el_.val(e)}},RCloud.UI.notebook_tree_model=function(e,t,o){var n=function(e,t,o){"use strict";this.order={HEADER:0,NOTEBOOK:1,MYFOLDER:2,SUBFOLDER:4},this.orderType={DEFAULT:0,DATE_DESC:1},this.username_=e,this.show_terse_dates_=t,this.show_folder_dates_=o,this.path_tips_=!1,this.tree_data_=[],this.histories_={},this.notebook_info_={},this.num_stars_={},this.fork_count_={},this.my_stars_={},this.my_friends_={},this.featured_=[],this.invalid_notebooks_={},this.current_=null,this.gist_sources_=null,this.lazy_load_={},this.sorted_by_=this.orderType.DEFAULT,this.matches_filter_=[],this.empty_folders_=[],this.folder_last_commits={},this.tree_filters_={tree_filter_date:function(){return!0}},this.CONFIG_VERSION=1,this.on_initialise_tree=new RCloud.UI.event(this),this.on_load_by_user=new RCloud.UI.event(this),this.on_open_and_select=new RCloud.UI.event(this),this.on_load_children=new RCloud.UI.event(this),this.on_add_node_before=new RCloud.UI.event(this),this.on_append_node=new RCloud.UI.event(this),this.on_update_node=new RCloud.UI.event(this),this.on_remove_node=new RCloud.UI.event(this),this.on_fake_hover=new RCloud.UI.event(this),this.on_select_node=new RCloud.UI.event(this),this.on_load_data=new RCloud.UI.event(this),this.on_show_history=new RCloud.UI.event(this),this.on_open_node=new RCloud.UI.event(this),this.remove_history_nodes=new RCloud.UI.event(this),this.on_update_sort_order=new RCloud.UI.event(this),this.on_update_show_nodes=new RCloud.UI.event(this),this.on_settings_complete=new RCloud.UI.event(this)};return n.prototype={username:function(){return this.username_},show_terse_dates:function(e){if(!arguments.length)return this.show_terse_dates_;this.show_terse_dates_=e},path_tips:function(){return this.path_tips_},set_current:function(e){this.current_=e},get_current:function(){return this.current_},get_current_notebook_histories:function(){return this.histories_[this.current_.notebook]},get_current_notebook_history_index:function(){var e=this;return null===this.current_.version?0:this.find_index(this.get_current_notebook_histories(),function(t){return t.version===e.current_.version})},get_history_by_index:function(e){return this.histories_[this.current_.notebook][e]},get_previous:function(){var e=null===this.current_.version?0:this.get_current_notebook_history_index.call(this);return e===this.get_current_notebook_histories().length-1?void 0:this.get_history_by_index(e+1).version},get_next:function(){var e=this.get_current_notebook_history_index();return 0===e?void 0:e-1==0?null:this.get_history_by_index(e-1).version},get_gist_sources:function(){return this.gist_sources_},each_r_list:function(e,t){for(var o in e)"r_attributes"!==o&&"r_type"!==o&&t(o)},r_vector:function(e){return _.isArray(e)?e:[e]},someone_elses:function(e){return e+"'s Notebooks"},get_notebook_star_count:function(e){return this.num_stars_[e]||0},set_notebook_star_count:function(e,t){this.num_stars_[e]=t},notebook_star_count_exists:function(e){return _.has(this.num_stars_,e)},is_notebook_starred_by_current_user:function(e){return this.my_stars_[e]||!1},has_notebook_info:function(e){return this.notebook_info_[e]},get_notebook_info:function(e){return this.notebook_info_[e]||{}},set_notebook_info:function(e,t){this.notebook_info_[e]=t},set_visibility:function(e,t){var o=this.notebook_info_[e]||{};return o.visible=t,this.notebook_info_[e]=o,rcloud.set_notebook_visibility(e,t)},add_interest:function(e,t){this.my_stars_[t]||(this.my_stars_[t]=!0,this.my_friends_[e]=(this.my_friends_[e]||0)+1)},remove_interest:function(e,t){this.my_stars_[t]&&(delete this.my_stars_[t],0==--this.my_friends_[e]&&delete this.my_friends_[e])},get_my_star_count_by_friend:function(e){return this.my_friends_[e]},user_is_friend:function(e){return this.my_friends_[e]},get_notebooks_by_user:function(e){var t=this,o=_.pick(t.notebook_info_,_.filter(Object.keys(t.notebook_info_),function(o){return t.notebook_info_[o].username===e&&!t.notebook_info_[o].recent_only}));return rcloud.config.all_user_notebooks(e).then(t.get_infos_and_counts).then(function(e){return _.extend(t.notebook_info_,e.notebooks),_.extend(t.num_stars_,e.num_stars),_.extend(e.notebooks,o),e.notebooks})},remove_notebook_view:function(e,t){var o=this;function n(e){var t=o.get_node_by_id(e);t?o.remove_node(t):console.log("tried to remove node that doesn't exist: "+e)}this.my_friends_[e]&&n(this.node_id("friends",e,t)),n(this.node_id("alls",e,t))},populate_users:function(e){var t=this;return _.isString(e)&&(e=[e]),e.forEach(function(e){t.lazy_load_[e]=!0}),{label:"All Notebooks",id:"/alls",children:_.map(e,function(e){return t.lazy_node("alls",e)}).sort(this.compare_nodes.bind(this))}},populate_friends:function(e){var t=this;return{label:"People I Starred",id:"/friends",children:e.filter(function(e){return t.my_friends_[e]>0}).map(function(e){return t.lazy_node("friends",e)}).sort(this.compare_nodes.bind(this))}},get_folder_last_commit_date:function(e){return this.folder_last_commits[e]},get_most_recent_child:function(e){var t=this,o=null,n=[],r=function(e){return{id:e.id,last_commit:e.last_commit}},i=function(e){e&&e.children&&(!function(e){_.findWhere(n,{parent_id:e.id})||n.push({parent_id:e.id,children:_.map(e.children,function(e){return r(e)})}),_.each(e.children,function(t){var o=_.filter(n,function(t){return e.id!=t.parent_id&&-1!=_.pluck(t.children,"id").indexOf(e.id)});_.each(o,function(e){e.children.push(r(t))})})}(e),_.each(e.children,function(e){e.last_commit>o&&(o=e.last_commit),i(e)}))};return i(e),_.each(n,function(e){t.folder_last_commits[e.parent_id]=_.max(_.pluck(e.children,"last_commit"))}),o},is_date_sorted:function(){return this.sorted_by_===this.orderType.DATE_DESC},compare_nodes:function(e,t){var o=e.sort_order-t.sort_order,n=this;if(o)return o;var r=e.name||e.label,i=t.name||t.label;if(this.sorted_by_===this.orderType.DEFAULT||e.sort_order!==this.order.NOTEBOOK||t.sort_order!==this.order.NOTEBOOK){var s=RCloud.utils.split_number(r),l=RCloud.utils.split_number(i);if(s&&l&&s[0]==l[0])return+s[1]-+l[1];var a=r.localeCompare(i);if(0===a){if(e.children){if(t.children)throw new Error("uh oh, parallel folders");return-1}if(t.children)return 1;a=e.gistname.localeCompare(t.gistname)}return a}var c=function(e){return e.last_commit||e.children?e.last_commit?new Date(e.last_commit):n.get_most_recent_child(e):1/0};return c(t)-c(e)},lazy_node:function(e,t){var o=t===this.username_,n=this.node_id(e,t);return{label:o?"My Notebooks":this.someone_elses(t),id:n,sort_order:o?this.order.MYFOLDER:this.order.SUBFOLDER,children:[{label:"loading..."}],user:t,root:e}},populate_interests:function(e){var t=this;var o,n,r=(o=Object.keys(e),n={},_.each(o,function(e){var o=t.notebook_info_[e];return o?o.username&&"undefined"!==o.username&&o.description&&o.last_commit?((n[o.username]=n[o.username]||{})[e]=o,n):(t.invalid_notebooks_[e]=o,n):(t.invalid_notebooks_[e]=null,n)}),n),i=[];for(var s in r){var l=r[s];for(var a in l)this.add_interest(s,a),l[a].description||(l[a].description="(no description)");var c=this.convert_notebook_set("interests",s,l),u=this.node_id("interests",s),d=s===this.username_,f={label:d?"My Notebooks":this.someone_elses(s),id:u,sort_order:d?this.order.MYFOLDER:this.order.SUBFOLDER,children:this.as_folder_hierarchy(c,u).sort(this.compare_nodes.bind(this))};i.push(f)}return{label:"Notebooks I Starred",id:"/interests",children:i.sort(this.compare_nodes.bind(this))}},as_folder_hierarchy:function(e,t,o){var n=this;function r(e){return e.label.match(/([^/]+)\/(.+)/)}var i=e;if(_.some(i,function(e){return void 0===e.label||null===e.label}))throw new Error("incomplete notebook entry (has it been shown yet?)");i=_.filter(i,r),i=_.map(i,function(e){var t=e.label.match(/([^/]+)\/(.+)/),o=_.clone(e);return o.folder_name=t[1],o.label=t[2],o}),i=_.groupBy(i,function(e){return e.folder_name}),i=_.map(i,function(e,r){var i=_.map(e,function(e){return _.omit(e,"folder_name")}),s=t+"/"+r,l=(o?o+"/":"")+r;return{label:r,full_name:l,user:e[0].user,sort_order:n.order.NOTEBOOK,id:s,children:n.as_folder_hierarchy(i,s,l)}});var s=_.filter(e,function(e){return!r(e)});return s.forEach(function(e){e.full_name=(o?o+"/":"")+e.label}),s.concat(i).sort(this.compare_nodes.bind(this))},convert_notebook_set:function(e,t,o){var n=[];for(var r in o){var i=o[r],s={label:i.description,gistname:r,user:t,root:e,visible:i.visible,source:i.source,last_commit:i.last_commit?new Date(i.last_commit):"none",id:this.node_id(e,t,r),sort_order:this.order.NOTEBOOK,fork_desc:i.fork_desc};n.push(s)}return n},node_id:function(e,t,o,n){for(var r="",i=0;i<arguments.length;++i)r=r+"/"+arguments[i];return r},load_user_notebooks:function(e){var t=this,o=function(e){t.matches_filter_=_.union(t.matches_filter_,e.matching_notebooks),t.empty_folders_=_.union(t.empty_folders_,e.empty_folders)};return t.lazy_load_[e]?t.get_notebooks_by_user(e).then(function(n){var r,i=t.node_id("alls",e),s=t.get_node_by_id(i),l=t.convert_notebook_set("alls",e,n),a=t.as_folder_hierarchy(l,i).sort(t.compare_nodes.bind(t));if(o(t.get_filter_matches([{children:a}])),delete t.lazy_load_[e],t.load_tree_data(a,i),t.my_friends_[e]){var c=t.duplicate_tree_data(s,t.transpose_notebook("friends"));o(t.get_filter_matches([{children:c}])),t.load_tree_data(c.children,t.node_id("friends",e)),r=c.children}t.on_load_by_user.notify({pid:t.node_id("alls",e),data:a,duplicate_data:r,duplicate_parent_id:t.node_id("friends",e)})}):Promise.resolve()},add_notebook_info:function(e,t,o){this.notebook_info_[t]||(this.notebook_info_[t]={}),_.extend(this.notebook_info_[t],o);var n=rcloud.set_notebook_info(t,o);return e===this.username()&&(n=n.then(function(){rcloud.config.add_notebook(t)})),n},tag_notebook_version:function(e,t,o){for(var n=this.histories_[e],r=0;r<n.length;++r)n[r].version===t&&(n[r].tag=o),n[r].tag===o&&n[r].version!=t&&(n[r].tag=void 0)},update_notebook:function(e,t,o,n){var r=this;return r.load_user_notebooks(e).then(function(){var i=r.notebook_info_[t]||{};return i.username=e,i.description=o,i.last_commit=n,r.add_notebook_info(e,t,i),i})},update_notebook_from_gist:function(e,t,o){var n=e.user.login,r=e.id,i=this;return t&&(i.histories_[r]=t),i.update_notebook(n,r,e.description,e.updated_at||e.history[0].committed_at).then(function(e){return i.update_notebook_view(n,r,e,o)})},skip_user_level:function(e){return"featured"===e&&1===this.featured_.length},update_tree_node:function(e,t){_.extend(e,t),this.on_update_node.notify({node:e,data:t})},set_node_open_status:function(e,t){this.get_node_by_id(e.id).is_open=t},remove_node:function(e){var t=this.get_parent(e.id);if(this.on_fake_hover.notify({node:e}),t.children=_.without(t.children,_.findWhere(t.children,{id:e.id})),this.remove_node_notify({node:e}),this.remove_empty_parents(t),"interests"===e.root&&e.user!==this.username_&&0===t.children.length){var o=this.get_node_by_id("/interests");o.children=_.without(o.children,_.findWhere(o.children,{id:t.id})),this.remove_node_notify({node:t})}},remove_node_notify:function(e){this.matches_filter_=_.without(this.matches_filter_,e.node.id),this.on_remove_node.notify(e)},unstar_notebook_view:function(e,t,o){var n=this.node_id("interests",e,t),r=this.get_node_by_id(n);if(r)return this.remove_node(r),this.update_notebook_view(e,t,this.get_notebook_info(t),o);console.log("attempt to unstar notebook we didn't know was starred",n)},update_notebook_view:function(e,t,o,n){var r=this;function i(o){if(r.current_.version){var n=r.skip_user_level(o.root)?r.node_id(o.root,t,r.current_.version):r.node_id(o.root,e,t,r.current_.version),i=r.get_node_by_id(n);if(!i)throw new Error("tree node was not created for current history");o=i}r.on_select_node.notify({node:o})}var s,l=r.my_stars_[t]||!1,a=[];if(!0===n&&(n=r.featured_.indexOf(e)>=0?"featured":l?"interests":r.my_friends_[e]?"friends":"alls"),l&&(s=r.update_tree_entry("interests",e,t,o,!0),"interests"===n&&(s=s.then(i)),a.push(s)),t===r.current_.notebook){var c=RCloud.UI.navbar.control("star_notebook");c&&(c.set_fill(l),c.set_count(r.num_stars_[t]))}return r.my_friends_[e]&&(s=r.update_tree_entry("friends",e,t,o,!0),"friends"===n&&(s=s.then(i)),a.push(s)),r.featured_.indexOf(e)>=0&&(s=r.update_tree_entry("featured",e,t,o,!0),"featured"===n&&(s=s.then(i)),a.push(s)),s=r.update_tree_entry("alls",e,t,o,!0),"alls"===n&&(s=s.then(i)),a.push(s),Promise.all(a)},find_sort_point:function(e,t){if(t.children)for(var o=0;o<t.children.length;++o){var n=t.children[o];if(this.compare_nodes.call(this,e,n)<0)return{child:n,position:o}}},insert_in_order:function(e,t){e.gistname&&1==RCloud.utils.filter(e,_.values(this.tree_filters_)).length&&this.matches_filter_.push(e.id),"string"==typeof t&&(t=this.get_node_by_id(t));var o=this.find_sort_point(e,t);return o?(t.children.splice(o.position,0,e),this.on_add_node_before.notify({node_to_insert:e,existing_node:o.child}),e):(t.children||(t.children=[]),t.children.push(e),this.on_append_node.notify({node_to_insert:e,parent_id:t.id}),e)},traverse:function(){!function e(t){for(var o in t)t[o]&&"object"==typeof t[o]&&(console.log("traverse output: ",t[o]),e(t[o]))}(this.tree_data_)},get_filter_matches:function(e){var t=[],o=this,n=[],r=[],i=function(e,t){_.each(e,function(e){e.matches_filter=t})},s=function(e){for(var l in e)if(e[l]&&"object"==typeof e[l]){if(e[l].hasOwnProperty("children"))if(r=_.filter(e[l].children,function(e){return e.gistname&&!e.version}),i(r,!1),(r=RCloud.utils.filter(r,_.values(o.tree_filters_)))&&r.length){if(t.push.apply(t,r),i(r,!0),!e[l].gistname){var a=[];_.each(n,function(t){e[l].id.startsWith(t.id)&&a.push(t)}),n=_.difference(n,a)}}else e[l].gistname||n.push(e[l]);s(e[l])}};return s(e),{matching_notebooks:_.pluck(t,"id"),empty_folders:_.pluck(n,"id")}},sanitize_tree_setting:function(e,t){var o=_.findWhere([{key:"tree-filter-date",default_value:"all",valid_values:["all","last7","last30","last3months","last6months","lastyear","last2years"]},{key:"tree-sort-order",default_value:"name",valid_values:["name","date_desc"]}],{key:e});return o?(null==t&&(t=""),o.valid_values.indexOf(t.toLocaleLowerCase())>=0?t.toLocaleLowerCase():o.default_value):(console.warn('Unknown setting_key "',e,'"'),t)},update_filter:function(e){if("tree-filter-date"==e.prop){var t;switch(e.value){case null:case"all":break;case"last7":t=d3.time.day.offset(new Date,-7);break;case"last30":t=d3.time.month.offset(new Date,-1);break;case"last3months":t=d3.time.month.offset(new Date,-3);break;case"last6months":t=d3.time.month.offset(new Date,-6);break;case"lastyear":t=d3.time.year.offset(new Date,-1);break;case"last2years":t=d3.time.year.offset(new Date,-2);break;default:console.warn("Unknown value for date filter type passed to notebook_tree_model.update_filter(...)")}var o=this;this.tree_filters_[e.prop]=t?function(e){return e.gistname==o.current_.notebook||e.last_commit>t}:function(){return!0}}var n=this.get_filter_matches(this.tree_data_);this.matches_filter_=n.matching_notebooks,this.empty_folders_=n.empty_folders,this.on_update_show_nodes.notify({nodes:this.matches_filter_,empty_folders:this.empty_folders_,filter_props:e}),rcloud.config.set_user_option(e.prop,e.value)},does_notebook_match_filter:function(e){return-1!=this.matches_filter_.indexOf(e)},does_folder_have_matching_descendants:function(e){return-1==this.empty_folders_.indexOf(e)},update_sort_type:function(e,t){var o,n=this;if(o="date_desc"==e.toLocaleLowerCase()?this.orderType.DATE_DESC:this.orderType.DEFAULT,this.sorted_by_!=o){if(this.sorted_by_=o,t){var r=[],i=function(e){for(var t in e)e[t]&&"object"==typeof e[t]&&(e[t].hasOwnProperty("children")&&(e[t].children.length&&!e[t].children[0].version&&e[t].children.sort(n.compare_nodes.bind(n)),r.push({node_id:e[t].id,children:e[t].children})),i(e[t]))};i(this.tree_data_),this.on_update_sort_order.notify({tree_data:this.tree_data_,sort_type:e})}rcloud.config.set_user_option("tree-sort-order",e)}},get_node_by_id:function(e){var t;return function o(n){for(var r in n)if(n[r]&&"object"==typeof n[r]){if(n[r].id===e){t=n[r];break}o(n[r])}}(this.tree_data_),t},get_parent:function(e){function t(t){return _.find(t.children,function(t){return t.id===e})}return function e(o,n){var r=null;if(o instanceof Array)for(var i=0;i<o.length&&!(r=e(o[i],n));i++);else for(var s in o){if("id"===s&&o.hasOwnProperty("children")&&t(o))return o;if((o[s]instanceof Object||o[s]instanceof Array)&&(r=e(o[s],n)))break}return r}(this.tree_data_,e)},load_tree_data:function(e,t){var o=this.get_node_by_id(t);o&&(o.children=e)},duplicate_tree_data:function(e,t){console.assert(!e.user||!this.lazy_load_[e.user]);var o=t(e);if(e.children){for(var n=[],r=0;r<e.children.length;++r)n.push(this.duplicate_tree_data(e.children[r],t));o.children=n}return o},transpose_notebook:function(e,t){var o="/alls/";return t&&(o+=t+"/"),function(t){var n=_.pick(t,"label","name","full_name","gistname","user","visible","source","last_commit","sort_order","version");return n.id=t.id.replace(o,"/"+e+"/"),n.root=e,n}},update_tree:function(e,t,o,n,r,i){var s=this;if(!e)throw new Error("need root");if(!t)throw new Error("need user");if(!o)throw new Error("need gistname");var l=this.skip_user_level(e),a=l?this.node_id(e):this.node_id(e,t),c=this.get_node_by_id(a),u=null,d=null;if(!c){var f=t===this.username_;if(!(c=this.get_node_by_id(this.node_id(e))))throw new Error("root '"+e+"' of notebook tree not found!");l||(u={label:f?"My Notebooks":this.someone_elses(t),id:this.node_id(e,t),sort_order:f?this.order.MYFOLDER:this.order.SUBFOLDER},c=this.insert_in_order(u,c))}for(c.delay_children&&(delete c.delay_children,this.on_load_children.notify({node:c}));"children"in n;)(d=this.get_node_by_id(n.id))||(u=_.omit(n,"children"),d=this.insert_in_order(u,c)),c=d,n=n.children[0];var h=n,p=l?s.node_id(e,o):s.node_id(e,t,o);if(!(d=s.get_node_by_id(p))&&!i)return null;h.gistname=o,h.id=p,h.root=e,h.user=t;var m=function(e,t,o){e.children=_.without(e.children,_.findWhere(e.children,{id:t.id})),s.remove_node_notify({node:t}),o?t=s.insert_in_order(o,e):s.insert_in_order(t,e)};if(d){d.children,r&&r(d);var g=this.get_parent(d.id);if(g===c&&d.label===h.label&&this.sorted_by_!==this.orderType.DATE_DESC)this.update_tree_node(d,h);else if(g.children=_.without(g.children,_.findWhere(g.children,{id:d.id})),this.remove_node_notify({node:d}),d=this.insert_in_order(h,c),this.remove_empty_parents(g),this.sorted_by_===this.orderType.DATE_DESC){var v=d;do{c=this.get_parent(v.id),-1==[s.order.NOTEBOOK,s.order.MYFOLDER].indexOf(c.sort_order)?c=null:m(c,v,v.id===h.id?h:void 0),v=c}while(c)}}else if(d=s.insert_in_order(h,c),this.sorted_by_===this.orderType.DATE_DESC){v=d;do{c=this.get_parent(v.id),-1==[s.order.NOTEBOOK,s.order.MYFOLDER].indexOf(c.sort_order)?c=null:(m(c,v,v.id===h.id?h:void 0),d.id===v.id&&(d=v)),v=c}while(c)}return d},remove_empty_parents:function(e){if(e)for(;!e.children.length&&e.sort_order===this.order.NOTEBOOK;){var t=this.get_parent(e.id);t.children=_.without(t.children,_.findWhere(t.children,{id:e.id})),this.remove_node_notify({node:e,fake_hover:!1}),e=t}},update_tree_entry:function(e,t,o,n,r){var i={user:t,label:n.description,last_commit:new Date(n.last_commit),sort_order:this.order.NOTEBOOK,source:n.source,visible:n.visible},s="hide",l=null,a=this.as_folder_hierarchy([i],this.skip_user_level(e)?this.node_id(e):this.node_id(e,t))[0],c=this.update_tree(e,t,o,a,function(e){e.children&&e.children.length&&(s="index",l=e.children.length,e.children[l-1].id.startsWith("showmore")&&--l)},r);return c?(o===this.current_.notebook&&this.current_.version&&(s="sha",l=this.current_.version),this.update_history_nodes(c,s,l)):Promise.resolve(null)},toggle_folder_friendness:function(e){var t;if(this.my_friends_[e]){var o,n=this.get_node_by_id(this.node_id("alls",e));if(n)o=this.duplicate_tree_data(n,this.transpose_notebook("friends"));else{var r=e===this.username_;o={label:r?"My Notebooks":this.someone_elses(e),id:this.node_id("friends",e),sort_order:r?this.order.MYFOLDER:this.order.SUBFOLDER}}t=this.get_node_by_id(this.node_id("friends"));var i=this.insert_in_order(o,t);this.on_load_data.notify({children:o.children,node:i})}else{var s=this.get_node_by_id(this.node_id("friends",e));(t=this.get_parent(s.id)).children=_.without(t.children,_.findWhere(t.children,{id:s.id})),this.remove_node_notify({node:s})}},find_index:function(e,t){for(var o=0;o<e.length;o++)if(t(e[o],o,e))return o;return-1},find_next_copy_name:function(e,t){var o=this;return this.load_user_notebooks(e).then(function(){var n=-1===t.indexOf("/")?o.node_id("alls",e):o.node_id("alls",e,t.replace(/\/[^\/]*$/,"")),r=o.get_node_by_id(n);if(void 0===r)return t;var i,s,l,a,c=_.object(_.map(r.children,function(e){return[e.full_name,!0]}));if(!c[t])return t;(i=RCloud.utils.split_number(t))?(s=i[0],l=+i[1]):(s=t+" ",l=1);do{a=s+ ++l}while(c[a]);return a})},update_history_nodes:function(e,t,o){var n=!1,r=null,i=this;function s(){var t=e.children.length;return r?t-1:t}var l,a=function(e,t){var n=i.find_index(e,function(e){return e.version===t});if(n<0)throw new Error("didn't find sha "+o+" in history");return n+5-1};function c(t){function o(e){var t=c[e];return(e+1<c.length?function(e,t){var o=(e=new Date(e))-(t=new Date(t)),n=e.getMinutes()===t.getMinutes(),r=e.getHours()===t.getHours(),i=e.toLocaleDateString()===t.toLocaleDateString();return o<=6e4&&r&&n&&this.show_terse_dates_?null:RCloud.utils.format_date_time_stamp(e,o,i,!0,this.show_terse_dates_)}.call(this,t.committed_at,c[e+1].committed_at):new Date(t.committed_at))||"none"}function l(t,r,i){var s=c[r],l={};_.extend(l,e),delete l.children;var a=s.version.substring(0,10);return l.committed_at=new Date(s.committed_at),l.last_commit=i?l.committed_at:o.call(this,r),l.label=s.tag?s.tag:a,l.version=s.version,l.id=e.id+"/"+l.version,function(e,t){n&&(e.color=t)}(l,t),l}function a(e,t){var o=c[t],n=o.version.substring(0,10),r={label:o.tag?o.tag:n};this.on_update_node.notify({node:e,data:r})}var c=i.histories_[e.gistname].slice(1);if(c){if(t=Math.min(t,c.length),n)for(var u=0,d=s();u<d;++u)this.on_update_node.notify({node:e.children[v],data:{color:""}});r&&this.on_update_node.notify({node:e.children[e.children.length-2],data:{last_commit:o(e.children.length-2)}});var f,h,p=null,m=0===e.children.length;if(m)f=t,p=function(t){e.children||(e.children=[]),e.children.push(t),this.on_append_node.notify({node_to_insert:t,parent_id:e.id})};else{var g=e.children[0];f=i.find_index(c,function(e){return e.version==g.version}),p=function(t){e.children.splice(f-1,0,t),this.on_add_node_before.notify({node_to_insert:t,existing_node:g})}}for(var v=0;v<f;++v)h=l.call(this,"green",v,m&&v==f-1),p.call(i,h);var b=s();for(v=f;v<b;++v)a.call(i,e.children[v],v);if(b<t)for(p=r?function(t){e.children.splice(e.children.length-1,0,t),this.on_add_node_before.notify({node_to_insert:t,existing_node:r})}:function(t){e.children||(e.children=[]),e.children.push(t),this.on_append_node.notify({node_to_insert:t,parent_id:e.id})},v=b;v<t;++v)h=l("mediumpurple",v,v==t-1),p.call(i,h);else b>t&&(e.children=e.children.splice(0,t),this.remove_history_nodes.notify({node:e,from_index:t}),r=null);if(r){if(t===c.length){var y=this.get_parent(r.id);y.children=_.without(y.children,_.findWhere(y.children,{id:r.id})),this.remove_node_notify({node:r}),r=null}}else if(t<c.length){var k={label:"...",id:"showmore-"+e.id};e.children.push(k),this.on_append_node.notify({node_to_insert:k,parent_id:e.id})}}}if(e.children||(e.children=[]),e.children&&e.children.length&&e.children[e.children.length-1].id.startsWith("showmore")&&(r=e.children[e.children.length-1]),"hide"===t)return e.children=[],this.remove_history_nodes.notify({node:e}),Promise.resolve(e);if("index"===t)l=Math.max(o,5);else if("same"===t)l=s();else if("more"===t)l=s()+5;else{if("sha"!==t)throw new Error("update_history_nodes don't understand how to seek '"+t+"'");i.histories_[e.gistname]&&(l=a(i.histories_[e.gistname],o))}return i.histories_[e.gistname]?(c.call(i,l),Promise.resolve(e)):rcloud.load_notebook(e.gistname,null).then(function(n){return i.histories_[e.gistname]=n.history,"sha"===t&&(l=a(i.histories_[e.gistname],o)),c.call(i,l),e}.bind(i))},get_infos_and_counts:function(e){return Promise.all([rcloud.stars.get_multiple_notebook_star_counts(e),rcloud.get_multiple_notebook_infos(e)]).spread(function(e,t){return{notebooks:RCloud.utils.clean_r(t),num_stars:RCloud.utils.clean_r(e)}})},get_starred_info:function(){return rcloud.stars.get_my_starred_notebooks().then(this.get_infos_and_counts)},get_recent_info:function(){var e=this;return rcloud.config.get_recent_notebooks().then(function(t){return e.get_infos_and_counts(Object.keys(t))})},get_featured:function(){var e=this;return rcloud.config.get_alluser_option("featured_users").then(function(t){return e.featured_=t||[],_.isString(e.featured_)&&(e.featured_=[e.featured_]),e.featured_.length?e.get_notebooks_by_user(e.featured_[0]).then(function(t){var o=e.convert_notebook_set("featured",e.featured_[0],t).map(function(e){return e.id="/featured/"+e.gistname,e});return{label:"RCloud Sample Notebooks",id:"/featured",children:e.as_folder_hierarchy(o,e.node_id("featured")).sort(e.compare_nodes.bind(e))}}):null})},update_history:function(e,t){var o=this;_.isBoolean(t)&&(t={toggle:t});var n=t.update?"same":"more",r=o.get_node_by_id(e.id);if(r.children&&r.children.length){if(!e.is_open)return o.on_open_node.notify({node:r}),Promise.resolve(void 0);t.toggle&&(n="hide")}return o.update_history_nodes(r,n,null).then(function(e){var t=0;o.histories_[e.gistname]&&(t=o.histories_[e.gistname].length),o.on_show_history.notify({node:e,history_len:t}),e.is_open=!0})},load_everything:function(){var e,t=this;return Promise.all([rcloud.get_users(),t.get_starred_info(),t.get_recent_info(),rcloud.get_gist_sources(),rcloud.config.get_user_option(["notebook-path-tips","tree-sort-order","tree-filter-date"])]).spread(function(o,n,r,i,s){for(var l in e=s,t.path_tips_=s["notebook-path-tips"],t.gist_sources_=i,_.extend(t.notebook_info_,n.notebooks),r.notebooks)t.notebook_info_[l]||(t.notebook_info_[l]=r.notebooks[l],t.notebook_info_[l].recent_only=!0);var a;return _.extend(t.num_stars_,r.num_stars),o=_.union(o,_.compact(_.pluck(n.notebooks,"username"))),Promise.all([rcloud.config.get_current_notebook(),t.get_featured()]).spread(function(e,o){t.current_=e,t.num_stars_=n.num_stars,a=o}).then(function(){var e=t.populate_users(o);return[a,t.populate_interests(n.notebooks),t.populate_friends(o),e].filter(function(e){return!!e})})}).then(function(o){this.tree_data_=o,_.each(["tree-sort-order","tree-filter-date"],function(o){e[o]=t.sanitize_tree_setting(o,e[o])}),this.update_filter({prop:"tree-filter-date",value:e["tree-filter-date"]}),this.update_sort_type("name",!0),this.on_initialise_tree.notify({data:o}),this.on_settings_complete.notify(e)}.bind(t)).then(function(){for(var e in this.invalid_notebooks_){var t=this.invalid_notebooks_[e];t?console.log("notebook metadata for "+e+" has invalid entries: "+JSON.stringify(_.pick(t,"username","description","last_commit","visible","source"))):console.log("notebook metadata for "+e+" is missing.")}}.bind(t)).catch(rclient.post_rejection)}},n}(),RCloud.UI.notebook_tree_view=function(e){var t=function(e){"use strict";this.model_=e,this.$tree_=null,this.tree_controls_root_selector="#tree-controls",this.$sort_order_select_=$("#tree_sort_order"),this.date_filter_=new RCloud.UI.date_filter("#tree-filter-by"),this.on_notebook_open=new RCloud.UI.event(this);var t=this,o=function(e){e&&e.children&&_.each(e.children,function(n){t.$tree_.tree("appendNode",n,t.$tree_.tree("getNodeById",e.id)),o(n)})};this.date_filter_.on_change.attach(function(e,o){t.model_.update_filter(o)}),this.model_.on_settings_complete.attach(function(e,o){$(t.tree_controls_root_selector).find("[data-settingkey]").each(function(){var e=$(this).data("settingkey"),t=o[e];null!=t&&$(this).val(t)})}),this.model_.on_initialise_tree.attach(function(e,o){var n=window.performance?window.performance.now():0;t.$tree_=$("#editor-book-tree"),t.$sort_order_select_.on("change",t.change_sort_order.bind(t)),t.$tree_.tree({data:o.data,onCreateLi:t.on_create_tree_li.bind(t),selectable:!0,useContextMenu:!1,keyboardSupport:!1}),t.$tree_.bind("tree.click",t.tree_click.bind(t)),t.$tree_.bind("tree.open",t.tree_open.bind(t)),t.$tree_.bind("tree.close",t.tree_close.bind(t)),n&&console.log("load tree took "+(window.performance.now()-n));var r=t.$tree_.tree("getNodeById","/interests");t.$tree_.tree("openNode",r)}),this.model_.on_update_sort_order.attach(function(e,o){if(t.$tree_){var n=t.$tree_.tree("getState");t.$tree_.tree("loadData",o.tree_data),t.$tree_.tree("setState",n)}t.$sort_order_select_.val(o.sort_type)}),this.model_.on_update_show_nodes.attach(function(e,o){t.$tree_&&t.$tree_.tree("getTree").iterate(function(e){return e.gistname?_.find(o.nodes,function(t){return e.id.startsWith(t)})?$(e.element).show():$(e.element).hide():1===e.sort_order&&(-1!=o.empty_folders.indexOf(e.id)?$(e.element).hide():$(e.element).show()),!0}),"tree-filter-date"==o.filter_props.prop&&t.date_filter_.val(o.filter_props.value)}),this.model_.on_load_by_user.attach(function(e,o){var n=t.$tree_.tree("getNodeById",o.pid);t.$tree_.tree("loadData",o.data,n),o.duplicate_data&&t.$tree_.tree("loadData",o.duplicate_data,t.$tree_.tree("getNodeById",o.duplicate_parent_id))}),this.model_.on_open_and_select.attach(function(e,o){var n=o.node;if(o.isHistorical){if(t.$tree_.tree("openNode",t.$tree_.tree("getNodeById",o.node.id)),!(n=t.$tree_.tree("getNodeById",o.id)))throw new Error("tree node was not created for current history")}else n=t.$tree_.tree("getNodeById",o.id);t.select_node(n)}),this.model_.on_select_node.attach(function(e,o){var n=t.$tree_.tree("getNodeById",o.node.id);t.$tree_.tree("selectNode",n),t.scroll_into_view(n).then(function(){n.user===e.username_?RCloud.UI.notebook_title.make_editable(n,n.element,!0):RCloud.UI.notebook_title.make_editable(null)})}),this.model_.on_load_children.attach(function(e,o){console.warn("redundant code?"),t.$tree_.tree("loadData",o.node.delay_children,o.node)}),this.model_.on_add_node_before.attach(function(e,n){t.$tree_.tree("addNodeBefore",n.node_to_insert,t.$tree_.tree("getNodeById",n.existing_node.id)),o(n.node_to_insert)}),this.model_.on_append_node.attach(function(e,n){t.$tree_.tree("appendNode",n.node_to_insert,t.$tree_.tree("getNodeById",n.parent_id)),o(n.node_to_insert)}),this.model_.on_load_data.attach(function(e,o){t.$tree_.tree("loadData",o.children,t.$tree_.tree("getNodeById",o.node.id))}),this.model_.on_update_node.attach(function(e,o){t.$tree_.tree("updateNode",t.$tree_.tree("getNodeById",o.node.id),o.data)}),this.model_.on_remove_node.attach(function(e,o){var n=t.$tree_.tree("getNodeById",o.node.id);o.fake_hover&&ui_utils.fake_hover(n),t.$tree_.tree("removeNode",n)}),this.model_.on_fake_hover.attach(function(e,o){ui_utils.fake_hover(t.$tree_.tree("getNodeById",o.node.id))}),this.model_.on_open_node.attach(function(e,o){t.$tree_.tree("openNode",t.$tree_.tree("getNodeById",o.node.id))}),this.model_.on_show_history.attach(function(e,o){1===o.history_len&&$(".history i",$(t.$tree_.tree("getNodeById",o.node.id).element)).addClass("button-disabled"),t.$tree_.tree("openNode",t.$tree_.tree("getNodeById",o.node.id))}),this.model_.remove_history_nodes.attach(function(e,o){var n,r=t.$tree_.tree("getNodeById",o.node.id);if(r.children)if(o.from_index)for(n=r.children.length-1;n>=o.from_index;--n)t.$tree_.tree("removeNode",r.children[n]);else for(n=r.children.length-1;n>=0;n--)t.$tree_.tree("removeNode",r.children[n])})};return t.prototype={change_sort_order:function(e){var t=$(e.target).val();this.model_.update_sort_type(t,!0),this.scroll_into_view(this.$tree_.tree("getSelectedNode"))},tree_click:function(e){return e.node.id.startsWith("showmore")?this.model_.update_history(e.node.parent,!1):e.node.gistname?e.click_event.metaKey||e.click_event.ctrlKey?this.on_notebook_open.notify({gistname:e.node.gistname,version:e.node.version,source:e.node.source,selroot:!0,new_window:!0}):e.node.gistname===this.model_.get_current().notebook&&e.node.version==this.model_.get_current().version&&null==e.node.version?this.select_node(e.node):this.on_notebook_open.notify({gistname:e.node.gistname,version:e.node.version||null,source:e.node.source,selroot:e.node.root,new_window:!1}):(e.node.is_open||(this.$tree_.tree("openNode",e.node),ui_utils.fake_hover(e.node)),this.model_.set_node_open_status(e.node,e.node.is_open)),!1},select_node:function(e){var t=this;t.scroll_into_view(e).then(function(){t.$tree_.tree("selectNode",e),e.user===t.model_.username_?RCloud.UI.notebook_title.make_editable(e,e.element,!0):RCloud.UI.notebook_title.make_editable(null)})},scroll_into_view:function(e){var t=this;return new Promise(function(o){for(var n=e.parent;n;)t.$tree_.tree("openNode",n),n=n.parent;ui_utils.scroll_into_view(t.$tree_,50,100,function(){o()},$(e.element))})},remove_node:function(e){var t=e.parent;ui_utils.fake_hover(e),$tree_.tree("removeNode",e),this.remove_empty_parents(t),"interests"===e.root&&e.user!==this.model_.username_&&0===t.children.length&&$tree_.tree("removeNode",t)},remove_empty_parents:function(e){for(;0===e.children.length&&e.sort_order===this.model_.order.NOTEBOOK;){var t=e.parent;$tree_.tree("removeNode",e),e=t}},reselect_node:function(e){var t=$tree_.tree("getSelectedNode");return e().then(function(){var e=$tree_.tree("getNodeById",t.id);e?this.select_node(e):console.log("sorry, neglected to highlight "+t.id)})},tree_open:function(e){var t=e.node;t.full_name&&t.user===this.model_.username()&&!t.gistname&&RCloud.UI.notebook_title.make_editable(t,t.element,!0),$("#collapse-notebook-tree").trigger("size-changed"),t.user&&this.model_.lazy_load_[t.user]&&this.model_.load_user_notebooks(t.user)},tree_close:function(e){var t=e.node;t.full_name&&!t.gistname&&RCloud.UI.notebook_title.make_editable(t,t.element,!1)},display_date:function(e){return $(this.display_date_html(e))[0]},display_date_html:function(e){if("none"===e)return"";if("string"==typeof e)return e;var t=new Date(e),o=new Date-t;return RCloud.utils.format_date_time_stamp(t,o,!0,!1,this.model_.show_terse_dates())},highlight_node:function(e){var t=this;return function(){return new Promise(function(o){for(var n=e.parent;n.sort_order===t.model_.order.NOTEBOOK;)t.$tree_.tree("openNode",n),n=n.parent;ui_utils.scroll_into_view(t.$tree_,150,150,function(){$(e.element).closest(".jqtree_common").effect("highlight",{color:"#fd0"},1500,function(){o()})},$(e.element))})}},highlight_notebooks:function(e){var t=this;_.map(_.isArray(e)?e:[e],function(e){return t.$tree_.tree("getNodeById","/"+["interests",t.model_.username_,e.id].join("/"))}).map(function(e){return t.highlight_node(e)}).reduce(function(e,t){return e.then(t)},Promise.resolve()).then(function(){})},on_create_tree_li:function(e,t){var o,n,r,i=t.find(".jqtree-element"),s=i.find(".jqtree-title");if(s.css("color",e.color),this.model_.path_tips()&&i.attr("title",e.id),e.gistname&&(e.source?s.addClass("foreign-notebook"):e.visible||s.addClass("hidden-notebook")),(e.version||"showmore"===e.id)&&s.addClass("history"),e.last_commit)o=e.last_commit;else if(this.model_.show_folder_dates_&&this.model_.is_date_sorted()){var l=this.model_.get_folder_last_commit_date(e.id);l&&(o=l,r=!0)}o&&(n=$.el.span({class:r?"notebook-date folder":"notebook-date"},this.display_date(o)));var a,c=$.el.span({class:"notebook-right"},n);(e.user===this.model_.username_&&(this.$tree_.tree("isNodeSelected",e)||!e.gistname&&e.full_name&&e.is_open)&&RCloud.UI.notebook_title.make_editable(e,t,!0),RCloud.UI.notebook_commands.decorate(t,e,c),i.append(c),e.gistname||!e.gistname&&1==e.sort_order)&&(a=e.gistname?this.model_.does_notebook_match_filter(e.id):!!e.version||this.model_.does_folder_have_matching_descendants(e.id),e.version?i.show():i.parent()[a?"show":"hide"]())}},t}(),RCloud.UI.notebook_tree_controller=function(e,t){var o=function(e,t){"use strict";this.model_=e,this.view_=t,this.show_terse_dates_=!1,this.on_notebook_open=new RCloud.UI.event(this);var o=this;this.view_.on_notebook_open.attach(function(e,t){o.on_notebook_open.notify(t)})};return o.prototype={get_tree_data:function(){return this.model_.tree_data_},set_current:function(e){this.model_.set_current(e)},get_current:function(){return this.model_.get_current()},get_previous:function(){return this.model_.get_previous()},get_next:function(){return this.model_.get_next()},get_gist_sources:function(){return this.model_.get_gist_sources()},get_notebook_star_count:function(e){return this.model_.get_notebook_star_count(e)},set_notebook_star_count:function(e,t){this.model_.set_notebook_star_count(e,t)},notebook_star_count_exists:function(e){return this.model_.notebook_star_count_exists(e)},is_notebook_starred_by_current_user:function(e){return this.model_.is_notebook_starred_by_current_user(e)},has_notebook_info:function(e){return this.model_.has_notebook_info(e)},get_notebook_info:function(e){return this.model_.get_notebook_info(e)},set_notebook_info:function(e,t){this.model_.set_notebook_info(e,t)},add_interest:function(e,t){this.model_.add_interest(e,t)},get_my_star_count_by_friend:function(e){return this.model_.get_my_star_count_by_friend(e)},user_is_friend:function(e){return this.model_.user_is_friend(e)},remove_interest:function(e,t){this.model_.remove_interest(e,t)},show_terse_dates:function(e){this.model_.show_terse_dates(e)},set_visibility:function(e,t){return this.model_.set_visibility(e,t)},load_everything:function(){return this.model_.load_everything()},highlight_notebooks:function(e){this.view_.highlight_notebooks(e)},select_history_node:function(e){this.select_node(e),$(e.element).find(".jqtree-element:eq(0)").trigger("click")},update_notebook_view:function(e,t,o,n){return this.model_.update_notebook_view(e,t,o,n)},unstar_notebook_view:function(e,t,o){this.model_.unstar_notebook_view(e,t,o)},update_notebook_from_gist:function(e,t,o){return this.model_.update_notebook_from_gist(e,t,o)},tag_notebook_version:function(e,t,o){this.model_.tag_notebook_version(e,t,o)},toggle_folder_friendness:function(e){this.model_.toggle_folder_friendness(e)},show_history:function(e,t){this.model_.update_history(e,t)},find_next_copy_name:function(e,t){return this.model_.find_next_copy_name(e,t)},remove_notebook_view:function(e,t){this.model_.remove_notebook_view(e,t)},traverse:function(){this.model_.traverse()},update_sort_type:function(e){this.model_.update_sort_type(e)}},o}();
//# sourceMappingURL=rcloud_bundle.min.js.map